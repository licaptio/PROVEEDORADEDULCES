<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pagos a Proveedores ‚Äì √öltimos 20</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:Poppins,Arial,sans-serif;
  background:#eef1f5;
  padding:25px;
}
h2{margin-bottom:15px}
.card{
  background:#fff;
  padding:18px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  border-bottom:1px solid #ddd;
  text-align:left;
  font-size:14px;
}
th{background:#f3f4f6}
.total{
  font-weight:700;
  font-size:18px;
  margin-top:12px;
}
.id{
  font-family:monospace;
  font-size:12px;
  color:#555;
}
td:last-child, th:last-child{
  text-align:right;
  font-variant-numeric: tabular-nums;
}
.loading{
  text-align:center;
  padding:20px;
  color:#666;
}
</style>
</head>

<body>

<h2>üè¶ √öltimos 20 Pagos Capturados</h2>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>ID PAGO</th>
        <th>Fecha Pago</th>
        <th>Banco</th>
        <th>Proveedor</th>
        <th>Importe</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="5" class="loading">Cargando...</td></tr>
    </tbody>
  </table>

  <div class="total">
    Total listado: <span id="total">$0.00</span>
  </div>
</div>

<script>

const sb = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);
  
const formatoMXN = new Intl.NumberFormat('es-MX', {
  style: 'currency',
  currency: 'MXN',
  minimumFractionDigits: 2
});

const formatoFecha = new Intl.DateTimeFormat('es-MX', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit'
});

async function cargarUltimos(){

  const { data, error } = await sb
    .from('pagos_proveedor')
    .select('id,fecha_pago,banco,proveedor_nombre,importe_pagado,creado_en')
    .order('creado_en', { ascending: false })
    .limit(20);

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  if(error){
    tbody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`;
    return;
  }

  if(!data || data.length === 0){
    tbody.innerHTML = `<tr><td colspan="5">Sin registros</td></tr>`;
    return;
  }

  let total = 0;

  data.forEach(p=>{

    const importe = Number(p.importe_pagado || 0);
    total += importe;

    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td class="id">
        <a href="CARDEX.html?id=${p.id}" target="_blank">
          ${p.id}
        </a>
      </td>
      <td>${p.fecha_pago ? formatoFecha.format(new Date(p.fecha_pago)) : '-'}</td>
      <td>${p.banco || '-'}</td>
      <td>${p.proveedor_nombre || '-'}</td>
      <td>${formatoMXN.format(importe)}</td>
    `;

    tbody.appendChild(tr);
  });

  document.getElementById('total').innerText = formatoMXN.format(total);
}

window.addEventListener('DOMContentLoaded', cargarUltimos);

</script>

</body>
</html>
