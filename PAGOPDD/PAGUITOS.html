<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>MIS PAGUITOS PROVEEDORA DE DULCES</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{
    font-family:Poppins,Arial,sans-serif;
    background:#eef1f5;
    padding:25px;
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:14px;
    flex-wrap:wrap;
  }
  h2{margin:0}

  .brand{
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
  }
  .brand img{
    height:64px;
    max-width:100%;
    object-fit:contain;
  }
  .brand .t1{
    font-weight:900;
    letter-spacing:.5px;
    font-size:22px;
    line-height:1.05;
  }
  .brand .t2{
    font-size:13px;
    color:#b91c1c;
    font-weight:700;
    letter-spacing:.3px;
  }

  .card{
    background:#fff;
    padding:18px;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.15);
    margin-bottom:18px;
  }

  table{width:100%;border-collapse:collapse;}
  th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left;font-size:14px;}
  th{background:#f3f4f6;position:sticky;top:0;z-index:1;}
  td:last-child,th:last-child{text-align:right;font-variant-numeric:tabular-nums;}

  .id{font-family:monospace;font-size:12px;color:#555;}
  .total{font-weight:900;font-size:20px;}

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:#dcfce7;
    padding:8px 10px;
    border-radius:999px;
    font-size:13px;
    color:#111;
    border:1px solid rgba(0,0,0,.06);
  }

  .btn{
    padding:9px 12px;
    border-radius:8px;
    border:1px solid #ccc;
    background:#fff;
    cursor:pointer;
  }
  .btn-primary{
    background:#111827;
    color:#fff;
    border-color:#111827;
  }
  .btn-primary:disabled{opacity:.6;cursor:not-allowed;}
  .hidden{display:none !important;}
  .muted{color:#666;font-size:13px}

  .table-wrap{
    max-height:65vh;
    overflow:auto;
    border:1px solid #eee;
    border-radius:12px;
  }

  /* Login modal backdrop con fondo (foto 1) */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:
      linear-gradient(rgba(255,255,255,.88), rgba(255,255,255,.88)),
      url('images.png') center/cover no-repeat;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }

  .modal{
    width:min(520px, 100%);
    background:#fff;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    overflow:hidden;
    border:1px solid rgba(0,0,0,.06);
  }

  .modal header{
    padding:16px 18px;
    border-bottom:1px solid #eee;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    background:linear-gradient(#fff, #fafafa);
  }
  .modal header h3{margin:0;font-size:16px;}
  .modal .content{padding:18px;}

  .login-logo{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:12px;
  }
  .login-logo img{
    height:48px;
    object-fit:contain;
  }
  .login-logo .name{
    font-weight:900;
    letter-spacing:.2px;
    font-size:16px;
    line-height:1.1;
  }
  .login-logo .sub{
    font-size:12px;
    color:#b91c1c;
    font-weight:800;
  }

  .modal .content label{
    display:block;
    font-size:13px;
    color:#333;
    margin-bottom:6px;
  }
  .modal .content input{
    width:100%;
    box-sizing:border-box;
    margin-bottom:12px;
    padding:9px 10px;
    border-radius:8px;
    border:1px solid #ccc;
  }

  .modal .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    padding:14px 18px;
    border-top:1px solid #eee;
    background:#fafafa;
  }

  .status{margin-top:8px;font-size:13px;color:#b91c1c;}

  .loader{
    display:inline-block;
    width:14px;height:14px;
    border:2px solid #ddd;
    border-top-color:#111827;
    border-radius:50%;
    animation:spin .8s linear infinite;
    vertical-align:middle;
    margin-left:8px;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <!-- FOTO 2: logo grande en el cuerpo -->
    <img src="logo.png" alt="PROVEEDORA">
    <div>
      <div class="t1">MIS PAGUITOS</div>
      <div class="t2">PROVEEDORA DE DULCES</div>
    </div>
  </div>

  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <span id="sessionPill" class="pill hidden"></span>
    <button id="btnLogout" class="btn hidden" onclick="logout()">Cerrar sesión</button>
  </div>
</div>

<div id="tableCard" class="card hidden">
  <div class="table-wrap" id="tableWrap">
    <table>
      <thead>
        <tr>
          <th>ID PAGO</th>
          <th>Fecha</th>
          <th>Banco</th>
          <th>Proveedor</th>
          <th>Importe</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-top:12px;">
    <div class="total">Total cargado: <span id="total">$0.00</span></div>
    <div class="muted" id="countInfo"></div>
  </div>

  <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:10px;align-items:center;flex-wrap:wrap;">
    <span class="muted" id="loadHint"></span>
    <button id="btnMore" class="btn btn-primary" onclick="cargarMas()">Cargar más</button>
  </div>
</div>

<!-- Modal Login -->
<div id="loginBackdrop" class="modal-backdrop">
  <div class="modal">
    <header>
      <h3>Iniciar sesión</h3>
      <span class="muted">Proveedor</span>
    </header>

    <div class="content">
<div style="margin-bottom:18px">
  <div style="
      font-weight:900;
      font-size:22px;
      letter-spacing:.5px;
      line-height:1.1;
      color:#111827;">
    MIS PAGUITOS
  </div>
  <div style="
      font-size:13px;
      font-weight:800;
      color:#b91c1c;
      letter-spacing:.4px;">
    PROVEEDORA DE DULCES
  </div>
</div>


      <label>Email</label>
      <input id="email" type="email" placeholder="correo@proveedor.com" autocomplete="username" />

      <label>Contraseña</label>
      <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password" />

      <div class="muted" style="margin-top:6px">
        Cierre automático tras 5 minutos sin actividad.
      </div>

      <div id="loginStatus" class="status"></div>
    </div>

    <div class="actions">
      <button class="btn" onclick="demoFillTauro()">Demo Tauro</button>
      <button id="btnLogin" class="btn btn-primary" onclick="login()">Entrar</button>
    </div>
  </div>
</div>

<script>
  // 0) Asegura que el SDK cargó
  if(!window.supabase){
    alert("No cargó supabase-js (CDN bloqueado o sin Internet).");
    throw new Error("supabase-js no disponible");
  }

  // 1) Cliente único
  const sb = window.supabase.createClient(
    'https://cvpbtjlupswbyxenugpz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
  );
  // debug opcional
  window.sb = sb;

  const formatoMXN = new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN',
    minimumFractionDigits: 2
  });

  const loginBackdrop = document.getElementById('loginBackdrop');
  const tableCard = document.getElementById('tableCard');
  const sessionPill = document.getElementById('sessionPill');
  const btnLogout = document.getElementById('btnLogout');
  const loginStatus = document.getElementById('loginStatus');
  const btnLogin = document.getElementById('btnLogin');
  const tbody = document.getElementById('tbody');
  const tableWrap = document.getElementById('tableWrap');
  const btnMore = document.getElementById('btnMore');

  // Paginación
  const PAGE_SIZE = 40;
  let offset = 0;
  let totalCargado = 0;
  let totalCount = null;
  let isLoading = false;
  let didInitialLoad = false;

  // 2) Auto-logout por inactividad (5 min)
  const IDLE_MS = 5 * 60 * 1000;
  let idleTimer = null;

  function startIdleTimer(){
    stopIdleTimer();
    idleTimer = setTimeout(async () => {
      try{
        alert("Sesión cerrada por inactividad.");
        await sb.auth.signOut();
      } catch(e){
        console.error(e);
      }
    }, IDLE_MS);
  }

  function stopIdleTimer(){
    if(idleTimer) clearTimeout(idleTimer);
    idleTimer = null;
  }

  function bumpIdle(){
    // solo cuenta cuando está logueado
    if(!btnLogout.classList.contains('hidden')){
      startIdleTimer();
    }
  }

  ['mousemove','mousedown','keydown','touchstart','scroll'].forEach(evt=>{
    window.addEventListener(evt, bumpIdle, { passive:true });
  });

  function setLoginLoading(v){
    btnLogin.disabled = v;
    btnLogin.innerHTML = v ? `Entrando <span class="loader"></span>` : 'Entrar';
  }

  function setLoggedInUI(email){
    loginBackdrop.classList.add('hidden');
    tableCard.classList.remove('hidden');

    sessionPill.textContent = `Sesión: ${email}`;
    sessionPill.classList.remove('hidden');
    btnLogout.classList.remove('hidden');

    startIdleTimer();
  }

  function setLoggedOutUI(){
    stopIdleTimer();

    loginBackdrop.classList.remove('hidden');
    tableCard.classList.add('hidden');

    sessionPill.classList.add('hidden');
    btnLogout.classList.add('hidden');

    tbody.innerHTML = '';
    offset = 0;
    totalCargado = 0;
    totalCount = null;
    didInitialLoad = false;

    document.getElementById('total').innerText = formatoMXN.format(0);
    document.getElementById('countInfo').innerText = '';
    document.getElementById('loadHint').innerText = '';
    btnMore.disabled = false;
    btnMore.textContent = 'Cargar más';
  }

  function resetListado(){
    tbody.innerHTML = '';
    offset = 0;
    totalCargado = 0;
    totalCount = null;
    isLoading = false;

    document.getElementById('total').innerText = formatoMXN.format(0);
    document.getElementById('countInfo').innerText = '';
    document.getElementById('loadHint').innerText = '';
    btnMore.disabled = false;
    btnMore.textContent = 'Cargar más';
  }

  async function login(){
    loginStatus.textContent = '';
    setLoginLoading(true);

    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value;

    try{
      const { error } = await sb.auth.signInWithPassword({ email, password: pass });
      if(error) throw error;
    } catch(err){
      loginStatus.textContent = err.message || 'Error al iniciar sesión';
      setLoginLoading(false);
    }
  }

  async function logout(){
    await sb.auth.signOut();
  }

  function demoFillTauro(){
    document.getElementById('email').value = 'cobranza@bolsastauro.com';
    document.getElementById('pass').value = 'TauroPDD2026*';
  }

  function setBtnLoading(){
    btnMore.disabled = true;
    btnMore.innerHTML = `Cargando <span class="loader"></span>`;
  }
  function setBtnMore(){
    btnMore.disabled = false;
    btnMore.textContent = 'Cargar más';
  }
  function setBtnEnd(){
    btnMore.disabled = true;
    btnMore.textContent = 'No hay más';
    document.getElementById('loadHint').innerText = 'Llegaste al final.';
  }

  async function cargarMas(){
    if(isLoading) return;
    isLoading = true;
    setBtnLoading();

    try{
      bumpIdle();

      const from = offset;
      const to = offset + PAGE_SIZE - 1;

      const { data, error, count } = await sb
        .from('pagos_proveedor')
        .select('id,fecha_pago,banco,proveedor_nombre,importe_pagado', { count: 'exact' })
        .order('fecha_pago', { ascending: false })
        .range(from, to);

      if(error){
        console.error('Supabase error:', error);
        alert(error.message || 'Error consultando pagos');

        // Si el token expiró, fuerza relogin
        const msg = String(error.message || '').toLowerCase();
        if(msg.includes('jwt') || msg.includes('token') || error.code === 'PGRST301'){
          await sb.auth.signOut();
          location.reload();
        }
        return;
      }

      if(typeof count === 'number') totalCount = count;

      const rows = data || [];

      // Si ya no hay más filas, detener
      if(rows.length === 0){
        setBtnEnd();
        return;
      }

      rows.forEach(p => {
        totalCargado += Number(p.importe_pagado || 0);
        const tr = document.createElement('tr');

        // Sin vínculo por ahora
        tr.innerHTML = `
          <tr>
  <td class="id">
    <a href="CARDEX.html?id=${p.id}" target="_blank" style="color:#2563eb;font-weight:600;text-decoration:none;">
      ${p.id}
    </a>
  </td>
          <td>${p.fecha_pago ?? ''}</td>
          <td>${p.banco ?? ''}</td>
          <td>${p.proveedor_nombre ?? ''}</td>
          <td>${formatoMXN.format(p.importe_pagado || 0)}</td>
        `;

        tbody.appendChild(tr);
      });

      offset += rows.length;
      document.getElementById('total').innerText = formatoMXN.format(totalCargado);

      if(totalCount !== null){
        document.getElementById('countInfo').innerText = `Cargados: ${offset} de ${totalCount}`;
      }

      if(rows.length < PAGE_SIZE || (totalCount !== null && offset >= totalCount)){
        setBtnEnd();
      } else {
        setBtnMore();
        document.getElementById('loadHint').innerText = 'También puedes bajar con scroll y se carga solo.';
      }
    } finally {
      isLoading = false;
      if(!btnMore.disabled && btnMore.textContent !== 'Cargar más'){
        setBtnMore();
      }
    }
  }

  // Auto-load al llegar al fondo del scroll
  tableWrap.addEventListener('scroll', () => {
    bumpIdle();
    const nearBottom = tableWrap.scrollTop + tableWrap.clientHeight >= tableWrap.scrollHeight - 40;
    if(nearBottom && !btnMore.disabled){
      cargarMas();
    }
  });

  // Auth state
  sb.auth.onAuthStateChange(async (event, session) => {
    if(session?.user){
      setLoginLoading(false);
      setLoggedInUI(session.user.email);
      resetListado();

      if(!didInitialLoad){
        didInitialLoad = true;
        await cargarMas();
      }
    } else {
      setLoginLoading(false);
      setLoggedOutUI();
    }
  });

  // Sesión existente
  (async () => {
    const { data } = await sb.auth.getSession();
    if(data?.session?.user){
      setLoggedInUI(data.session.user.email);
      resetListado();
      if(!didInitialLoad){
        didInitialLoad = true;
        await cargarMas();
      }
    } else {
      setLoggedOutUI();
    }
  })();
</script>

</body>
</html>



