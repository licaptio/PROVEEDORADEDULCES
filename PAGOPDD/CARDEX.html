<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Comprobante de Pago ‚Äì Proveedora</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{
  --rojo:#C4161C;
  --verde:#2E7D32;
  --gris:#eef1f5;
  --card:#ffffff;
  --texto:#222;
  --muted:#666;
  --shadow:0 6px 18px rgba(0,0,0,.12);
  --r:14px;
}

body{
  margin:0;
  padding:30px;
  font-family:'Poppins',sans-serif;
  background:var(--gris);
  color:var(--texto);
}

.header{
  background:#fff;
  padding:20px;
  border-radius:var(--r);
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  gap:20px;
  margin-bottom:20px;
}

.header img{ max-height:70px; }
.header .title{ flex:1; }
.header h2{ margin:0; color:var(--rojo); }
.header .sub{ font-size:13px; color:var(--muted); }

.card{
  background:var(--card);
  padding:20px;
  border-radius:var(--r);
  box-shadow:var(--shadow);
  margin-bottom:18px;
}

h3{ margin:0 0 10px; color:var(--verde); }

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}

.label{ font-size:12px; color:var(--muted); }
.value{ font-size:14px; font-weight:600; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
  vertical-align:top;
}
th{
  background:#f9fafb;
  text-align:left;
}

.total{
  font-size:20px;
  font-weight:700;
  color:var(--rojo);
  text-align:right;
}

pre{
  background:#0f172a;
  color:#e5e7eb;
  padding:15px;
  border-radius:10px;
  font-size:12px;
  overflow:auto;
  white-space:pre-wrap;
  word-break:break-word;
}

.footer{
  text-align:center;
  font-size:11px;
  color:#777;
  margin-top:30px;
}

/* Botones */
.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:18px;
}
button{
  border:none;
  border-radius:12px;
  padding:12px 14px;
  font-family:'Poppins',sans-serif;
  font-weight:600;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.btn-primary{ background:var(--rojo); color:#fff; }
.btn-secondary{ background:#111827; color:#fff; }
.smallhint{ font-size:12px; color:var(--muted); margin-top:6px; }

/* Tarjeta especial para imagen */
.share-card{
  background:#ffffff;
  border-radius:16px;
  padding:18px;
  border:1px solid #e5e7eb;
}
.share-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}
.badge{
  background:#dcfce7;
  color:#166534;
  font-weight:700;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
}
.brand{
  font-weight:800;
  color:var(--rojo);
  font-size:14px;
}
.share-title{
  margin:0;
  font-size:16px;
  color:#111827;
}
.mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
}
hr{
  border:none;
  border-top:1px solid #e5e7eb;
  margin:12px 0;
}

/* EXTRA PARA IMAGEN (COMPROBANTE + FACTURAS) */
.twocol{
  display:grid;
  grid-template-columns: 1.15fr 1fr;
  gap:12px;
  margin-top:12px;
}
@media (max-width: 900px){
  .twocol{ grid-template-columns:1fr; }
}

.bankpre{
  background:#0b1220;
  color:#e5e7eb;
  padding:10px 12px;
  border-radius:12px;
  font-size:11px;
  line-height:1.35;
  white-space:pre-wrap;
  word-break:break-word;
  border:1px solid #1118271a;
}

.fact-table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  overflow:hidden;
}
.fact-table th,.fact-table td{
  padding:7px 8px;
  border-bottom:1px solid #e5e7eb;
  vertical-align:top;
}
.fact-table th{
  background:#f9fafb;
  font-size:11px;
  color:#6b7280;
  letter-spacing:.02em;
}
.uuid{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:11px;
}
.mutedline{
  font-size:11px;
  color:#6b7280;
  margin-top:6px;
}

.neg{ color:#b91c1c; font-weight:700; }
.note{ font-size:11px; color:#6b7280; margin-top:4px; }

/* üñ®Ô∏è MODO IMPRESI√ìN */
@media print{
  body{ background:#fff; padding:0; }
  .card, .header{ box-shadow:none; border-radius:0; }
  .actions{ display:none; }
  .footer{ margin-top:15px; }
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <img src="proveedora_logo.jpg" alt="La Proveedora">
  <div class="title">
    <h2>Comprobante de Pago</h2>
    <div class="sub">Documento informativo de pago a proveedor</div>
  </div>
</div>

<!-- Acciones -->
<div class="actions">
  <button class="btn-primary" onclick="generarImagenResumen()">üì∏ Generar imagen (Resumen)</button>
  <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimir</button>
  <div class="smallhint">Tip: si no copia al portapapeles, se descargar√° el PNG.</div>
</div>

<div class="card">
  <div class="label">ID del Pago</div>
  <div class="value" id="pagoId">‚Äî</div>
</div>

<div class="card">
  <h3>Datos Generales</h3>
  <div class="grid">
    <div><div class="label">Proveedor</div><div class="value" id="proveedor"></div></div>
    <div><div class="label">RFC</div><div class="value" id="rfc"></div></div>
    <div><div class="label">Banco</div><div class="value" id="banco"></div></div>
    <div><div class="label">Fecha de Pago</div><div class="value" id="fecha"></div></div>
  </div>
</div>

<div class="card">
  <h3>Facturas Pagadas</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Serie / Folio</th>
        <th>UUID CFDI</th>
        <th style="text-align:right">Importe Original</th>
        <th style="text-align:right">Descuento</th>
        <th style="text-align:right">Importe Final</th>
      </tr>
    </thead>
    <tbody id="facturas"></tbody>
  </table>
</div>

<div class="card">
  <h3>Resumen</h3>
  <div class="grid">
    <div><div class="label">Total Facturas (original)</div><div class="value" id="totalFacturasOriginal"></div></div>
    <div><div class="label">Descuentos por factura</div><div class="value" id="totalDescFacturas"></div></div>
    <div><div class="label">Total Facturas (neto)</div><div class="value" id="totalFacturas"></div></div>
    <div><div class="label">Ajustes</div><div class="value" id="totalAjustes"></div></div>
    <div><div class="label">Importe Pagado</div><div class="value total" id="importe"></div></div>
  </div>
</div>

<!-- TARJETA A IMAGEN -->
<div class="card" id="resumenImagenWrap">
  <h3>Resumen para Proveedor (Imagen)</h3>

  <div id="resumenImagen" class="share-card">
    <div class="share-top">
      <div>
        <div class="brand">LA PROVEEDORA ¬∑ PROVSOFT</div>
        <h4 class="share-title">Confirmaci√≥n de pago</h4>
      </div>
      <div class="badge">PAGO REGISTRADO</div>
    </div>

    <div class="grid">
      <div><div class="label">ID Pago</div><div class="value mono" id="img_pagoId">‚Äî</div></div>
      <div><div class="label">Fecha</div><div class="value" id="img_fecha">‚Äî</div></div>
      <div><div class="label">Proveedor</div><div class="value" id="img_proveedor">‚Äî</div></div>
      <div><div class="label">RFC</div><div class="value mono" id="img_rfc">‚Äî</div></div>
      <div><div class="label">Banco</div><div class="value" id="img_banco">‚Äî</div></div>
      <div><div class="label">Importe Pagado</div><div class="value total" id="img_importe">‚Äî</div></div>
    </div>

    <hr>

    <div class="grid">
      <div><div class="label">Facturas (original)</div><div class="value" id="img_totalFacturasOriginal">‚Äî</div></div>
      <div><div class="label">Descuentos factura</div><div class="value" id="img_totalDescFacturas">‚Äî</div></div>
      <div><div class="label">Facturas (neto)</div><div class="value" id="img_totalFacturas">‚Äî</div></div>
      <div><div class="label">Ajustes</div><div class="value" id="img_totalAjustes">‚Äî</div></div>
      <div><div class="label">Facturas Incluidas</div><div class="value" id="img_numFacturas">‚Äî</div></div>
    </div>

    <div class="twocol">
      <div>
        <div class="label" style="margin-bottom:6px">Comprobante Bancario (extracto)</div>
        <div id="img_comprobante" class="bankpre">‚Äî</div>
        <div id="img_comprobante_extra" class="mutedline"></div>
      </div>

      <div>
        <div class="label" style="margin-bottom:6px">Relaci√≥n de Facturas</div>
        <table class="fact-table">
          <thead>
            <tr>
              <th>Serie/Folio</th>
              <th>UUID</th>
              <th style="text-align:right">Final</th>
            </tr>
          </thead>
          <tbody id="img_facturas"></tbody>
        </table>
        <div id="img_facturas_extra" class="mutedline"></div>
      </div>
    </div>

    <div style="margin-top:10px" class="label">
      Documento informativo. Para detalle completo, revisar el visor del pago.
    </div>
  </div>

  <div class="smallhint">Esto es lo que se convierte a PNG cuando picas ‚ÄúGenerar imagen‚Äù.</div>
</div>

<div class="card">
  <h3>Comprobante Bancario</h3>
  <pre id="comprobante"></pre>
</div>

<div class="card">
  <h3>Notas</h3>
  <div id="notas"></div>
</div>

<div class="footer">
  Documento generado por PROVSOFT ¬∑ Uso informativo
</div>

<script>
const sb = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);

const params = new URLSearchParams(window.location.search);
const pagoId = params.get('id');

function mxn(n){
  return new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN' })
    .format(Number(n || 0));
}

function fechaMx(v){
  if(!v) return '‚Äî';
  const d = new Date(v);
  if (isNaN(d.getTime())) return String(v);
  return d.toLocaleDateString('es-MX', { year:'numeric', month:'2-digit', day:'2-digit' });
}

function shortUuid(u){
  if(!u) return '‚Äî';
  const s = String(u);
  if(s.length <= 16) return s;
  return s.slice(0, 8) + '‚Ä¶' + s.slice(-4);
}

// ‚úÖ Soporta jsonb real O string con JSON adentro (como te regres√≥ en tu ejemplo)
function parseMaybeJson(v, fallback){
  if(Array.isArray(v)) return v;
  if(v && typeof v === 'object') return v;
  if(typeof v === 'string'){
    const s = v.trim();
    if(!s) return fallback;
    try{ return JSON.parse(s); }catch(e){ return fallback; }
  }
  return fallback;
}

function recortarComprobante(raw, maxLineas = 14){
  const lines = (raw || '')
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(Boolean);

  const shown = lines.slice(0, maxLineas).join('\n');
  const extra = lines.length > maxLineas ? `‚Ä¶ y ${lines.length - maxLineas} l√≠neas m√°s` : '';
  return { shown, extra, total: lines.length };
}

// Unifica campos (compatibilidad con pagos viejos y nuevos)
function getImportesFactura(f){
  const orig = Number(
    f.importe_original ?? f.importe ?? f.total ?? 0
  );

  // descuento puede venir como objeto {monto,nota} o no venir
  const desc = Number(
    f?.descuento?.monto ?? 0
  );

  // neto (prioriza importe_final si existe)
  let neto = Number(
    f.importe_final ?? (orig - desc)
  );

  // redondeo suave
  neto = Number(neto.toFixed(2));

  // si viene un pago viejo con f.importe solamente, haz coherente
  const descFinal = Number((orig - neto).toFixed(2)) > 0 ? Number((orig - neto).toFixed(2)) : desc;

  return { orig, desc: descFinal, neto };
}

async function cargarPago(){
  if(!pagoId){
    alert('Falta par√°metro ?id= en la URL');
    return;
  }

  const { data, error } = await sb
    .from('pagos_proveedor')
    .select('*')
    .eq('id', pagoId)
    .single();

  if(error){
    alert(error.message);
    return;
  }

  // ‚úÖ Parse robusto
  const factList = parseMaybeJson(data.facturas_info, []);
  const ajustesList = parseMaybeJson(data.ajustes, []);

  // ‚úÖ Calcula totales desde facturas (para que SIEMPRE salga bien)
  let sumOrig = 0;
  let sumDesc = 0;
  let sumNeto = 0;

  factList.forEach(f=>{
    const { orig, desc, neto } = getImportesFactura(f);
    sumOrig += orig;
    sumDesc += desc;
    sumNeto += neto;
  });

  // Ajustes globales (si tu tabla guarda total_ajustes ya calculado, lo respetamos, pero tambi√©n sumamos por seguridad)
  const sumAj = ajustesList.reduce((s,a)=> s + Number(a?.monto || 0), 0);

  // ===== VISOR NORMAL =====
  document.getElementById('pagoId').innerText = data.id ?? '‚Äî';
  document.getElementById('proveedor').innerText = data.proveedor_nombre ?? '‚Äî';
  document.getElementById('rfc').innerText = data.rfc_emisor ?? '‚Äî';
  document.getElementById('banco').innerText = data.banco ?? '‚Äî';
  document.getElementById('fecha').innerText = fechaMx(data.fecha_pago);

  document.getElementById('totalFacturasOriginal').innerText = mxn(sumOrig);
  document.getElementById('totalDescFacturas').innerText = sumDesc > 0 ? ('-' + mxn(sumDesc)) : mxn(0);
  document.getElementById('totalFacturas').innerText = mxn(sumNeto);

  // Usa total_ajustes si existe; si no, sumAj
  const totalAjustesShown = (data.total_ajustes != null) ? Number(data.total_ajustes) : sumAj;
  document.getElementById('totalAjustes').innerText = mxn(totalAjustesShown);

  document.getElementById('importe').innerText = mxn(data.importe_pagado);
  document.getElementById('comprobante').innerText = data.comprobante_raw || '';
  document.getElementById('notas').innerText = data.notas || '';

  // tabla facturas normal (con descuento)
  const tbody = document.getElementById('facturas');
  tbody.innerHTML = '';

  factList.forEach(f=>{
    const { orig, desc, neto } = getImportesFactura(f);
    const nota = (f?.descuento?.nota || '').trim();

    tbody.innerHTML += `
      <tr>
        <td>${fechaMx(f.fecha)}</td>
        <td>${(f.serie || '')} ${(f.folio || '')}</td>
        <td style="font-family:monospace;font-size:12px">${f.uuid_cfdi || '‚Äî'}</td>
        <td style="text-align:right;font-weight:700">${mxn(orig)}</td>
        <td style="text-align:right" class="${desc>0 ? 'neg' : ''}">
          ${desc>0 ? ('-' + mxn(desc)) : mxn(0)}
          ${nota ? `<div class="note">${nota}</div>` : ''}
        </td>
        <td style="text-align:right;font-weight:800">${mxn(neto)}</td>
      </tr>
    `;
  });

  // ===== DATOS PARA IMAGEN =====
  document.getElementById('img_pagoId').innerText = data.id ?? '‚Äî';
  document.getElementById('img_fecha').innerText = fechaMx(data.fecha_pago);
  document.getElementById('img_proveedor').innerText = data.proveedor_nombre ?? '‚Äî';
  document.getElementById('img_rfc').innerText = data.rfc_emisor ?? '‚Äî';
  document.getElementById('img_banco').innerText = data.banco ?? '‚Äî';
  document.getElementById('img_importe').innerText = mxn(data.importe_pagado);

  document.getElementById('img_totalFacturasOriginal').innerText = mxn(sumOrig);
  document.getElementById('img_totalDescFacturas').innerText = sumDesc > 0 ? ('-' + mxn(sumDesc)) : mxn(0);
  document.getElementById('img_totalFacturas').innerText = mxn(sumNeto);

  document.getElementById('img_totalAjustes').innerText = mxn(totalAjustesShown);
  document.getElementById('img_numFacturas').innerText = factList.length;

  // comprobante en imagen
  const { shown, extra } = recortarComprobante(data.comprobante_raw, 14);
  document.getElementById('img_comprobante').innerText = shown || '‚Äî';
  document.getElementById('img_comprobante_extra').innerText = extra || '';

  // facturas en imagen (muestra neto final + marca descuento si aplica)
  const tbodyImg = document.getElementById('img_facturas');
  tbodyImg.innerHTML = '';

  const MAX_FACT_IMG = 10;
  factList.slice(0, MAX_FACT_IMG).forEach(f => {
    const serie = (f.serie || '').trim();
    const folio = (f.folio || '').trim();
    const sf = `${serie}${serie && folio ? ' ' : ''}${folio}`.trim() || '‚Äî';

    const { desc, neto } = getImportesFactura(f);

    tbodyImg.innerHTML += `
      <tr>
        <td>
          ${sf}
          ${desc>0 ? `<div class="mutedline">Desc: -${mxn(desc)}</div>` : ''}
        </td>
        <td class="uuid">${shortUuid(f.uuid_cfdi)}</td>
        <td style="text-align:right;font-weight:800">${mxn(neto)}</td>
      </tr>
    `;
  });

  document.getElementById('img_facturas_extra').innerText =
    factList.length > MAX_FACT_IMG ? `Mostrando ${MAX_FACT_IMG} de ${factList.length} facturas.` : '';
}

async function generarImagenResumen(){
  const nodo = document.getElementById('resumenImagen');

  if (document.fonts && document.fonts.ready) {
    try { await document.fonts.ready; } catch(e){}
  }

  const canvas = await html2canvas(nodo, {
    backgroundColor: '#ffffff',
    scale: 2,
    useCORS: true
  });

  canvas.toBlob(async (blob) => {
    if(!blob){
      alert('No se pudo generar la imagen.');
      return;
    }

    // intentar copiar
    try{
      if (navigator.clipboard && window.ClipboardItem) {
        const item = new ClipboardItem({ "image/png": blob });
        await navigator.clipboard.write([item]);
        alert('‚úÖ Imagen copiada. P√©gala en WhatsApp/Telegram con Ctrl+V');
        return;
      }
    }catch(err){
      console.warn('Clipboard fall√≥:', err);
    }

    // fallback descargar
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `resumen_pago_${pagoId || 'sin_id'}.png`;
    link.click();
    setTimeout(()=>URL.revokeObjectURL(link.href), 2000);
  }, 'image/png');
}

cargarPago();
</script>

</body>
</html>
