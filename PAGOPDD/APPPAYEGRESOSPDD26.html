<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pago a Proveedores ‚Äì PROVSOFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --orange:#F57C00;
  --orange-dark:#EF6C00;
  --orange-soft:#FFF3E0;
  --bg:#f4f6f9;
  --card:#ffffff;
  --text:#263238;
  --muted:#6b7280;
  --border:#e0e0e0;
  --success:#2e7d32;
}
*{box-sizing:border-box}
body{
  font-family:'Poppins',Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:24px;
}
h2{
  margin:0 0 18px;
  font-weight:700;
  color:var(--orange-dark);
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:18px 20px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  margin-bottom:18px;
  border-top:6px solid var(--orange);
}
h3{
  margin:0 0 12px;
  font-size:16px;
  font-weight:600;
  color:#37474F;
}
input,select,textarea{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  font-family:inherit;
  font-size:14px;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:var(--orange);
  box-shadow:0 0 0 2px rgba(245,124,0,.15);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
thead th{
  text-align:left;
  padding:10px;
  background:var(--orange-soft);
  color:#5d4037;
  font-weight:600;
}
tbody td{
  padding:10px;
  border-bottom:1px solid var(--border);
  vertical-align:top;
}
tbody tr:hover{ background:#fafafa; }

.row{
  display:flex;
  gap:14px;
  align-items:flex-end;
  flex-wrap:wrap;
}

/* Botones */
button{
  border:none;
  border-radius:10px;
  padding:12px 18px;
  font-weight:600;
  font-size:14px;
  cursor:pointer;
}
.btn{ background:var(--orange); color:#fff; }
.btn:hover{ background:var(--orange-dark); }
.btn-outline{
  background:#fff;
  border:1px solid var(--orange);
  color:var(--orange);
}
.btn-outline:hover{ background:var(--orange-soft); }
.btn:disabled{ opacity:.6; cursor:not-allowed; }
.btn-mini{
  padding:8px 10px;
  font-size:12px;
  border-radius:8px;
  white-space:nowrap;
}

/* Texto */
.muted{ color:var(--muted); font-size:12.5px; margin-top:6px; }
.monto{
  font-weight:600;
  font-variant-numeric: tabular-nums;
  letter-spacing:0.3px;
}
.monto-subtotal{ font-weight:700; color:#37474F; }
.monto-negativo{ color:#C62828; }
.monto-total{ font-size:22px; font-weight:800; }

/* Modal */
.modal-overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  z-index:9999;
  padding:18px;
}
.modal{
  max-width:520px;
  margin:8% auto;
  background:#fff;
  border-radius:14px;
  box-shadow:0 18px 50px rgba(0,0,0,.22);
  padding:18px 18px 14px;
  border-top:6px solid var(--orange);
}
.modal h3{ margin-bottom:8px }
.modal .pill{
  display:inline-block;
  background:var(--orange-soft);
  color:#5d4037;
  border:1px solid #ffd7b3;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  margin:6px 0 10px;
}
.modal .grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.modal .actions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  margin-top:12px;
}
hr.soft{ border:none; border-top:1px solid #eee; margin:12px 0; }
.small{
  font-size:12px;
  color:#6b7280;
}
</style>
</head>

<body>

<h2>üí∏ Pago a Proveedores</h2>

<div class="card">
  <label>Proveedor</label><br>
  <select id="proveedorSelect"></select>
  <div class="muted">Selecciona un proveedor para ver sus facturas pendientes.</div>
</div>

<div class="card">
  <h3>Facturas pendientes</h3>
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Fecha</th>
        <th>Folio</th>
        <th>F√≠sica</th>
        <th>Fotos</th>
        <th style="text-align:right">Desc</th>
        <th style="text-align:right">Total</th>
      </tr>
    </thead>
    <tbody id="tbodyFacturas"></tbody>
  </table>
  <div class="muted">Marca las facturas que vas a pagar; el detalle y total se calcula abajo.</div>
</div>

<div class="card">
  <h3>Detalle del c√°lculo</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>UUID</th>
        <th>Proveedor</th>
        <th>Serie / Folio</th>
        <th style="text-align:right">Importe</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbodyCalculo"></tbody>
  </table>

  <div class="muted">
    üí° Aqu√≠ se explica TODO el pago: descuentos por factura (devoluciones) + descuento global (monto directo) y el total final.
  </div>
</div>

<div class="card">
  <h3>Datos del pago</h3>
  <div class="row">
    <div style="min-width:220px">
      Banco<br>
      <select id="banco">
        <option>BBVA</option><option>BANORTE</option><option>BANREGIO</option><option>OTRO</option>
      </select>
    </div>
    <div style="min-width:220px">
      Fecha pago<br>
      <input type="date" id="fechaPago">
    </div>
    <div style="min-width:220px">
      Importe<br>
      <input type="number" id="importePago" step="0.01">
      <div class="small">Se calcula autom√°tico, pero puedes ajustarlo si lo necesitas.</div>
    </div>
  </div>

  <br>
  Comprobante bancario (texto crudo)<br>
  <textarea id="comprobante" rows="6" style="width:100%" placeholder="Pega aqu√≠ el comprobante..."></textarea>
  <div class="muted">Al pegar, se compacta autom√°ticamente (quita saltos in√∫tiles).</div>
  <br>

  Notas (generales del pago)<br>
  <textarea id="notas" rows="4" style="width:100%"></textarea>
</div>

<button id="btnGuardar" class="btn" type="button" onclick="guardarPago()">
  üíæ Registrar pago
</button>

<div id="msg" class="muted" style="margin-top:10px"></div>

<!-- ‚úÖ MODAL DESCUENTO POR FACTURA -->
<div id="modalDescOverlay" class="modal-overlay" onclick="if(event.target.id==='modalDescOverlay') cerrarDesc();">
  <div class="modal" onclick="event.stopPropagation()">
    <h3>üí∏ Ajuste por factura (devoluci√≥n / bonificaci√≥n puntual)</h3>
    <div id="descFacturaPill" class="pill">‚Äî</div>

    <div class="grid">
      <div>
        <label>Importe original</label>
        <input id="descImporteOriginal" type="text" disabled>
      </div>
      <div>
        <label>Monto del ajuste</label>
        <input id="descMonto" type="number" step="0.01" placeholder="0.00">
        <div class="small">Usa n√∫mero POSITIVO (se resta del total de esa factura).</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Nota del ajuste</label>
      <textarea id="descNota" rows="3" placeholder="Ej: Devoluci√≥n de mercanc√≠a / merma / ajuste acordado"></textarea>
    </div>

    <div class="muted" id="descHint"></div>

    <hr class="soft">

    <div class="actions">
      <button class="btn-outline btn-mini" type="button" onclick="quitarDescuentoFactura()">Quitar ajuste</button>
      <button class="btn-outline btn-mini" type="button" onclick="cerrarDesc()">Cancelar</button>
      <button class="btn btn-mini" type="button" onclick="aplicarDescuento()">Aplicar</button>
    </div>
  </div>
</div>

<script>
  const sb = window.supabase.createClient(
    'https://cvpbtjlupswbyxenugpz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
  );

  let facturas = []; // {id, uuid_cfdi, serie, folio, fecha, total, razon_social_emisor, descuento:null|{monto,nota}}
  let facturaDescId = null;

  // ‚úÖ Descuento global SIMPLE: solo monto + nota
  let ajusteGlobal = { monto: 0, nota: '' };

  const proveedorSelect = document.getElementById('proveedorSelect');
  const msg = document.getElementById('msg');
  const btnGuardar = document.getElementById('btnGuardar');

  // Fecha por defecto: hoy
  (function setFechaHoy(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    document.getElementById('fechaPago').value = `${yyyy}-${mm}-${dd}`;
  })();

  function money(n){
    const x = Number(n || 0);
    return new Intl.NumberFormat('es-MX', {
      style: 'currency',
      currency: 'MXN',
      minimumFractionDigits: 2
    }).format(x);
  }
function formatearFechaCorta(fechaISO){
  if(!fechaISO) return '';
  const d = new Date(fechaISO);

  const dia = String(d.getDate()).padStart(2,'0');
  const mes = String(d.getMonth()+1).padStart(2,'0');
  const anio = String(d.getFullYear()).slice(-2);

  return `${dia}/${mes}/${anio}`;
}

function diasTranscurridos(fechaISO){
  if(!fechaISO) return '';
  const hoy = new Date();
  const f = new Date(fechaISO);

  // quitar horas
  hoy.setHours(0,0,0,0);
  f.setHours(0,0,0,0);

  const diff = hoy - f;
  const dias = Math.floor(diff / (1000*60*60*24));

  return dias >= 0 ? `${dias} d√≠as` : '0 d√≠as';
}

  function escapeHtml(str){
    return String(str || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function getFacturaById(id){
    return facturas.find(x => String(x.id) === String(id));
  }

  // ‚úÖ Compactador de comprobante al pegar (quita saltos in√∫tiles)
  function compactarComprobante(raw){
    const lines = String(raw || '')
      .replace(/\r/g, '')
      .split('\n')
      .map(l => l.trim())
      .filter(l => l.length > 0);

    const out = [];
    for(let i=0; i<lines.length; i++){
      const cur = lines[i];
      const next = lines[i+1];
      if (cur.endsWith(':') && next && !next.includes(':')){
        out.push(cur + ' ' + next);
        i++;
      } else {
        out.push(cur);
      }
    }
    return out.join('\n');
  }

  document.getElementById('comprobante').addEventListener('paste', ()=>{
    setTimeout(()=>{
      const ta = document.getElementById('comprobante');
      ta.value = compactarComprobante(ta.value);
    }, 0);
  });

  async function cargarProveedores(){
    const { data, error } = await sb
      .from('deuda_limpia_pdd')
      .select('rfc_emisor, razon_social_emisor')
      .eq('factura_pagada','NO');

    if (error) { alert(error.message); return; }

    const map = new Map();
    (data||[]).forEach(r=>{
      const rfc = r.rfc_emisor;
      const name = (r.razon_social_emisor || r.rfc_emisor || '').trim();
      if(rfc) map.set(rfc, name || rfc);
    });

    const items = [...map.entries()].sort((a,b)=> (a[1]||'').localeCompare(b[1]||'', 'es'));

    proveedorSelect.innerHTML = '<option value="">Seleccione</option>';
    items.forEach(([rfc,name])=>{
      proveedorSelect.innerHTML += `<option value="${rfc}">${escapeHtml(name)}</option>`;
    });

    proveedorSelect.onchange = cargarFacturas;
  }

  async function cargarFacturas(){
    const rfc = proveedorSelect.value;

    document.getElementById('tbodyFacturas').innerHTML = '';
    document.getElementById('tbodyCalculo').innerHTML = '';
    facturas = [];
    recalcularPago();

    if(!rfc) return;

    const { data, error } = await sb
      .from('deuda_limpia_pdd')
      .select('id,uuid_cfdi,serie,folio,fecha,total,razon_social_emisor,fotos,factura_fisicamente,descuentos')
      .eq('rfc_emisor', rfc)
      .eq('factura_pagada','NO')
      .order('fecha',{ascending:true});

    if(error){ alert(error.message); return; }

    facturas = (data || []).map(f => ({ ...f, descuento: null }));

    const tbody = document.getElementById('tbodyFacturas');
    tbody.innerHTML = '';

facturas.forEach(f=>{

  const totalNum = Number(f.total||0);
  const fotos = Array.isArray(f.fotos) ? f.fotos : [];
  const pdfUrl = String(f.descuentos || '').trim(); // ‚Üê AQU√ç
  
  const fotosHtml = fotos.length
    ? `
      <div style="display:flex; gap:6px; flex-wrap:wrap">
        ${fotos.map((url,i)=>`
          <a href="${url}" target="_blank" 
             style="font-size:12px; text-decoration:none; background:#FFF3E0; padding:4px 8px; border-radius:6px; border:1px solid #ffd7b3">
             üìé ${i+1}
          </a>
        `).join('')}
      </div>
      <div class="muted">${fotos.length} archivo(s)</div>
    `
    : `<span class="muted">‚Äî</span>`;
const esFisica = (f.factura_fisicamente || 'NO') === 'SI';

const fisicaHtml = esFisica
  ? `<span style="
        background:#E8F5E9;
        color:#2e7d32;
        padding:4px 8px;
        border-radius:999px;
        font-size:12px;
        font-weight:600;
      ">SI</span>`
  : `<span style="
        background:#FFEBEE;
        color:#C62828;
        padding:4px 8px;
        border-radius:999px;
        font-size:12px;
        font-weight:600;
      ">NO</span>`;

  tbody.innerHTML += `
    <tr>
      <td><input type="checkbox" data-id="${f.id}" onchange="recalcularPago()"></td>
      <td>
        ${formatearFechaCorta(f.fecha)}
        <span class="muted" style="margin-left:6px">
          (${diasTranscurridos(f.fecha)})
        </span>
      </td>
      <td>${escapeHtml((f.serie||'') + ' ' + (f.folio||''))}</td>
const pdfUrl = String(f.descuentos || '').trim();

<td style="text-align:center">
  ${
    pdfUrl.startsWith('http')
      ? `
        <a href="${pdfUrl}"
           target="_blank"
           rel="noopener noreferrer"
           style="
             font-size:12px;
             text-decoration:none;
             background:#E3F2FD;
             padding:4px 8px;
             border-radius:6px;
             border:1px solid #BBDEFB;
             display:inline-block;
             font-weight:600;
           ">
           üìÑ Nota
        </a>
      `
      : `<span class="muted">‚Äî</span>`
  }
</td>
<td style="text-align:right" class="monto">
  ${money(totalNum)}
</td>

    </tr>
  `;
});


    recalcularPago();
  }

  // ‚úÖ FUNCI√ìN √öNICA: calcula y pinta el detalle completo
  function recalcularPago(){
    const seleccionadas = [
      ...document.querySelectorAll('#tbodyFacturas input[type=checkbox]:checked')
    ].map(cb => String(cb.dataset.id));

    // 1) Totales de facturas (original, desc individual, neto)
    let subtotalOriginal = 0;
    let descIndividualTotal = 0;
    let subtotalNeto = 0;

    seleccionadas.forEach(id=>{
      const f = getFacturaById(id);
      if(!f) return;
      const base = Number(f.total||0);
      const desc = Number(f.descuento?.monto || 0);
      subtotalOriginal += base;
      descIndividualTotal += desc;
      subtotalNeto += (base - desc);
    });

    // 2) Ajuste global SIMPLE (monto directo)
    const descGlobal = Number(ajusteGlobal.monto || 0);
    const ajusteGlobalMonto = descGlobal > 0 ? -Math.abs(descGlobal) : 0;

    const totalFinal = subtotalNeto + ajusteGlobalMonto;

    // 3) Pintar tabla del c√°lculo completa
    const tbody = document.getElementById('tbodyCalculo');
    tbody.innerHTML = '';

    // Filas facturas
    seleccionadas.forEach(id=>{
      const f = getFacturaById(id);
      if(!f) return;

      const base = Number(f.total||0);
      const desc = Number(f.descuento?.monto || 0);
      const nota = String(f.descuento?.nota || '').trim();
      const neto = base - desc;

      const descBlock = desc > 0
        ? `<div class="muted monto-negativo" style="text-align:right">Ajuste: -${money(desc)}</div>`
        : `<div class="muted" style="text-align:right">Ajuste: ${money(0)}</div>`;

      const notaBlock = nota
        ? `<div class="muted" style="text-align:right; max-width:320px; margin-left:auto">${escapeHtml(nota)}</div>`
        : '';

      tbody.innerHTML += `
        <tr>
          <td>
  ${formatearFechaCorta(f.fecha)}
  <div class="muted">${diasTranscurridos(f.fecha)}</div>
</td>

          <td style="font-size:12px">${escapeHtml(f.uuid_cfdi || '')}</td>
          <td>${escapeHtml(f.razon_social_emisor || '')}</td>
          <td>${escapeHtml((f.serie || '') + ' ' + (f.folio || ''))}</td>
          <td class="monto" style="text-align:right">
            ${money(neto)}
            ${descBlock}
            ${notaBlock}
            <div class="muted" style="text-align:right">Orig: ${money(base)}</div>
          </td>
          <td>
            <button class="btn-outline btn-mini" type="button"
              onclick="abrirDescuentoFactura('${f.id}')">üí∏ Ajuste</button>
          </td>
        </tr>
      `;
    });

    // Resumen: subtotal original
    tbody.innerHTML += `
      <tr style="background:#f5f5f5">
        <td colspan="4"><b>Subtotal facturas (original)</b></td>
        <td class="monto monto-subtotal" style="text-align:right">${money(subtotalOriginal)}</td>
        <td></td>
      </tr>
    `;

    // Resumen: descuento individual total
    tbody.innerHTML += `
      <tr style="background:#f5f5f5">
        <td colspan="4"><b>Ajustes por factura (total)</b></td>
        <td class="monto ${descIndividualTotal>0?'monto-negativo':''}" style="text-align:right">
          ${descIndividualTotal>0 ? '-' + money(descIndividualTotal) : money(0)}
        </td>
        <td></td>
      </tr>
    `;

    // Resumen: subtotal neto
    tbody.innerHTML += `
      <tr style="background:#f5f5f5">
        <td colspan="4"><b>Total facturas (neto)</b></td>
        <td class="monto monto-subtotal" style="text-align:right">${money(subtotalNeto)}</td>
        <td></td>
      </tr>
    `;

    // ‚úÖ Fila editable: DESCUENTO GLOBAL SIMPLE
    tbody.innerHTML += `
      <tr style="background:#fff">
        <td colspan="4">
          <b>Descuento global (opcional)</b>
          <div class="muted">Solo captura monto y nota. (Monto positivo = descuento).</div>

          <div class="row" style="margin-top:10px">
            <div style="min-width:180px">
<input id="gl_monto" type="number" step="0.01" placeholder="0.00"
  value="${descGlobal ? Number(descGlobal).toFixed(2) : ''}"
  onchange="actualizarGlobal()"
  onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}"
>
            </div>

            <div style="flex:1; min-width:260px">
<input id="gl_nota" placeholder="Nota (opcional)"
  value="${escapeHtml(ajusteGlobal.nota || '')}"
  onchange="actualizarGlobal()"
  onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}"
>
            </div>
          </div>
        </td>

        <td class="monto ${ajusteGlobalMonto<0?'monto-negativo':''}" style="text-align:right">
          ${descGlobal>0 ? money(ajusteGlobalMonto) : money(0)}
          <div class="muted" style="text-align:right">${descGlobal>0 ? 'Aplicado al neto' : 'Sin global'}</div>
        </td>
        <td></td>
      </tr>
    `;

    // Total final
    tbody.innerHTML += `
      <tr style="background:#FFF3E0;font-size:16px">
        <td colspan="4"><b>Total a pagar</b></td>
        <td class="monto monto-total" style="text-align:right">${money(totalFinal)}</td>
        <td></td>
      </tr>
    `;

    // Actualiza importe pago (auto)
    const inp = document.getElementById('importePago');
    if(inp) inp.value = totalFinal.toFixed(2);
  }

  // ‚úÖ lee inputs del global y recalcula
function actualizarGlobal(){
  const val = document.getElementById('gl_monto')?.value ?? '';
  const m = val === '' ? 0 : Number(val);
  const n = document.getElementById('gl_nota')?.value || '';

  ajusteGlobal = {
    monto: (isFinite(m) && m > 0) ? m : 0,
    nota: n
  };

  recalcularPago();
}


  // ‚úÖ Modal ajuste por factura (sin cambios)
  function abrirDescuentoFactura(id){
    const f = getFacturaById(id);
    if(!f) return;

    facturaDescId = String(id);

    const pill = `${(f.serie||'')} ${(f.folio||'')} ‚Ä¢ ${String(f.uuid_cfdi||'').slice(0,8)}‚Ä¶`;
    document.getElementById('descFacturaPill').textContent = pill;

    const base = Number(f.total || 0);
    const descActual = Number(f.descuento?.monto || 0);
    const notaActual = (f.descuento?.nota || '');

    document.getElementById('descImporteOriginal').value = money(base);
    document.getElementById('descMonto').value = descActual ? descActual.toFixed(2) : '';
    document.getElementById('descNota').value = notaActual;

    document.getElementById('descHint').textContent =
      `M√°ximo ajuste: ${money(base)} (si pones 0 se quita).`;

    document.getElementById('modalDescOverlay').style.display = 'block';
    setTimeout(()=> document.getElementById('descMonto').focus(), 80);
  }

  function cerrarDesc(){
    document.getElementById('modalDescOverlay').style.display = 'none';
    facturaDescId = null;
  }

  function quitarDescuentoFactura(){
    if(!facturaDescId) return;
    const f = getFacturaById(facturaDescId);
    if(!f) return;

    f.descuento = null;
    cerrarDesc();
    recalcularPago();
  }

  function aplicarDescuento(){
    if(!facturaDescId) return;

    const f = getFacturaById(facturaDescId);
    if(!f) return;

    const base = Number(f.total || 0);
    const monto = Number(document.getElementById('descMonto').value || 0);
    const nota = document.getElementById('descNota').value;

    if(monto < 0){
      alert('El ajuste por factura debe ser positivo (se resta autom√°ticamente).');
      return;
    }
    if(monto > base){
      alert('El ajuste no puede ser mayor al importe original.');
      return;
    }

    if(monto === 0){
      f.descuento = null;
    }else{
      f.descuento = { monto, nota: String(nota||'') };
    }

    cerrarDesc();
    recalcularPago();
  }

  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      const open = document.getElementById('modalDescOverlay').style.display === 'block';
      if(open) cerrarDesc();
    }
  });

  async function guardarPago(){
    const rfc = proveedorSelect.value;
    if(!rfc){ alert('Seleccione proveedor'); return; }

    const seleccionadas = [
      ...document.querySelectorAll('#tbodyFacturas input[type=checkbox]:checked')
    ].map(cb => String(cb.dataset.id));

    if(!seleccionadas.length){ alert('Seleccione al menos una factura'); return; }

    const banco = document.getElementById('banco').value;
    const fechaPago = document.getElementById('fechaPago').value;
    const comprobante = document.getElementById('comprobante').value.trim();
    const notas = document.getElementById('notas').value;

    if(!fechaPago || !comprobante){
      alert('Fecha y comprobante son obligatorios');
      return;
    }

    // Recalcula una vez (para traer los n√∫meros exactos)
    recalcularPago();

    // Vuelve a calcular aqu√≠ para guardar
    let subtotalOriginal = 0;
    let descIndividualTotal = 0;
    let subtotalNeto = 0;

    seleccionadas.forEach(id=>{
      const f = getFacturaById(id);
      const base = Number(f?.total || 0);
      const desc = Number(f?.descuento?.monto || 0);
      subtotalOriginal += base;
      descIndividualTotal += desc;
      subtotalNeto += (base - desc);
    });

    // Global simple
    const descGlobal = Number(ajusteGlobal.monto || 0);
    const ajusteGlobalMonto = descGlobal > 0 ? -Math.abs(descGlobal) : 0;

    const totalFinalCalc = subtotalNeto + ajusteGlobalMonto;
    const importe = Number(document.getElementById('importePago').value || totalFinalCalc);

    // JSON facturas_info (incluye ajuste por factura y netos)
    const facturasInfo = seleccionadas.map(id => {
      const f = getFacturaById(id);
      const base = Number(f?.total || 0);
      const desc = Number(f?.descuento?.monto || 0);

      return {
        deuda_id: f.id,
        uuid_cfdi: f.uuid_cfdi,
        fecha: f.fecha,
        proveedor: f.razon_social_emisor,
        serie: f.serie,
        folio: f.folio,
        importe_original: base,
        descuento: f.descuento ? { monto: desc, nota: String(f.descuento?.nota || '') } : null,
        importe_final: base - desc
      };
    });

    // JSON ajustes (global) si aplica
    const ajustesInfo = [];
    if(descGlobal > 0){
      ajustesInfo.push({
        tipo: 'DESCUENTO_GLOBAL',
        monto: Number(ajusteGlobalMonto.toFixed(2)), // NEGATIVO
        nota: String(ajusteGlobal.nota || '')
      });
    }

    btnGuardar.disabled = true;
    msg.innerText = 'Guardando pago...';

    const { error: e1 } = await sb
      .from('pagos_proveedor')
      .insert({
        rfc_emisor: rfc,
        proveedor_nombre: proveedorSelect.options[proveedorSelect.selectedIndex].text,
        banco,
        fecha_pago: fechaPago,

        total_facturas: Number(subtotalNeto.toFixed(2)),          // neto (ya con devoluciones)
        total_ajustes: Number(ajusteGlobalMonto.toFixed(2)),      // global (descuento global)
        importe_pagado: Number(importe.toFixed(2)),               // total final (o el que editaste)

        facturas_info: facturasInfo,
        ajustes: ajustesInfo,

        comprobante_raw: comprobante,
        notas
      });

    if(e1){
      alert(JSON.stringify(e1, null, 2));
      msg.innerText = '';
      btnGuardar.disabled = false;
      return;
    }

    msg.innerText = 'Pago guardado. Marcando facturas como pagadas...';

    const ids = facturasInfo.map(f => f.deuda_id);

    const { error: e2 } = await sb
      .from('deuda_limpia_pdd')
      .update({ factura_pagada: 'SI' })
      .in('id', ids);

    if(e2){
      alert('Pago guardado, pero NO se pudieron marcar las facturas como pagadas:\n\n' + JSON.stringify(e2, null, 2));
      msg.innerText = '‚ö† Pago guardado, pero falt√≥ marcar facturas como pagadas.';
      btnGuardar.disabled = false;
      return;
    }

    msg.innerText = '‚úî Pago guardado correctamente';

    // Limpieza UI
    document.getElementById('comprobante').value = '';
    document.getElementById('notas').value = '';
    ajusteGlobal = { monto: 0, nota: '' };

    btnGuardar.disabled = false;
    cargarFacturas();
  }

  // init
  cargarProveedores();
</script>

</body>
</html>
