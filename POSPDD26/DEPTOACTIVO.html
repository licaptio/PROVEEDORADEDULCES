<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Productos por Departamento (Correcto)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#00416A">

<style>
body{
  font-family:'Poppins',Arial,sans-serif;
  background:#f4f6f9;
  padding:20px;
  color:#222;
}
h1{text-align:center;color:#00416A}
h2{text-align:center;color:#666;font-weight:normal}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:16px;
  margin-top:25px;
}
.card{
  background:white;
  border-radius:14px;
  padding:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  cursor:pointer;
  transition:.2s;
}
.card:hover{transform:scale(1.03)}
.card b{font-size:16px}
.card small{color:#666}

#productosBox{
  display:none;
  margin-top:25px;
}
.producto{
  background:white;
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
.producto b{display:block}

.producto select{
  width:100%;
  padding:8px;
  margin-top:8px;
  border-radius:6px;
  border:1px solid #ccc;
}

.btnBack{
  background:#00416A;
  color:white;
  border:none;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:15px;
}

footer{
  margin-top:40px;
  text-align:center;
  font-size:13px;
  color:#777;
}
</style>
</head>

<body>

<h1>ðŸ“¦ Productos por Departamento</h1>
<h2>ClasificaciÃ³n correcta en Firestore</h2>

<div id="departamentos" class="grid"></div>

<div id="productosBox">
  <button class="btnBack" onclick="volver()">â¬… Regresar</button>
  <h2 id="tituloDepto"></h2>
  <div id="listaProductos"></div>
</div>

<footer>Powered by <b>PROVSOFT</b></footer>

<script type="module">
/* =============================
   IMPORTS FIREBASE
============================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* =============================
   FIREBASE CONFIG
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============================
   VARIABLES
============================= */
const contDeptos = document.getElementById("departamentos");
const boxProductos = document.getElementById("productosBox");
const listaProductos = document.getElementById("listaProductos");
const tituloDepto = document.getElementById("tituloDepto");

let productos = [];
let mapDeptos = {};
let departamentos = [];

/* =============================
   CARGAR DEPARTAMENTOS (ORIGEN REAL)
============================= */
const deptSnap = await getDocs(collection(db,"departamentos_venta"));
departamentos = deptSnap.docs.map(d => ({
  id: d.id,
  ...d.data() // debe contener nombre
}));

/* =============================
   CARGAR PRODUCTOS ACTIVOS
============================= */
const q = query(
  collection(db,"productos"),
  where("activo","==",true)
);

const snap = await getDocs(q);
productos = snap.docs.map(d => ({
  id: d.id,
  ...d.data()
}));

/* =============================
   AGRUPAR POR DEPARTAMENTO
============================= */
mapDeptos = {};
productos.forEach(p => {
  if (p.activo !== true) return;

  const nombreDepto = p.departamento || "SIN DEPARTAMENTO";
  if (!mapDeptos[nombreDepto]) mapDeptos[nombreDepto] = [];
  mapDeptos[nombreDepto].push(p);
});

renderDeptos();

/* =============================
   RENDER DEPARTAMENTOS
============================= */
function renderDeptos(){
  contDeptos.innerHTML="";
  Object.keys(mapDeptos).sort().forEach(dep=>{
    const c = document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <b>${dep}</b><br>
      <small>${mapDeptos[dep].length} productos</small>
    `;
    c.onclick = ()=> verDepto(dep);
    contDeptos.appendChild(c);
  });
}

window.verDepto = dep =>{
  contDeptos.style.display="none";
  boxProductos.style.display="block";
  tituloDepto.textContent = dep;
  listaProductos.innerHTML="";

  mapDeptos[dep].forEach(p=>{
    const div = document.createElement("div");
    div.className="producto";

    div.innerHTML=`
      <b>${p.concepto || "SIN CONCEPTO"}</b>
      CÃ³digo: ${p.codigoBarra || p.id}<br>

      <label>Departamento</label>
      <select>
        ${departamentos.map(d=>`
          <option value="${d.id}"
            ${String(d.id)===String(p.departamento_id)?"selected":""}>
            ${d.nombre}
          </option>
        `).join("")}
      </select>
    `;

    const sel = div.querySelector("select");
    sel.onchange = ()=> cambiarDepto(p, sel.value);

    listaProductos.appendChild(div);
  });
};

window.volver = ()=>{
  contDeptos.style.display="grid";
  boxProductos.style.display="none";
};

/* =============================
   RECLASIFICACIÃ“N CORRECTA
============================= */
async function cambiarDepto(prod, deptoId){
  const depto = departamentos.find(d=>String(d.id)===String(deptoId));
  if(!depto){
    alert("Departamento invÃ¡lido");
    return;
  }

  // ðŸ”¥ AQUÃ SE HACE LA CORRECCIÃ“N REAL EN FIRESTORE
  await updateDoc(doc(db,"productos",prod.id),{
    departamento: depto.nombre,     // TEXTO
    departamento_id: depto.id       // ID REAL
  });

  // actualizar memoria
  prod.departamento = depto.nombre;
  prod.departamento_id = depto.id;

  // reconstruir mapa
  mapDeptos = {};
  productos.forEach(p=>{
    if(p.activo !== true) return;
    const d = p.departamento || "SIN DEPARTAMENTO";
    if(!mapDeptos[d]) mapDeptos[d]=[];
    mapDeptos[d].push(p);
  });

  renderDeptos();
  verDepto(depto.nombre);
}
</script>

</body>
</html>
