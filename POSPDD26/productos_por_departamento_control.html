<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Productos por Departamento â€“ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#00416A">

<style>
body{
  font-family:'Poppins',Arial,sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
  color:#222;
}

h1{
  margin:0 0 10px;
  color:#00416A;
}

.barra{
  display:flex;
  gap:10px;
  background:#fff;
  padding:12px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
  position:sticky;
  top:10px;
  z-index:10;
}

.barra select,
.barra button{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}

.barra button{
  background:#00416A;
  color:#fff;
  cursor:pointer;
}

#lista{
  margin-top:20px;
}

.fila{
  display:grid;
  grid-template-columns: 40px 1fr 220px 140px;
  gap:10px;
  align-items:center;
  background:#fff;
  padding:10px;
  margin-bottom:6px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.fila select{
  padding:6px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:13px;
}

small{color:#666}

footer{
  text-align:center;
  margin-top:30px;
  font-size:12px;
  color:#777;
}
</style>
</head>

<body>

<h1>ðŸ“¦ Control de Productos por Departamento</h1>

<!-- BARRA SUPERIOR -->
<div class="barra">
  <select id="deptoOrigen">
    <option value="">-- Departamento origen --</option>
  </select>

  <select id="deptoDestino">
    <option value="">-- Cambiar a --</option>
  </select>

  <button onclick="procesar()">Procesar</button>
</div>

<!-- LISTA -->
<div id="lista"></div>

<footer>PROVSOFT Â· Herramienta operativa</footer>

<script type="module">
/* =============================
   FIREBASE
============================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* =============================
   CONFIG
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============================
   VARIABLES
============================= */
const deptoOrigen = document.getElementById("deptoOrigen");
const deptoDestino = document.getElementById("deptoDestino");
const lista = document.getElementById("lista");

let productos = [];
let departamentos = [];

let listaActual = [];
let pagina = 0;
const porPagina = 50;

/* =============================
   CARGA DATOS
============================= */
const deptSnap = await getDocs(collection(db,"departamentos_venta"));
departamentos = deptSnap.docs.map(d=>({id:d.id,...d.data()}));

const prodSnap = await getDocs(
  query(collection(db,"productos"), where("activo","==",true))
);
productos = prodSnap.docs.map(d=>({id:d.id,...d.data()}));

/* =============================
   LLENAR SELECTORES
============================= */
departamentos.forEach(d=>{
  deptoOrigen.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
  deptoDestino.innerHTML += `<option value="${d.id}">${d.nombre}</option>`;
});

/* =============================
   CAMBIO DE DEPARTAMENTO ORIGEN
============================= */
deptoOrigen.onchange = ()=>{
  lista.innerHTML="";
  pagina = 0;

  listaActual = productos.filter(p=>p.departamento===deptoOrigen.value);
  cargarMas();
};

/* =============================
   SCROLL INFINITO
============================= */
window.addEventListener("scroll", ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 120){
    cargarMas();
  }
});

/* =============================
   CARGAR MAS PRODUCTOS
============================= */
function cargarMas(){
  const slice = listaActual.slice(pagina*porPagina, (pagina+1)*porPagina);
  if(slice.length===0) return;

  slice.forEach(p=>renderFila(p));
  pagina++;
}

/* =============================
   RENDER FILA
============================= */
function renderFila(p){
  const div = document.createElement("div");
  div.className = "fila";

  div.innerHTML = `
    <input type="checkbox" data-id="${p.id}">
    <div>
      <b>${p.concepto || "SIN CONCEPTO"}</b><br>
      <small>${p.codigoBarra || p.id}</small>
    </div>

    <select class="selDepto">
      ${departamentos.map(d=>`
        <option value="${d.id}"
          ${String(d.id)===String(p.departamento_id)?"selected":""}>
          ${d.nombre}
        </option>
      `).join("")}
    </select>

    <select class="selActivo">
      <option value="true" ${p.activo===true?"selected":""}>Activo</option>
      <option value="false" ${p.activo===false?"selected":""}>Inactivo</option>
    </select>
  `;

  const selDepto = div.querySelector(".selDepto");
  const selActivo = div.querySelector(".selActivo");

  selDepto.onchange = ()=>guardarIndividual(p, selDepto.value, selActivo.value);
  selActivo.onchange = ()=>guardarIndividual(p, selDepto.value, selActivo.value);

  lista.appendChild(div);
}

/* =============================
   GUARDADO INDIVIDUAL
============================= */
async function guardarIndividual(prod, deptoId, activoVal){
  const depto = departamentos.find(d=>String(d.id)===String(deptoId));
  await updateDoc(doc(db,"productos",prod.id),{
    departamento: depto.nombre,
    departamento_id: depto.id,
    activo: activoVal==="true"
  });

  prod.departamento = depto.nombre;
  prod.departamento_id = depto.id;
  prod.activo = activoVal==="true";
}

/* =============================
   PROCESAR SELECCIONADOS
============================= */
async function procesar(){
  const nuevo = deptoDestino.value;
  if(!nuevo){
    alert("Selecciona departamento destino");
    return;
  }

  const depto = departamentos.find(d=>String(d.id)===String(nuevo));
  const checks = document.querySelectorAll("input[type=checkbox]:checked");

  if(checks.length===0){
    alert("No hay productos seleccionados");
    return;
  }

  for(const c of checks){
    const id = c.dataset.id;
    await updateDoc(doc(db,"productos",id),{
      departamento: depto.nombre,
      departamento_id: depto.id
    });
  }

  alert(`Procesados ${checks.length} productos`);
}
</script>

</body>
</html>
