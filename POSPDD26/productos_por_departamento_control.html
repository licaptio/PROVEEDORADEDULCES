<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Productos por Departamento â€“ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:'Poppins',Arial,sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
  color:#222;
}

h1{
  margin-bottom:12px;
  color:#00416A;
}

.barra{
  background:#fff;
  padding:14px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.12);
  position:sticky;
  top:10px;
  z-index:10;
}

.barra select{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
  width:340px;
}

#lista{
  margin-top:20px;
}

.fila{
  display:grid;
  grid-template-columns: 1fr 220px 140px 120px;
  gap:10px;
  align-items:center;
  background:#fff;
  padding:12px;
  margin-bottom:6px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.fila select{
  padding:6px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:13px;
}

.fila button{
  padding:8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#00416A;
  color:white;
}

small{color:#666}

.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#333;
  color:#fff;
  padding:12px 16px;
  border-radius:8px;
  opacity:0;
  transition:.3s;
  pointer-events:none;
}

.toast.show{opacity:1}
</style>
</head>

<body>

<h1>ðŸ“¦ Control de Productos por Departamento</h1>

<!-- BARRA -->
<div class="barra">
  <select id="deptoOrigen">
    <option value="">-- Selecciona departamento --</option>
  </select>
</div>

<!-- LISTA -->
<div id="lista"></div>

<div id="toast" class="toast"></div>

<script type="module">
/* =============================
   FIREBASE
============================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* =============================
   CONFIG
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============================
   VARIABLES
============================= */
const deptoOrigen = document.getElementById("deptoOrigen");
const lista = document.getElementById("lista");
const toast = document.getElementById("toast");

let productos = [];
let departamentos = [];
let deptosValidos = [];

let listaActual = [];
let pagina = 0;
const porPagina = 40;
let cargando = false;

/* =============================
   TOAST
============================= */
function mostrar(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2000);
}

/* =============================
   CARGA DATOS
============================= */
const deptSnap = await getDocs(collection(db,"departamentos_venta"));
departamentos = deptSnap.docs
  .map(d=>({id:d.id,...d.data()}))
  .sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));

deptosValidos = departamentos.map(d=>d.nombre);
const deptoIdsValidos = departamentos.map(d=>String(d.id));

const prodSnap = await getDocs(collection(db,"productos"));
productos = prodSnap.docs.map(d=>({id:d.id,...d.data()}));

/* =============================
   LLENAR SELECT
============================= */
departamentos.forEach(d=>{
  deptoOrigen.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
});

deptoOrigen.innerHTML += `
  <option value="__SIN_DEPTO__">âš  SIN DEPARTAMENTO / ERROR</option>
`;

/* =============================
   CAMBIO DE DEPARTAMENTO
============================= */
deptoOrigen.onchange = ()=>{
  lista.innerHTML="";
  pagina = 0;

listaActual = productos.filter(p=>{
  const nombre = typeof p.departamento === "string"
    ? p.departamento.trim()
    : "";

  const id = p.departamento_id !== undefined && p.departamento_id !== null
    ? String(p.departamento_id)
    : null;

  if(deptoOrigen.value === "__SIN_DEPTO__"){
    return (
      !nombre ||                                   // sin texto vÃ¡lido
      !deptosValidos.includes(nombre) ||           // texto inexistente
      !id ||                                       // sin id
      !departamentos.some(d => String(d.id) === id) // id invÃ¡lido
    );
  }

  return nombre === deptoOrigen.value;
});


  cargarMas();
};

/* =============================
   SCROLL INFINITO (PROTEGIDO)
============================= */
window.addEventListener("scroll",()=>{
  if(
    window.innerHeight + window.scrollY >= document.body.offsetHeight - 120
  ){
    cargarMas();
  }
});

/* =============================
   CARGAR MÃS
============================= */
function cargarMas(){
  if(cargando) return;
  cargando = true;

  const slice = listaActual.slice(
    pagina * porPagina,
    (pagina + 1) * porPagina
  );

  if(slice.length === 0){
    cargando = false;
    return;
  }

  slice.forEach(p=>renderFila(p));
  pagina++;
  cargando = false;
}

/* =============================
   RENDER FILA
============================= */
function renderFila(p){
  const div = document.createElement("div");
  div.className = "fila";

  div.innerHTML = `
    <div>
      <b>${p.concepto || "SIN CONCEPTO"}</b><br>
      <small>${p.codigoBarra || p.id}</small>
    </div>

<select class="selDepto">
  <option value="">-- Selecciona el depto --</option>
  ${departamentos.map(d=>`
    <option value="${d.id}">
      ${d.nombre}
    </option>
  `).join("")}
</select>


    <select class="selActivo">
      <option value="true" ${p.activo===true?"selected":""}>Activo</option>
      <option value="false" ${p.activo===false?"selected":""}>Inactivo</option>
    </select>

    <button>Guardar</button>
  `;

  const selDepto = div.querySelector(".selDepto");
  const selActivo = div.querySelector(".selActivo");
  const btn = div.querySelector("button");

btn.onclick = async ()=>{
  const activoNuevo = selActivo.value === "true";

  const cambios = {
    activo: activoNuevo
  };

  // âœ… Solo reclasifica si el usuario eligiÃ³ un depto explÃ­citamente
  if(selDepto.value){
    const depto = departamentos.find(
      d => String(d.id) === String(selDepto.value)
    );

    cambios.departamento = depto.nombre;
    cambios.departamento_id = depto.id;
  }

  await updateDoc(doc(db,"productos",p.id), cambios);

  mostrar(
    activoNuevo === false
      ? "Producto desactivado"
      : "Producto actualizado"
  );

  // actualizar memoria
  p.activo = activoNuevo;

  if(cambios.departamento){
    p.departamento = cambios.departamento;
    p.departamento_id = cambios.departamento_id;
  }

  // quitar de la vista si ya no pertenece al filtro
  if(
    deptoOrigen.value === "__SIN_DEPTO__" ||
    (p.departamento && p.departamento !== deptoOrigen.value)
  ){
    div.remove();
  }
};


  lista.appendChild(div);
}
</script>

</body>
</html>
