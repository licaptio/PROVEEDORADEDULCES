<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Te√≥rico ‚Äì PROVSOFT</title>

<style>
  #loadingBar {
    width: 100%;
    background: #c7dbff;
    height: 20px;
    border-radius: 8px;
    margin-top: 10px;
    overflow: hidden;
    display: none;
  }
  #loadingInner {
    width: 0%;
    height: 100%;
    background: #00416A;
    transition: width .4s;
  }
  th {
    background:#00416A;
    color:white;
    padding:10px;
    font-size:15px;
    text-transform:uppercase;
  }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, query, where, getDocs 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ============================================
   CARGAR PRODUCTOS PARA OBTENER CONCEPTO
============================================ */
async function cargarProductos() {
  const snap = await getDocs(collection(db, "productos"));
  const mapa = {};

  snap.forEach(doc => {
    const data = doc.data();
    if (data.activo) {
      mapa[data.codigoBarra] = data.concepto || "(SIN NOMBRE)";
    }
  });

  return mapa;
}

/* ============================================
   OBTENER ENTRADAS DEL ALMAC√âN
============================================ */
async function cargarEntradas(rutaId) {
  let entradas = {};

  const snap = await getDocs(collection(db, "almacenes", rutaId, "entradas"));

  snap.forEach(doc => {
    const data = doc.data();
    (data.items || []).forEach(item => {
      if (!entradas[item.codigo]) entradas[item.codigo] = 0;
      entradas[item.codigo] += Number(item.cantidad);
    });
  });

  return entradas;
}

/* ============================================
   OBTENER VENTAS (SALIDAS)
============================================ */
async function cargarSalidas(rutaId) {
  let salidas = {};

  const q = query(collection(db, "ventas_rutav2"), where("rutaId", "==", rutaId));
  const snap = await getDocs(q);

  snap.forEach(doc => {
    const data = doc.data();
    (data.detalle || []).forEach(item => {
      if (!salidas[item.codigo]) salidas[item.codigo] = 0;
      salidas[item.codigo] += Number(item.cantidad);
    });
  });

  return salidas;
}

/* ============================================
   INVENTARIO TE√ìRICO FINAL
============================================ */
async function generarInventario() {
  const rutaId = document.getElementById("almacenSelect").value;
  if (!rutaId) return alert("Seleccione un almac√©n");

  const tbody = document.getElementById("tablaBody");
  tbody.innerHTML = "";

  // Mostrar barra
  document.getElementById("loadingBar").style.display = "block";
  document.getElementById("loadingInner").style.width = "0%";

  let progreso = 0;
  const actualizarBarra = () => {
    progreso += 10;
    if (progreso > 100) progreso = 100;
    document.getElementById("loadingInner").style.width = progreso + "%";
  };

  actualizarBarra();

  const entradas = await cargarEntradas(rutaId);
  actualizarBarra();

  const salidas = await cargarSalidas(rutaId);
  actualizarBarra();

  const snapProductos = await getDocs(collection(db, "productos"));
  actualizarBarra();

  const productos = {};
  snapProductos.forEach(doc => productos[doc.id] = doc.data());

  const inventario = {};
  const codigos = new Set([
    ...Object.keys(entradas),
    ...Object.keys(salidas)
  ]);

  actualizarBarra();

  codigos.forEach(codigo => {
    inventario[codigo] = {
      codigo,
      concepto: productos[codigo]?.concepto || "SIN CONCEPTO",
      entradas: entradas[codigo] || 0,
      salidas: salidas[codigo] || 0,
      existencia: (entradas[codigo] || 0) - (salidas[codigo] || 0)
    };
  });

  actualizarBarra();

  const listaOrdenada = Object.values(inventario).sort((a, b) =>
    a.concepto.localeCompare(b.concepto)
  );

  tbody.innerHTML = "";
  listaOrdenada.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.codigo}</td>
      <td>${item.concepto}</td>
      <td>${item.entradas}</td>
      <td>${item.salidas}</td>
      <td><b>${item.existencia}</b></td>
    `;
    tbody.appendChild(tr);
  });

  // Barra al 100%
  document.getElementById("loadingInner").style.width = "100%";

  // Ocultar barra despu√©s de 1.2 segundos
  setTimeout(() => {
    document.getElementById("loadingBar").style.display = "none";
  }, 1200);
}


document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnGenerar").onclick = generarInventario;
});
</script>

</head>
<body>

<h2>Inventario Te√≥rico por Almac√©n ‚Äì PROVSOFT</h2>

<select id="almacenSelect">
  <option value="">Seleccione almac√©n‚Ä¶</option>
  <option value="Almacen_Ruta_1">Almacen_Ruta_1</option>
  <option value="Almacen_Ruta_2">Almacen_Ruta_2</option>
  <option value="MERMA">MERMA</option>
  <option value="ALMACENCENTRALPDD">ALMACENCENTRALPDD</option>
</select>

<button id="btnGenerar" style="width:100%;padding:12px;border:none;
background:#0c6cbd;color:white;border-radius:8px;font-weight:bold;">
  Generar Inventario
</button>

<!-- üîµ BARRA DE CARGA AQU√ç -->
<div id="loadingBar">
  <div id="loadingInner"></div>
</div>


<table>
<thead>
  <tr>
    <th>C√≥digo</th>
    <th>Entradas</th>
    <th>Salidas</th>
    <th>Te√≥rico</th>
  </tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

</body>
</html>
