<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Teórico – PROVSOFT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #f2f6ff;
    margin: 0;
    padding: 0;
  }

  header {
    background: linear-gradient(to right, #00416A, #0c6cbd);
    padding: 18px;
    color: white;
    text-align: center;
    font-size: 24px;
    font-weight: 600;
  }

  select {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #bbb;
    margin-bottom: 15px;
  }

  button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    background: #00416A;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  #loadingBar {
    width: 100%;
    background: #d8e4ff;
    height: 22px;
    border-radius: 8px;
    overflow: hidden;
    margin: 15px 0;
    display: none;
  }

  #loadingInner {
    width: 0%;
    height: 100%;
    background: #0c6cbd;
    transition: width .3s;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
  }

  th {
    background: #00416A;
    color: white;
    padding: 12px;
    font-size: 14px;
    text-transform: uppercase;
  }

  td {
    padding: 10px;
    border-bottom: 1px solid #e8e8e8;
  }
</style>

<script type="module">
/* ============================================================
   FIREBASE
============================================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* ============================================================
   FECHA MÍNIMA (RUTA 1 y RUTA 2 = MISMA FECHA)
============================================================ */
function fechaMinimaPorAlmacen(almacen) {

  if (almacen === "Almacen_Ruta_1") 
    return new Date("2025-11-28T00:00:00");

  if (almacen === "Almacen_Ruta_2") 
    return new Date("2025-11-28T00:00:00");

  return new Date("2000-01-01"); // sin filtro para otros almacenes
}


/* ============================================================
   CARGAR PRODUCTOS
============================================================ */
async function cargarProductos() {
  const snap = await getDocs(collection(db, "productos"));
  const mapa = {};

  snap.forEach(doc => {
    const d = doc.data();
    if (d.activo) mapa[d.codigoBarra] = d.concepto || "(SIN NOMBRE)";
  });

  return mapa;
}


/* ============================================================
   ENTRADAS FILTRADAS
============================================================ */
async function cargarEntradas(rutaId) {
  let entradas = {};
  const limite = fechaMinimaPorAlmacen(rutaId);

  const snap = await getDocs(collection(db, "almacenes", rutaId, "entradas"));

  snap.forEach(doc => {
    const data = doc.data();
    if (!data.items || !data.fecha) return;

    const fechaEntrada = new Date(data.fecha);
    if (fechaEntrada < limite) return;

    data.items.forEach(item => {
      if (!entradas[item.codigo]) entradas[item.codigo] = 0;
      entradas[item.codigo] += Number(item.cantidad);
    });
  });

  return entradas;
}


/* ============================================================
   SALIDAS FILTRADAS
============================================================ */
async function cargarSalidas(rutaId) {
  let salidas = {};
  const limite = fechaMinimaPorAlmacen(rutaId);

  const q = query(collection(db, "ventas_rutav2"), where("rutaId", "==", rutaId));
  const snap = await getDocs(q);

  snap.forEach(doc => {
    const data = doc.data();
    if (!data.detalle || !data.fecha) return;

    const fechaVenta = new Date(data.fecha);
    if (fechaVenta < limite) return;

    data.detalle.forEach(item => {
      if (!salidas[item.codigo]) salidas[item.codigo] = 0;
      salidas[item.codigo] += Number(item.cantidad);
    });
  });

  return salidas;
}


/* ============================================================
   INVENTARIO
============================================================ */
async function generarInventario() {
  const rutaId = document.getElementById("almacenSelect").value;
  if (!rutaId) return alert("Seleccione un almacén");

  const tbody = document.getElementById("tablaBody");
  tbody.innerHTML = "";

  document.getElementById("loadingBar").style.display = "block";
  document.getElementById("loadingInner").style.width = "0%";

  let progreso = 0;
  const avanzar = () => {
    progreso += 20;
    if (progreso > 100) progreso = 100;
    document.getElementById("loadingInner").style.width = progreso + "%";
  };

  avanzar();
  const entradas = await cargarEntradas(rutaId);

  avanzar();
  const salidas = await cargarSalidas(rutaId);

  avanzar();
  const productosSnap = await getDocs(collection(db, "productos"));

  const productos = {};
  productosSnap.forEach(doc => productos[doc.id] = doc.data());

  avanzar();
  
  const inventario = {};
  const codigos = new Set([...Object.keys(entradas), ...Object.keys(salidas)]);

  codigos.forEach(codigo => {
    const prod = productos[codigo];

    const existencia = (entradas[codigo] || 0) - (salidas[codigo] || 0);
    const costo = prod?.costoSinImpuesto || 0;
    const costoTotal = existencia * costo;

    inventario[codigo] = {
      codigo,
      concepto: prod?.concepto || "SIN CONCEPTO",
      entradas: entradas[codigo] || 0,
      salidas: salidas[codigo] || 0,
      existencia,
      costoUnit: costo,
      costoTotal
    };
  });

  avanzar();

  let totalGeneral = 0;
  tbody.innerHTML = "";

  Object.values(inventario)
    .sort((a, b) => a.concepto.localeCompare(b.concepto))
    .forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.codigo}</td>
        <td>${item.concepto}</td>
        <td>${item.entradas}</td>
        <td>${item.salidas}</td>
        <td><b>${item.existencia}</b></td>
        <td>$${item.costoUnit.toFixed(2)}</td>
        <td><b>$${item.costoTotal.toFixed(2)}</b></td>
      `;
      tbody.appendChild(tr);
      totalGeneral += item.costoTotal;
    });

  document.getElementById("totalGeneralBox").innerHTML =
    "TOTAL MERCANCÍA: $" + totalGeneral.toFixed(2);

  document.getElementById("loadingInner").style.width = "100%";
  setTimeout(() => document.getElementById("loadingBar").style.display = "none", 1200);
}


/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnGenerar").onclick = generarInventario;
});
</script>

</head>
<body>

<h2>Inventario Teórico por Almacén – PROVSOFT</h2>

<select id="almacenSelect">
  <option value="">Seleccione almacén…</option>
  <option value="Almacen_Ruta_1">Almacen_Ruta_1</option>
  <option value="Almacen_Ruta_2">Almacen_Ruta_2</option>
  <option value="MERMA">MERMA</option>
  <option value="ALMACENCENTRALPDD">ALMACENCENTRALPDD</option>
</select>

<button id="btnGenerar">Generar Inventario</button>

<div id="loadingBar"><div id="loadingInner"></div></div>

<table>
<thead>
  <tr>
    <th>Código</th>
    <th>Concepto</th>
    <th>Entradas</th>
    <th>Salidas</th>
    <th>Teórico</th>
    <th>Costo Unit</th>
    <th>Total $</th>
  </tr>
</thead>

<tbody id="tablaBody"></tbody>
</table>

<div id="totalGeneralBox"
     style="margin-top:20px; background:#00416A; color:white;
            padding:15px; font-size:20px; text-align:center;
            border-radius:10px; font-weight:bold;">
  TOTAL MERCANCÍA: $0.00
</div>

</body>
</html>
