<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ajuste de Inventario – PROVSOFT</title>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #eef3ff;
    margin: 0; padding: 20px;
  }
  h2 { text-align: center; color: #00416A; margin-bottom: 20px; }
  select, button {
    padding: 10px; border-radius: 8px; border: 1px solid #ccc;
    font-size: 15px; width: 100%; margin-bottom: 15px;
  }
  button { background: #0c6cbd; color: white; cursor: pointer; font-weight: bold; border: none; }

  #loadingBar {
    width: 100%; background: #c7dbff; height: 20px;
    border-radius: 8px; overflow: hidden; display: none; margin-bottom: 18px;
  }
  #loadingInner {
    width: 0%; height: 100%; background: #00416A; transition: width .4s;
  }

  table { width: 100%; border-collapse: collapse; background: #fff;
    border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,.15); }
  th {
    background: #00416A; color: white; padding: 10px;
    text-transform: uppercase; font-size: 14px;
  }
  td { padding: 10px; border-bottom: 1px solid #ddd; font-size: 14px; }
  .positivo { background: #c8ffd1; font-weight: bold; }
  .negativo { background: #ffd4d4; font-weight: bold; }

  .totalBox {
    margin-top: 15px; background: #ffffff; padding: 15px;
    border-radius: 8px; font-size: 18px; box-shadow: 0 3px 10px rgba(0,0,0,.1);
  }
</style>

<script type="module">

/* ========================================================
   FIREBASE
======================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, query, where, getDocs, addDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* ========================================================
   FILTRO DE FECHA (RUTA 1 y 2 = MISMA FECHA)
======================================================== */
function fechaMinimaPorAlmacen(almacen) {

  if (almacen === "Almacen_Ruta_1")
    return new Date("2025-11-28T00:00:00");

  if (almacen === "Almacen_Ruta_2")
    return new Date("2025-11-28T00:00:00");

  return new Date("2000-01-01");
}

/* ========================================================
   CARGAR PRODUCTOS
======================================================== */
async function cargarProductos() {
  const snap = await getDocs(collection(db, "productos"));
  const mapa = {};

  snap.forEach(doc => {
    const d = doc.data();
    if (d.activo) {
      mapa[d.codigoBarra] = {
        concepto: d.concepto || "(SIN NOMBRE)",
        costo: Number(d.costoSinImpuesto || 0)
      };
    }
  });

  return mapa;
}

/* ========================================================
   ENTRADAS FILTRADAS
======================================================== */
async function cargarEntradas(rutaId) {
  let entradas = {};
  const limite = fechaMinimaPorAlmacen(rutaId);

  const snap = await getDocs(collection(db, "almacenes", rutaId, "entradas"));

  snap.forEach(doc => {
    const data = doc.data();
    if (!data.items || !data.fecha) return;

    const fechaEntrada = data.fecha.toDate ? data.fecha.toDate() : new Date(data.fecha);
    if (fechaEntrada < limite) return;

    data.items.forEach(item => {
      if (!entradas[item.codigo]) entradas[item.codigo] = 0;
      entradas[item.codigo] += Number(item.cantidad);
    });
  });

  return entradas;
}

/* ========================================================
   SALIDAS FILTRADAS (VENTAS)
======================================================== */
async function cargarSalidas(rutaId) {
  let salidas = {};
  const limite = fechaMinimaPorAlmacen(rutaId);

  const q = query(collection(db, "ventas_rutav2"), where("rutaId", "==", rutaId));
  const snap = await getDocs(q);

  snap.forEach(doc => {
    const data = doc.data();
    if (!data.detalle || !data.fecha) return;

    const fechaVenta = data.fecha.toDate ? data.fecha.toDate() : new Date(data.fecha);
    if (fechaVenta < limite) return;

    data.detalle.forEach(item => {
      if (!salidas[item.codigo]) salidas[item.codigo] = 0;
      salidas[item.codigo] += Number(item.cantidad);
    });
  });

  return salidas;
}

/* ========================================================
   GENERAR INVENTARIO
======================================================== */
let inventarioGlobal = {};

async function generarInventario() {
  const rutaId = document.getElementById("almacenSelect").value;
  if (!rutaId) return alert("Seleccione un almacén");

  document.getElementById("loadingBar").style.display = "block";
  document.getElementById("loadingInner").style.width = "0%";

  const avanzar = () => {
    const bar = document.getElementById("loadingInner");
    let pct = parseInt(bar.style.width) || 0;
    bar.style.width = Math.min(pct + 25, 100) + "%";
  };

  avanzar();
  const entradas = await cargarEntradas(rutaId);

  avanzar();
  const salidas = await cargarSalidas(rutaId);

  avanzar();
  const productos = await cargarProductos();

  avanzar();

  const codigos = new Set([...Object.keys(entradas), ...Object.keys(salidas)]);
  inventarioGlobal = {};

  codigos.forEach(codigo => {
    let teorico = (entradas[codigo] || 0) - (salidas[codigo] || 0);
    let info = productos[codigo] || { concepto: "(SIN NOMBRE)", costo: 0 };

    inventarioGlobal[codigo] = {
      codigo,
      concepto: info.concepto,
      costo: info.costo,
      teorico,
      fisico: teorico,
      diferencia: 0
    };
  });

  pintarTabla();

  document.getElementById("loadingInner").style.width = "100%";
  setTimeout(() => document.getElementById("loadingBar").style.display = "none", 800);
}

/* ========================================================
   PINTAR TABLA
======================================================== */
function pintarTabla() {
  const tbody = document.getElementById("tablaBody");
  tbody.innerHTML = "";

  Object.values(inventarioGlobal)
    .sort((a, b) => a.concepto.localeCompare(b.concepto))
    .forEach(item => {

      const clase =
        item.diferencia > 0 ? "positivo" :
        item.diferencia < 0 ? "negativo" : "";

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.codigo}</td>
        <td>${item.concepto}</td>
        <td>${item.teorico.toFixed(3)}</td>
        <td>
          <input type="number" step="0.001"
            value="${item.fisico.toFixed(3)}"
            style="width:80px;"
            onchange="actualizarFisico('${item.codigo}', parseFloat(this.value))">
        </td>
        <td class="${clase}">
          ${item.diferencia.toFixed(3)}
        </td>
      `;

      tbody.appendChild(tr);
    });

  calcularTotales();
}

/* ========================================================
   ACTUALIZAR FÍSICO
======================================================== */
window.actualizarFisico = (codigo, valor) => {
  let item = inventarioGlobal[codigo];
  item.fisico = parseFloat(valor);
  item.diferencia = parseFloat((item.fisico - item.teorico).toFixed(3));
  pintarTabla();
};

/* ========================================================
   TOTALES
======================================================== */
function calcularTotales() {
  let piezas = 0, dinero = 0;

  Object.values(inventarioGlobal).forEach(i => {
    if (i.diferencia !== 0) {
      piezas += Math.abs(i.diferencia);
      dinero += Math.abs(i.diferencia) * i.costo;
    }
  });

  document.getElementById("totalBox").innerHTML =
    `Ajuste Total: <b>${piezas}</b> piezas — $${dinero.toFixed(2)}`;
}

/* ========================================================
   GUARDAR AJUSTE
======================================================== */
async function aplicarAjuste() {
  const rutaId = document.getElementById("almacenSelect").value;
  if (!rutaId) return alert("Seleccione almacén");

  let itemsAjuste = [];

  Object.values(inventarioGlobal).forEach(i => {
    if (i.diferencia !== 0) {
      let tipo = i.diferencia > 0 ? "ENTRADA_AJUSTE" : "SALIDA_AJUSTE";

      itemsAjuste.push({
        codigo: i.codigo,
        concepto: i.concepto,
        cantidad: i.diferencia,
        precio: i.costo,
        diferencia: i.diferencia,
        tipoMovimiento: tipo
      });
    }
  });

  if (itemsAjuste.length === 0)
    return alert("No hay ajustes por aplicar.");

  await addDoc(collection(db, "almacenes", rutaId, "entradas"), {
    tipo: "AJUSTE",
    subTipo: itemsAjuste.some(x => x.tipoMovimiento === "SALIDA_AJUSTE") ? "MIXTO" : "ENTRADA_AJUSTE",
    fecha: new Date().toISOString(),
    items: itemsAjuste
  });

  alert("✔ Ajuste registrado correctamente");
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnGenerar").onclick = generarInventario;
  document.getElementById("btnAjustar").onclick = aplicarAjuste;
});

</script>
</head>

<body>

<h2>Ajuste de Inventario – PROVSOFT</h2>

<select id="almacenSelect">
  <option value="">Seleccione almacén…</option>
  <option value="Almacen_Ruta_1">Almacen_Ruta_1</option>
  <option value="Almacen_Ruta_2">Almacen_Ruta_2</option>
  <option value="MERMA">MERMA</option>
  <option value="ALMACENCENTRALPDD">ALMACENCENTRALPDD</option>
</select>

<button id="btnGenerar">Generar Inventario</button>

<div id="loadingBar"><div id="loadingInner"></div></div>

<table>
<thead>
  <tr>
    <th>Código</th>
    <th>Concepto</th>
    <th>Teórico</th>
    <th>Físico</th>
    <th>Diferencia</th>
  </tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

<div id="totalBox" class="totalBox">Ajuste Total: 0 piezas — $0.00</div>

<button id="btnAjustar">Aplicar Ajuste</button>

</body>
</html>
