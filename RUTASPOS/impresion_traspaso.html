<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ImpresiÃ³n Traspaso â€“ PROVSOFT</title>

<style>
:root{
  --paper: 80mm;
  --font: 17px;
}

/* ====== PANTALLA ====== */
body{
  margin:0;
  padding:20px;
  background:#f1f1f1;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  color:#000;
}

.ticket{
  width: var(--paper);
  background:#fff;
  margin: 25mm auto;
  padding: 16mm 8mm;
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}

.center{ text-align:center; }
.right{ text-align:right; }
.muted{ color:#444; }

/* ====== TITULOS ====== */
.h1{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: 1.2px;
}
.h2{
  font-size: 17px;
  font-weight: 800;
  margin-top: 6px;
}

/* ====== SEPARADORES ====== */
.hr{
  border-top: 2px dashed #000;
  margin: 16px 0;
}

/* ====== DATOS ====== */
.kv{
  font-size: var(--font);
  line-height: 1.6;
  margin: 8px 0;
  word-break: break-word;
}
.kv b{ font-weight:900; }

/* ====== TABLA ====== */
table{
  width:100%;
  border-collapse:collapse;
  font-size: 16px;
  line-height:1.6;
}
th, td{
  padding: 8px 0;
  vertical-align:top;
}
th{
  font-weight:900;
  border-bottom:2px solid #000;
}
td{
  border-bottom:1px dotted #999;
}

.col-cant{ width: 14%; text-align:right; padding-right:6px; }
.col-cod { width: 24%; }
.col-desc{ width: 40%; }
.col-precio{ width: 22%; text-align:right; font-weight:900; }

/* ====== FIRMAS ====== */
.sigWrap{
  margin-top: 45px;
  font-size: var(--font);
}

.sigBox{
  border-top: 2px solid #000;
  margin-top: 55px;
  padding-top: 14px;
}

.sigImg{
  display:block;
  width: 100%;
  max-height: 200px;
  object-fit: contain;
  margin-top: 12px;
}

/* ====== BOTONES (SOLO PANTALLA) ====== */
.btns{
  width: var(--paper);
  margin: 18px auto 0;
  display:flex;
  gap:14px;
  justify-content:center;
}
button{
  padding:14px 18px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
}
.print{ background:#0c6cbd; color:#fff; }
.close{ background:#ddd; color:#111; }

/* ====== IMPRESIÃ“N REAL ====== */
@media print {
  @page{
    size: 80mm auto;
    margin: 0;
  }

  body{
    margin:0;
    padding:0;
    background:#fff;
    font-size: 17px;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* ðŸš€ ZOOM REAL +40% */
  .ticket{
    width: 80mm;
    margin: 0 auto;
    padding: 0;
    transform: scale(1.4);
    transform-origin: top center;
    box-shadow:none;
  }

  .btns{ display:none !important; }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const qs = (n) => new URLSearchParams(location.search).get(n);

function fmtFecha(iso){
  const d = new Date(iso);
  return d.toLocaleString("es-MX",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
}

async function cargar(){
  const id = qs("id");
  const ruta = qs("ruta");

  const ref = doc(db, "almacenes", ruta, "entradas", id);
  const snap = await getDoc(ref);
  const data = snap.data();

  document.getElementById("folio").textContent = id;
  document.getElementById("rutaId").textContent = ruta;
  document.getElementById("vendedorId").textContent = data.vendedorId;
  document.getElementById("vendedorNombre").textContent = data.vendedorNombre;
  document.getElementById("fecha").textContent = fmtFecha(data.fecha);

  const tbody = document.getElementById("items");
  tbody.innerHTML = "";

  data.items.forEach(it=>{
    const precio = Number(it.precioUnitario ?? it.precio ?? 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-cant right">${it.cantidad}</td>
      <td class="col-cod">${it.codigo}</td>
      <td class="col-desc">${it.concepto}</td>
      <td class="col-precio right">$${precio.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("entregaNombre").textContent = data.firmas.entrega.nombre;
  document.getElementById("recibeNombre").textContent  = data.firmas.recibe.nombre;
  document.getElementById("sigEntrega").src = data.firmas.entrega.pngBase64;
  document.getElementById("sigRecibe").src  = data.firmas.recibe.pngBase64;
}

window.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("btnPrint").onclick=()=>window.print();
  document.getElementById("btnClose").onclick=()=>window.close();
  cargar();
});
</script>
</head>

<body>

<div class="ticket">
  <div class="center h1">PROVSOFT</div>
  <div class="center h2">TRASPASO ENTRE ALMACENES</div>

  <div class="hr"></div>

  <div class="kv"><b>Folio:</b> <span id="folio"></span></div>
  <div class="kv"><b>Ruta:</b> <span id="rutaId"></span></div>
  <div class="kv"><b>Vendedor ID:</b> <span id="vendedorId"></span></div>
  <div class="kv"><b>Vendedor:</b> <span id="vendedorNombre"></span></div>
  <div class="kv"><b>Fecha:</b> <span id="fecha"></span></div>

  <div class="hr"></div>

  <div class="h2 center">DETALLE</div>
  <table>
    <thead>
      <tr>
        <th class="col-cant right">Cant</th>
        <th class="col-cod">CÃ³digo</th>
        <th class="col-desc">Producto</th>
        <th class="col-precio right">P.U.</th>
      </tr>
    </thead>
    <tbody id="items"></tbody>
  </table>

  <div class="hr"></div>

  <div class="sigWrap">
    <div class="sigBox">
      <b>ENTREGA:</b> <span id="entregaNombre"></span>
      <img id="sigEntrega" class="sigImg">
    </div>

    <div class="sigBox">
      <b>RECIBE:</b> <span id="recibeNombre"></span>
      <img id="sigRecibe" class="sigImg">
    </div>
  </div>

  <div class="center muted" style="margin-top:26px;">
    â€” FIN DEL TICKET â€”
  </div>
</div>

<div class="btns">
  <button class="print" id="btnPrint">IMPRIMIR</button>
  <button class="close" id="btnClose">CERRAR</button>
</div>

</body>
</html>
