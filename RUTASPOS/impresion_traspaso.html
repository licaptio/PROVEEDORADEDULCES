<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Impresión de Traspaso – PROVSOFT</title>

<!-- LIBRERÍA QRCODE -->
<script src="qr_lib.js"></script>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 20px;
    background: white;
    color: #333;
  }

  .carta {
    width: 21.59cm;
    min-height: 27.94cm;
    margin: auto;
    padding: 25px;
    border: 1px solid #ddd;
    box-sizing: border-box;
  }

  h1 {
    text-align: center;
    margin: 0;
    font-size: 26px;
    color: #00416A;
    font-weight: 700;
  }

  .encabezado {
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    font-size: 15px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th {
    background: #00416A;
    color: #fff;
    padding: 8px;
    font-weight: 600;
    border: 1px solid #ddd;
  }

  td {
    padding: 8px;
    border: 1px solid #ddd;
    font-size: 14px;
  }

  .firmas {
    margin-top: 40px;
    display: flex;
    justify-content: space-between;
  }

  .firmaBox {
    width: 45%;
    text-align: center;
  }

  .firmaImg {
    width: 100%;
    max-height: 140px;
    object-fit: contain;
    margin-bottom: 8px;
  }

  #qr {
    margin-top: 10px;
    text-align: right;
  }

  @media print {
    #btnImprimir { display: none; }
  }

  #btnImprimir {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    background: #00416A;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="carta">
  <h1>TRASPASO ENTRE ALMACENES</h1>

  <div class="encabezado">
    <div>
      <b>ID Traspaso:</b> <span id="idPrint"></span><br>
      <b>Fecha:</b> <span id="fechaPrint"></span><br>
      <b>Ruta:</b> <span id="rutaPrint"></span>
    </div>

    <div id="qr"></div>
  </div>

  <table>
<thead>
  <tr>
    <th>Código</th>
    <th>Producto</th>
    <th>Cantidad</th>
    <th>Precio Público</th>   <!-- NUEVO -->
  </tr>
</thead>

    <tbody id="tablaPrint"></tbody>
  </table>

  <div class="firmas">
    <div class="firmaBox">
      <img id="firmaEntrega" class="firmaImg">
      <hr>
      <b>Entrega almacén</b>
    </div>

    <div class="firmaBox">
      <img id="firmaRecibe" class="firmaImg">
      <hr>
      <b>Recibe vendedor</b>
    </div>
  </div>
</div>

<button id="btnImprimir" onclick="window.print()">Imprimir</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// LEER ID DE URL
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

// MOSTRAR ID
document.getElementById("idPrint").innerText = id;
const ruta = params.get("ruta");

// CARGAR DATOS
async function cargar() {
const ref = doc(db, "almacenes", ruta, "entradas", id);
const snap = await getDoc(ref);

if (!snap.exists()) {
  alert("No se encontró el traspaso en la ruta: " + ruta);
  return;
}

const data = snap.data();

  if (!data) return alert("No encontrado");

  document.getElementById("fechaPrint").innerText = data.fecha.substring(0, 10);
  document.getElementById("rutaPrint").innerText = data.rutaId;

  // tabla
  const tabla = document.getElementById("tablaPrint");
  data.items.forEach(it => {
tabla.innerHTML += `
  <tr>
    <td>${it.codigo}</td>
    <td>${it.concepto}</td>
    <td>${it.cantidad}</td>
    <td>$${(it.precio ?? 0).toFixed(2)}</td> <!-- NUEVO -->
  </tr>
`;

  });

  // firmas si existen
  if (data.firmaEntregaURL) document.getElementById("firmaEntrega").src = data.firmaEntregaURL;
  if (data.firmaRecibeURL) document.getElementById("firmaRecibe").src = data.firmaRecibeURL;

  // generar QR
  new QRCode(document.getElementById("qr"), "https://tuservidor.com/firmar.html?id=" + id);
}

cargar();
</script>

</body>
</html>
