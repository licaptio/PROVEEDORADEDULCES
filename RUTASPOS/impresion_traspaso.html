<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impresi√≥n Traspaso ‚Äì PROVSOFT</title>

<style>
:root{
  --paper: 80mm;
  --font: 14px;
}

/* ======================
   PANTALLA (NORMAL)
====================== */
body{
  margin:0;
  padding:20px;
  background:#f1f1f1;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  color:#000;
}

.ticket{
  width: 420px; /* ancho c√≥modo en pantalla */
  background:#fff;
  margin: 25mm auto;
  padding: 16mm 8mm;
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}

@media print{
  .ticket{
    width: 80mm; /* ancho real impresora */
    margin:0;
    box-shadow:none;
  }
}


.center{ text-align:center; }
.right{ text-align:right; }
.muted{ color:#444; }

.h1{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: 1.2px;
}
.h2{
  font-size: 17px;
  font-weight: 800;
  margin-top: 6px;
}

.hr{
  border-top: 2px dashed #000;
  margin: 16px 0;
}

.kv{
  font-size: var(--font);
  line-height: 1.6;
  margin: 8px 0;
}
.kv b{ font-weight:900; }

table{
  width:100%;
  border-collapse:collapse;
  table-layout: fixed; /* üî• CLAVE */
  font-size: 14px;
}

th:nth-child(1), td:nth-child(1){
  width: 10%;
  text-align:right;
}

th:nth-child(2), td:nth-child(2){
  width: 22%;
}

th:nth-child(3), td:nth-child(3){
  width: 48%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis; /* üî• corta descripci√≥n */
}

th:nth-child(4), td:nth-child(4){
  width: 20%;
  text-align:right;
}

  th, td{
  padding: 6px 0;
}
th{
  font-weight:900;
  border-bottom:2px solid #000;
}
td{
  border-bottom:1px dotted #999;
  overflow:hidden;
}
  
/* BOTONES */
.btns{
  width: var(--paper);
  margin: 18px auto 0;
  display:flex;
  gap:14px;
  justify-content:center;
}
button{
  padding:14px 18px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
}
.print{ background:#0c6cbd; color:#fff; }
.close{ background:#ddd; color:#111; }

/* ===============================
   üñ®Ô∏è IMPRESI√ìN GENERIC / TEXT ONLY
=============================== */
@media print {

  @page{
    size:auto;
    margin:0;
  }

  body{
    margin:0;
    padding:0;
    background:#fff;
    font-family: Consolas, "Courier New", monospace;
    font-size:12px;
  }

  /* üî• OCULTAR TODO */
  body *{
    display:none !important;
  }

  /* ‚úÖ SOLO TEXTO PURO */
  #detalleTexto{
    display:block !important;
    white-space:pre;
    line-height:1.25;
    margin:0;
    padding:0;
  }
}

/* oculto en pantalla */
#detalleTexto{ display:none; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const qs = (n) => new URLSearchParams(location.search).get(n);

const W = 40;
const line = () => "-".repeat(W) + "\n";
const center = (s) => {
  s = String(s ?? "");
  if (s.length >= W) return s.slice(0,W) + "\n";
  return " ".repeat(Math.floor((W-s.length)/2)) + s + "\n";
};
const cut = (s,n)=>String(s??"").replace(/\s+/g," ").trim().slice(0,n);
const money = (n)=>"$"+Number(n??0).toFixed(2);

function fmtFecha(iso){
  return new Date(iso).toLocaleString("es-MX",{
    year:"numeric",month:"2-digit",day:"2-digit",
    hour:"2-digit",minute:"2-digit"
  });
}

async function cargar(){
  const id = qs("id");
  const ruta = qs("ruta");

  const ref = doc(db,"almacenes",ruta,"entradas",id);
  const snap = await getDoc(ref);
  const d = snap.data();

  /* ===== PANTALLA ===== */
  folio.textContent=id;
  rutaId.textContent=ruta;
  vendedorId.textContent=d.vendedorId??"";
  vendedorNombre.textContent=d.vendedorNombre??"";
  fecha.textContent=fmtFecha(d.fecha);

  items.innerHTML="";
  (d.items||[]).forEach(it=>{
    items.innerHTML+=`
      <tr>
        <td class="right">${it.cantidad}</td>
        <td>${it.codigo}</td>
        <td>${it.concepto}</td>
        <td class="right">${money(it.precioUnitario??it.precio)}</td>
      </tr>`;
  });

  /* ===== TEXTO PURO ===== */
  let t="";
  t+=center("PROVSOFT");
  t+=center("TRASPASO ENTRE ALMACENES");
  t+=line();
  t+=`Folio : ${id}\n`;
  t+=`Ruta  : ${ruta}\n`;
  t+=`Vende : ${cut(d.vendedorNombre,30)}\n`;
  t+=`Fecha : ${fmtFecha(d.fecha)}\n`;
  t+=line();
  t+=center("DETALLE");
  t+="Cant Codigo      Producto           P.U.\n";
  t+=line();

  (d.items||[]).forEach(it=>{
    t+=`${String(it.cantidad).padStart(3)} ${cut(it.codigo,9).padEnd(9)} ${cut(it.concepto,16).padEnd(16)} ${money(it.precioUnitario??it.precio).padStart(7)}\n`;
  });

  t+=line();
  t+=`ENTREGA: ${cut(d?.firmas?.entrega?.nombre||"‚Äî",30)}\n`;
  t+=`RECIBE : ${cut(d?.firmas?.recibe?.nombre||"‚Äî",30)}\n`;
  t+="FIRMA INGRESADA EN LA BASE DE DATOS\n";
  t+=line();
  t+=center("FIN DEL TICKET");

  detalleTexto.textContent=t;
}

window.addEventListener("DOMContentLoaded",()=>{
  btnPrint.onclick=()=>window.print();
  btnClose.onclick=()=>window.close();
  cargar();
});
</script>
</head>

<body>

<div class="ticket">
  <div class="center h1">PROVSOFT</div>
  <div class="center h2">TRASPASO ENTRE ALMACENES</div>

  <div class="hr"></div>

  <div class="kv"><b>Folio:</b> <span id="folio"></span></div>
  <div class="kv"><b>Ruta:</b> <span id="rutaId"></span></div>
  <div class="kv"><b>Vendedor ID:</b> <span id="vendedorId"></span></div>
  <div class="kv"><b>Vendedor:</b> <span id="vendedorNombre"></span></div>
  <div class="kv"><b>Fecha:</b> <span id="fecha"></span></div>

  <div class="hr"></div>

  <table>
    <thead>
      <tr>
        <th class="right">Cant</th>
        <th>C√≥digo</th>
        <th>Producto</th>
        <th class="right">P.U.</th>
      </tr>
    </thead>
    <tbody id="items"></tbody>
  </table>

  <div class="btns">
    <button class="print" id="btnPrint">IMPRIMIR</button>
    <button class="close" id="btnClose">CERRAR</button>
  </div>
</div>

<!-- üñ®Ô∏è SOLO ESTO SE IMPRIME EN GENERIC -->
<pre id="detalleTexto"></pre>

</body>
</html>
