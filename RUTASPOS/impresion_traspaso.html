<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Impresi√≥n Traspaso ‚Äì PROVSOFT</title>

<style>
:root{
  --paper: 80mm;
  --font: 17px;
}

/* ======================
   PANTALLA (NORMAL)
====================== */
body{
  margin:0;
  padding:20px;
  background:#f1f1f1;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  color:#000;
}

.ticket{
  width: var(--paper);
  background:#fff;
  margin: 25mm auto;
  padding: 16mm 8mm;
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}

.center{ text-align:center; }
.right{ text-align:right; }
.muted{ color:#444; }

.h1{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: 1.2px;
}
.h2{
  font-size: 17px;
  font-weight: 800;
  margin-top: 6px;
}

.hr{
  border-top: 2px dashed #000;
  margin: 16px 0;
}

.kv{
  font-size: var(--font);
  line-height: 1.6;
  margin: 8px 0;
  word-break: break-word;
}
.kv b{ font-weight:900; }

table{
  width:100%;
  border-collapse:collapse;
  font-size: 16px;
  line-height:1.6;
}
th, td{
  padding: 8px 0;
  vertical-align:top;
}
th{
  font-weight:900;
  border-bottom:2px solid #000;
}
td{
  border-bottom:1px dotted #999;
}

/* BOTONES */
.btns{
  width: var(--paper);
  margin: 18px auto 0;
  display:flex;
  gap:14px;
  justify-content:center;
}
button{
  padding:14px 18px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
}
.print{ background:#0c6cbd; color:#fff; }
.close{ background:#ddd; color:#111; }

/* ===============================
   üñ®Ô∏è IMPRESI√ìN: MODO TEXTO REAL
   (Generic / Text Only)
=============================== */
@media print {

  @page{
    size: auto;
    margin: 0;
  }

  body{
    margin:0;
    padding:0;
    background:#fff;
    font-family: Consolas, "Courier New", monospace;
    font-size: 12px;
    color:#000;
  }

  .ticket{
    width: 40ch;     /* ancho fijo en caracteres */
    margin: 0;
    padding: 0;
    box-shadow:none;
  }

  /* en Generic: fuera tablas y estilos "bonitos" */
  table, thead, tbody, tr, td, th{
    display:none !important;
  }

  .h1, .h2{
    font-size: 14px;
    letter-spacing: 0;
  }

  .hr{
    border-top: 1px dashed #000;
    margin: 6px 0;
  }

  /* el ticket en texto S√ç se imprime */
  #detalleTexto{
    display:block !important;
    white-space: pre;
    font-family: Consolas, "Courier New", monospace;
    font-size: 12px;
    line-height: 1.25;
    margin: 0;
  }

  .btns{
    display:none !important;
  }
}

/* por defecto (pantalla): el pre oculto */
#detalleTexto{
  display:none;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const qs = (n) => new URLSearchParams(location.search).get(n);

function fmtFecha(iso){
  const d = new Date(iso);
  return d.toLocaleString("es-MX",{
    year:"numeric",month:"2-digit",day:"2-digit",
    hour:"2-digit",minute:"2-digit"
  });
}

// helpers para ticket texto
const W = 40; // ancho en caracteres (debe empatar con 40ch)
const line = (ch='-') => ch.repeat(W) + "\n";
const center = (s) => {
  s = String(s ?? "");
  if (s.length >= W) return s.slice(0, W) + "\n";
  const left = Math.floor((W - s.length)/2);
  return " ".repeat(left) + s + "\n";
};
const cut = (s, n) => String(s ?? "").replace(/\s+/g,' ').trim().slice(0, n);
const money = (n) => {
  const v = Number(n ?? 0);
  return "$" + v.toFixed(2);
};

async function cargar(){
  const id = qs("id");
  const ruta = qs("ruta");

  const ref = doc(db, "almacenes", ruta, "entradas", id);
  const snap = await getDoc(ref);
  const data = snap.data();

  // ====== HTML "bonito" (pantalla) ======
  document.getElementById("folio").textContent = id;
  document.getElementById("rutaId").textContent = ruta;
  document.getElementById("vendedorId").textContent = data.vendedorId ?? "";
  document.getElementById("vendedorNombre").textContent = data.vendedorNombre ?? "";
  document.getElementById("fecha").textContent = fmtFecha(data.fecha);

  document.getElementById("entregaNombreTxt").textContent =
    data?.firmas?.entrega?.nombre || "‚Äî";
  document.getElementById("recibeNombreTxt").textContent =
    data?.firmas?.recibe?.nombre || "‚Äî";

  const tbody = document.getElementById("items");
  tbody.innerHTML = "";
  (data.items || []).forEach(it=>{
    const precio = Number(it.precioUnitario ?? it.precio ?? 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="right">${it.cantidad ?? ""}</td>
      <td>${it.codigo ?? ""}</td>
      <td>${it.concepto ?? ""}</td>
      <td class="right">${money(precio)}</td>
    `;
    tbody.appendChild(tr);
  });

  // ====== TEXTO PARA GENERIC / Text Only ======
  let txt = "";
  txt += center("PROVSOFT");
  txt += center("TRASPASO ENTRE ALMACENES");
  txt += line("-");

  txt += `Folio: ${id}\n`;
  txt += `Ruta : ${ruta}\n`;
  txt += `VendID: ${cut(data.vendedorId ?? "", 32)}\n`;
  txt += `Vende : ${cut(data.vendedorNombre ?? "", 32)}\n`;
  txt += `Fecha : ${fmtFecha(data.fecha)}\n`;
  txt += line("-");

  txt += center("DETALLE");
  txt += "Cant Codigo      Producto           P.U.\n";
  txt += line("-");

  (data.items || []).forEach(it=>{
    const cant = String(it.cantidad ?? "").padStart(4);
    const cod  = cut(it.codigo ?? "", 10).padEnd(10);
    const prod = cut(it.concepto ?? "", 18).padEnd(18);
    const pu   = money(it.precioUnitario ?? it.precio ?? 0).padStart(8);
    txt += `${cant} ${cod} ${prod} ${pu}\n`;

    // si quieres segunda l√≠nea para completar nombre largo:
    const resto = String(it.concepto ?? "").replace(/\s+/g,' ').trim().slice(18);
    if (resto) txt += `     ${"".padEnd(10)} ${cut(resto, 18)}\n`;
  });

  txt += line("-");
  txt += `ENTREGA: ${cut(data?.firmas?.entrega?.nombre || "‚Äî", 30)}\n`;
  txt += `RECIBE : ${cut(data?.firmas?.recibe?.nombre || "‚Äî", 30)}\n`;
  txt += "FIRMA INGRESADA EN LA BASE DE DATOS\n";
  txt += line("-");
  txt += center("FIN DEL TICKET");

  document.getElementById("detalleTexto").textContent = txt;
}

window.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("btnPrint").onclick=()=>window.print();
  document.getElementById("btnClose").onclick=()=>window.close();
  cargar();
});
</script>
</head>

<body>

<div class="ticket">
  <!-- ===== Vista Bonita (pantalla / drivers buenos) ===== -->
  <div class="center h1">PROVSOFT</div>
  <div class="center h2">TRASPASO ENTRE ALMACENES</div>

  <div class="hr"></div>

  <div class="kv"><b>Folio:</b> <span id="folio"></span></div>
  <div class="kv"><b>Ruta:</b> <span id="rutaId"></span></div>
  <div class="kv"><b>Vendedor ID:</b> <span id="vendedorId"></span></div>
  <div class="kv"><b>Vendedor:</b> <span id="vendedorNombre"></span></div>
  <div class="kv"><b>Fecha:</b> <span id="fecha"></span></div>

  <div class="hr"></div>

  <div class="center h2">DETALLE</div>
  <table>
    <thead>
      <tr>
        <th class="right">Cant</th>
        <th>C√≥digo</th>
        <th>Producto</th>
        <th class="right">P.U.</th>
      </tr>
    </thead>
    <tbody id="items"></tbody>
  </table>

  <div class="hr"></div>

  <div class="kv"><b>ENTREGA:</b> <span id="entregaNombreTxt"></span></div>
  <div class="kv"><b>RECIBE:</b> <span id="recibeNombreTxt"></span></div>

  <div class="center muted" style="margin-top:10px;">
    FIRMA INGRESADA EN LA BASE DE DATOS
  </div>

  <div class="hr"></div>

  <div class="center muted">‚Äî FIN DEL TICKET ‚Äî</div>

  <!-- ===== TEXTO PARA GENERIC (solo imprime) ===== -->
  <pre id="detalleTexto"></pre>

  <div class="btns">
    <button class="print" id="btnPrint">IMPRIMIR</button>
    <button class="close" id="btnClose">CERRAR</button>
  </div>
</div>

</body>
</html>
