<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nuevo Pedido ‚Äì PDD</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0;padding:20px}
.card{max-width:900px;margin:auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 3px 12px rgba(0,0,0,.08)}
label{display:block;margin-top:14px;font-weight:bold}
select,input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-top:6px}
textarea{min-height:80px}
button{margin-top:18px;padding:12px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
button:disabled{opacity:.6}
.msg{margin-top:14px;font-weight:bold}
.muted{color:#666;font-size:13px;margin-top:6px}

.dropzone{
  margin-top:8px;
  padding:28px;
  border:2px dashed #bbb;
  border-radius:12px;
  text-align:center;
  cursor:pointer;
  transition:.15s;
  background:#fafafa;
  user-select:none;
}
.dropzone.dragover{border-color:#111;background:#f0f0f0}
.fileList{margin-top:10px;font-size:14px}
.fileItem{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
.fileItem small{color:#777}
.fileItem button{
  padding:6px 10px;border-radius:10px;border:0;background:#e9e9e9;cursor:pointer
}
.fileItem button:hover{background:#dedede}
.progress{margin-top:10px}
progress{width:100%}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background:#f2f2f2;border:1px solid #e2e2e2;border-radius:8px;padding:2px 6px}
</style>
</head>
<body>

<div class="card">
  <h2>Nuevo Pedido</h2>

  <label>Proveedor</label>
  <select id="proveedor">
    <option value="">Cargando proveedores...</option>
  </select>

  <label>Fecha</label>
  <input type="date" id="fecha">

  <label>Notas</label>
  <textarea id="notas" placeholder="Notas del pedido..."></textarea>

  <label>Estatus</label>
  <select id="estatus">
    <option value="PENDIENTE">PENDIENTE</option>
    <option value="SURTIDO">SURTIDO</option>
    <option value="CANCELADO">CANCELADO</option>
  </select>

  <label>Archivos del Pedido</label>
  <div id="dropzone" class="dropzone">
    Arrastra archivos aqu√≠, haz clic o pega imagen con <span class="kbd">Ctrl + V</span><br>
    <div class="muted">Tip: <span class="kbd">Win + Shift + S</span> (recorte), luego vuelve aqu√≠ y <span class="kbd">Ctrl + V</span></div>
    <input type="file" id="files" multiple hidden>
  </div>

  <div id="fileList" class="fileList"></div>

  <div class="progress" id="progressBox" style="display:none">
    <progress id="pg" value="0" max="100"></progress>
    <div class="muted" id="pgText"></div>
  </div>

  <button id="guardar">Guardar Pedido</button>

  <div class="msg" id="msg"></div>
</div>

<script>
// ================= CONFIG =================
const SUPABASE_URL = "https://cvpbtjlupswbyxenugpz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY";
const BUCKET = "pedidospdd";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);

function setMsg(text, ok=true){
  $("msg").textContent = text;
  $("msg").style.color = ok ? "#1b7f35" : "#b00020";
}

// ================= FECHA AUTO =================
const now = new Date();
$("fecha").value = now.toISOString().split("T")[0];

// ================= CARGAR PROVEEDORES (UNIQUE) =================
async function cargarProveedores(){
  const { data, error } = await sb
    .from("deuda_limpia_pdd")
    .select("razon_social_emisor")
    .order("razon_social_emisor", { ascending:true });

  if(error){
    console.error(error);
    $("proveedor").innerHTML = "<option>Error cargando proveedores</option>";
    return;
  }

  const unicos = [...new Set((data||[]).map(x => (x.razon_social_emisor||"").trim()).filter(Boolean))];

  $("proveedor").innerHTML =
    "<option value=''>Seleccionar proveedor</option>" +
    unicos.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
}
cargarProveedores();

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

// ================= DROPEADOR + PASTE =================
const dropzone = $("dropzone");
const fileInput = $("files");
const fileList = $("fileList");

let archivosSeleccionados = [];

dropzone.addEventListener("click", ()=> fileInput.click());

fileInput.addEventListener("change", (e)=>{
  archivosSeleccionados = [...archivosSeleccionados, ...Array.from(e.target.files || [])];
  renderFiles();
  // reset para permitir re-seleccionar el mismo archivo
  fileInput.value = "";
});

dropzone.addEventListener("dragover", (e)=>{
  e.preventDefault();
  dropzone.classList.add("dragover");
});
dropzone.addEventListener("dragleave", ()=>{
  dropzone.classList.remove("dragover");
});
dropzone.addEventListener("drop", (e)=>{
  e.preventDefault();
  dropzone.classList.remove("dragover");
  const droppedFiles = Array.from(e.dataTransfer.files || []);
  archivosSeleccionados = [...archivosSeleccionados, ...droppedFiles];
  renderFiles();
});

// Pegar im√°genes (Win+Shift+S -> Ctrl+V)
document.addEventListener("paste", (event) => {
  const items = event.clipboardData?.items || [];
  let added = 0;

  for (let item of items) {
    if (item.type && item.type.indexOf("image") !== -1) {
      const blob = item.getAsFile();
      if(!blob) continue;

      const timestamp = Date.now();
      const file = new File([blob], `recorte_${timestamp}.png`, { type: blob.type || "image/png" });

      archivosSeleccionados.push(file);
      added++;
    }
  }

  if(added>0){
    renderFiles();
    setMsg(`üìã Imagen pegada: ${added} archivo(s) listo(s) para subir.`, true);
  }
});

function humanSize(bytes){
  const u = ["B","KB","MB","GB"];
  let i=0, n=bytes;
  while(n>=1024 && i<u.length-1){ n/=1024; i++; }
  return `${n.toFixed(i===0?0:1)} ${u[i]}`;
}

function renderFiles(){
  if(archivosSeleccionados.length===0){
    fileList.innerHTML = `<div class="muted">Sin archivos todav√≠a.</div>`;
    return;
  }

  fileList.innerHTML = archivosSeleccionados.map((f, idx)=>`
    <div class="fileItem">
      <div>
        <div>${escapeHtml(f.name)}</div>
        <small>${humanSize(f.size || 0)}</small>
      </div>
      <button type="button" onclick="removeFile(${idx})">Quitar</button>
    </div>
  `).join("");
}

window.removeFile = function(i){
  archivosSeleccionados.splice(i,1);
  renderFiles();
};

// inicial
renderFiles();

// ================= SUBIR ARCHIVOS =================
function safeName(name){
  return String(name).replace(/[^\w.\-() ]/g, "_");
}

async function uploadAll(pedidoId, files){
  if(!files || files.length===0) return;

  $("progressBox").style.display = "block";
  $("pg").value = 0;

  for(let i=0;i<files.length;i++){
    const file = files[i];
    const path = `${pedidoId}/${Date.now()}_${safeName(file.name)}`;

    $("pgText").textContent = `Subiendo ${i+1}/${files.length}: ${file.name}`;

    const { error } = await sb.storage.from(BUCKET).upload(path, file, {
      upsert: false,
      contentType: file.type || "application/octet-stream"
    });

    if(error) throw error;

    $("pg").value = Math.round(((i+1)/files.length)*100);
  }

  $("pgText").textContent = `Subida completa (${files.length} archivo(s)).`;
}

// ================= GUARDAR PEDIDO =================
$("guardar").addEventListener("click", async ()=>{
  $("guardar").disabled = true;
  setMsg("Guardando...", true);

  try{
    const proveedor_nombre = $("proveedor").value;
    const pedido_fecha = $("fecha").value;
    const notas = $("notas").value || null;
    const estatus = $("estatus").value;

    if(!proveedor_nombre) throw new Error("Selecciona proveedor");
    if(!pedido_fecha) throw new Error("Selecciona fecha");

    // 1) Crear pedido
    const { data, error } = await sb
      .from("pedidos_pdd")
      .insert([{
        proveedor_nombre,
        pedido_fecha,
        notas,
        estatus
      }])
      .select("id")
      .single();

    if(error) throw error;

    const pedidoId = data.id;

    // 2) Subir archivos (drag/drop/paste)
    await uploadAll(pedidoId, archivosSeleccionados);

    // 3) Guardar bucket_path l√≥gico
    const { error: e2 } = await sb
      .from("pedidos_pdd")
      .update({ bucket_path: `pedidospdd/${pedidoId}/` })
      .eq("id", pedidoId);

    if(e2) throw e2;

    setMsg(`‚úÖ Pedido creado: ${pedidoId}`, true);

    // reset formulario (opcional)
    $("notas").value = "";
    $("estatus").value = "PENDIENTE";
    archivosSeleccionados = [];
    renderFiles();
    $("progressBox").style.display = "none";

    $("guardar").disabled = false;

  }catch(err){
    console.error(err);
    setMsg("‚ùå " + (err.message || err), false);
    $("guardar").disabled = false;
  }
});
</script>

</body>
</html>