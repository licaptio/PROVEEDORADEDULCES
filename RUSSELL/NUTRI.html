<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Teórico – Nutri Leche</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{font-family:Arial;background:#f4f6f9;padding:20px}
    .card{background:#fff;padding:20px;border-radius:12px;margin-bottom:18px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .blink{animation:blink 1s infinite}
    @keyframes blink{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e7e7e7;text-align:center}
    th{background:#fafafa}
    .alerta{font-size:22px;margin-left:10px}
    .small{font-size:12px;color:#666;margin-top:6px}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .kpi{min-width:180px}
  </style>
</head>

<body>

  <div class="card">
    <h2 style="margin:0 0 10px 0;">LECHE NUTRI LECHE 1 LTO (23703)</h2>

    <div class="row">
      <div class="kpi"><strong>Base:</strong> <span id="base">—</span></div>
      <div class="kpi"><strong>Mínimo:</strong> <span id="minimo">—</span></div>
      <div class="kpi"><strong>Fijación:</strong> <span id="fijacionFecha">—</span></div>
    </div>

    <h3 style="margin:14px 0 0 0;">
      Teórico: <span id="teorico">—</span>
      <span id="icono" class="alerta">⚠</span>
    </h3>

    <div class="small" id="debug">—</div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Salidas detectadas</h3>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Folio</th>
          <th>Almacén</th>
          <th>Cantidad</th>
          <th>Restante</th>
        </tr>
      </thead>
      <tbody id="tablaEventos"></tbody>
    </table>
  </div>

<script type="module">

import { firebaseConfig, supabaseUrl, supabaseAnonKey } from './config.js'
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"
import { getFirestore, collection, query, where, orderBy, getDocs } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"

const CODIGO = "7501020540666"

const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: { persistSession:false }
})

const fbApp = initializeApp(firebaseConfig)
const db = getFirestore(fbApp)

let inventarioBase = 0
let inventarioTeorico = 0
let nivelAlerta = 0
let fechaFijacion = new Date(0)

const $ = (id) => document.getElementById(id)

function toDateSafe(v){
  if (!v) return null
  if (typeof v?.toDate === "function") return v.toDate()
  const d = new Date(v)
  return isNaN(d.getTime()) ? null : d
}

function normalizeProductos(p){
  if (!p) return []
  if (Array.isArray(p)) return p
  if (typeof p === "object") return Object.values(p)
  if (typeof p === "string"){
    try { return JSON.parse(p) } catch { return [] }
  }
  return []
}

function verificarAlerta(){
  const icono = $("icono")
  if (inventarioTeorico <= nivelAlerta){
    icono.classList.add("blink")
    icono.style.color = "red"
  }else{
    icono.classList.remove("blink")
    icono.style.color = "green"
  }
}

async function cargarFijacionActiva(){

  const { data, error } = await supabase
    .from("movimientos_inventario")
    .select("timestamp,nivel_alerta,productos")
    .eq("tipo","FIJACION")
    .eq("activa", true)
    .order("timestamp", { ascending:false })

  if (error || !data || data.length === 0){
    alert("No hay fijación activa")
    return false
  }

  let fijacion = null
  let producto = null

  for (const f of data){
    const lista = normalizeProductos(f.productos)
    const encontrado = lista.find(p => String(p.codigo) === CODIGO)
    if (encontrado){
      fijacion = f
      producto = encontrado
      break
    }
  }

  if (!producto){
    alert("La fijación activa no contiene este artículo")
    return false
  }

  inventarioBase = Number(producto.cantidad || 0)
  inventarioTeorico = inventarioBase
  nivelAlerta = Number(fijacion.nivel_alerta || 0)
  fechaFijacion = toDateSafe(fijacion.timestamp) || new Date(0)

  $("base").innerText = inventarioBase
  $("minimo").innerText = nivelAlerta
  $("teorico").innerText = inventarioTeorico
  $("fijacionFecha").innerText = fechaFijacion.toLocaleString()

  verificarAlerta()
  return true
}

async function reconstruirSalidasFirestore(){

  const sources = [
    { almacen:"Almacen_Dulces",   col: collection(db, "almacenes", "Almacen_Dulces", "salidas") },
    { almacen:"Almacen_Liquidos", col: collection(db, "almacenes", "Almacen_Liquidos", "salidas") }
  ]

  let eventos = []

  for (const src of sources){

    const q = query(
      src.col,
      where("timestamp", ">=", fechaFijacion),
      orderBy("timestamp")
    )

    const snap = await getDocs(q)

    snap.forEach(docSnap => {

      const data = docSnap.data()
      if (!data.productos) return

      const lista = normalizeProductos(data.productos)
      const prod = lista.find(p => String(p.codigo) === CODIGO)
      if (!prod) return

      eventos.push({
        fecha: data.timestamp.toDate(),
        folio: data.folio || "",
        cantidad: Number(prod.cantidad || 0),
        almacen: src.almacen
      })
    })
  }

  eventos.sort((a,b) => a.fecha - b.fecha)

  const tbody = $("tablaEventos")
  tbody.innerHTML = ""

  inventarioTeorico = inventarioBase

  for (const ev of eventos){
    inventarioTeorico -= ev.cantidad

    tbody.innerHTML += `
      <tr>
        <td>${ev.fecha.toLocaleString()}</td>
        <td>${ev.folio}</td>
        <td>${ev.almacen}</td>
        <td>${ev.cantidad}</td>
        <td>${inventarioTeorico}</td>
      </tr>
    `
  }

  $("teorico").innerText = inventarioTeorico
  verificarAlerta()
}

const ok = await cargarFijacionActiva()
if (ok){
  await reconstruirSalidasFirestore()
}

</script>

</body>
</html>
