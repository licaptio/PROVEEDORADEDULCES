<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Teórico – Nutri Leche</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.blink{animation:blink 1s infinite}
@keyframes blink{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:center}
.alerta{font-size:22px;margin-left:10px}
.small{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>

<div class="card">
  <h2>LECHE NUTRI LECHE 1 LTO (23703)</h2>
  <p><strong>Base:</strong> <span id="base">—</span></p>
  <p><strong>Mínimo:</strong> <span id="minimo">—</span></p>
  <h3>
    Teórico: <span id="teorico">—</span>
    <span id="icono" class="alerta">⚠</span>
  </h3>
  <div class="small" id="debug">—</div>
</div>

<div class="card">
  <h3>Salidas detectadas</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Folio</th>
        <th>Cantidad</th>
        <th>Restante</th>
      </tr>
    </thead>
    <tbody id="tablaEventos"></tbody>
  </table>
</div>

<script type="module">
import { firebaseConfig, supabaseUrl, supabaseAnonKey } from './config.js'
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"

const CODIGO = "7501020540666"

const supabase = createClient(supabaseUrl, supabaseAnonKey)
const app = initializeApp(firebaseConfig)
const db = getFirestore(app)

let inventarioBase = 0
let inventarioTeorico = 0
let nivelAlerta = 0
let fechaFijacion = null

function parseProductosField(productosField){
  if (Array.isArray(productosField)) return productosField
  if (productosField && typeof productosField === "object") return productosField
  if (typeof productosField === "string") {
    try { return JSON.parse(productosField) } catch { return [] }
  }
  return []
}

function toDateSafe(v){
  if (!v) return null
  if (v?.toDate) return v.toDate()        // Firestore Timestamp
  if (v instanceof Date) return v
  const d = new Date(v)
  return isNaN(d.getTime()) ? null : d
}

function setDebug(msg){
  document.getElementById("debug").innerText = msg
}

// 1) Cargar fijación activa (base + mínimo)
async function cargarFijacion(){
  const { data, error } = await supabase
    .from("movimientos_inventario")
    .select("id,timestamp,nivel_alerta,productos")
    .eq("tipo","FIJACION")
    .eq("activa",true)
    .order("timestamp", { ascending: false })
    .limit(1)

  if(error){
    console.error(error)
    alert("Error leyendo fijación")
    return false
  }

  if(!data || data.length === 0){
    alert("No hay fijación activa")
    return false
  }

  const fijacion = data[0]
  const productos = parseProductosField(fijacion.productos)

  let producto = null
  if (Array.isArray(productos)) {
    producto = productos.find(p => String(p.codigo).trim() === CODIGO.trim())
  } else if (productos && typeof productos === "object") {
    producto = productos[CODIGO] || null
  }

  if(!producto){
    alert("La fijación activa NO contiene este artículo")
    return false
  }

  inventarioBase = Number(producto.cantidad || 0)
  inventarioTeorico = inventarioBase
  nivelAlerta = Number(fijacion.nivel_alerta || 0)

  fechaFijacion = toDateSafe(fijacion.timestamp) || new Date(0)

  document.getElementById("base").innerText = inventarioBase
  document.getElementById("minimo").innerText = nivelAlerta
  document.getElementById("teorico").innerText = inventarioTeorico

  setDebug(`Fijación: ${fechaFijacion.toLocaleString()} | SKU: ${CODIGO}`)
  verificarAlerta()
  return true
}

// 2) Reconstruir salidas posteriores a la fijación
async function reconstruirSalidas(){
  const colecciones = [
    { nombre: "Almacen_Dulces", ref: collection(db, "almacenes", "Almacen_Dulces", "salidas") },
    { nombre: "Almacen_Liquidos", ref: collection(db, "almacenes", "Almacen_Liquidos", "salidas") }
  ]

  let eventos = []
  let docsLeidos = 0
  let matchesSku = 0
  let matchesDespues = 0

  for(const c of colecciones){
    const snapshot = await getDocs(c.ref)
    docsLeidos += snapshot.size

    snapshot.forEach(docSnap => {
      const data = docSnap.data()
      if(!data || !data.productos) return

      const lista = Array.isArray(data.productos) ? data.productos : []
      const prod = lista.find(p => String(p.codigo).trim() === CODIGO.trim())
      if(!prod) return
      matchesSku++

      // ✅ USAR timestamp REAL (no "fecha" string)
      const fechaSalida = toDateSafe(data.timestamp)
      if(!fechaSalida) return

      if(fechaSalida < fechaFijacion) return
      matchesDespues++

      eventos.push({
        fecha: fechaSalida,
        folio: data.folio || "",
        cantidad: Number(prod.cantidad || 0),
        almacen: c.nombre
      })
    })
  }

  eventos.sort((a,b) => a.fecha - b.fecha)

  const tabla = document.getElementById("tablaEventos")
  tabla.innerHTML = ""

  inventarioTeorico = inventarioBase

  for(const ev of eventos){
    inventarioTeorico -= ev.cantidad

    tabla.innerHTML += `
      <tr>
        <td>${ev.fecha.toLocaleString()}</td>
        <td>${ev.folio} <span class="small">(${ev.almacen})</span></td>
        <td>${ev.cantidad}</td>
        <td>${inventarioTeorico}</td>
      </tr>
    `
  }

  document.getElementById("teorico").innerText = inventarioTeorico
  setDebug(`Docs leídos: ${docsLeidos} | Con SKU: ${matchesSku} | >= Fijación: ${matchesDespues} | Eventos: ${eventos.length}`)
  verificarAlerta()
}

// 3) Alerta visual
function verificarAlerta(){
  const icono = document.getElementById("icono")
  if(inventarioTeorico <= nivelAlerta){
    icono.classList.add("blink")
    icono.style.color = "red"
  }else{
    icono.classList.remove("blink")
    icono.style.color = "green"
  }
}

// Init
const ok = await cargarFijacion()
if(ok){
  await reconstruirSalidas()
}
</script>

</body>
</html>
