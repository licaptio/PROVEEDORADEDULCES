<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Teórico – Nutri Leche</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --orange:#ff7a00;
      --orange-dark:#e66300;
      --orange-soft:#fff4ea;
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
    }

    body{
      font-family:'Segoe UI', Arial, sans-serif;
      background:var(--bg);
      margin:0;
      padding:15px;
      color:var(--text);
    }

    .card{
      background:var(--card);
      padding:18px;
      border-radius:18px;
      margin-bottom:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }

    h2{
      margin:0 0 12px 0;
      font-size:22px;
      font-weight:700;
      color:var(--orange-dark);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .kpi{
      flex:1;
      min-width:120px;
      background:var(--orange-soft);
      padding:10px;
      border-radius:12px;
      font-size:14px;
    }

    .kpi strong{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi span{
      font-weight:600;
      font-size:16px;
    }

    h3{ margin:16px 0 6px 0; }

    #teorico{
      font-size:26px;
      font-weight:700;
      color:var(--orange-dark);
      line-height:1.25;
    }

    .alerta{
      font-size:22px;
      margin-left:8px;
    }

    .blink{ animation:blink 1s infinite; }
    @keyframes blink{ 0%{opacity:1}50%{opacity:.2}100%{opacity:1} }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    thead{
      background:var(--orange);
      color:#fff;
    }

    th,td{
      padding:8px;
      text-align:center;
    }

    tbody tr:nth-child(even){ background:#fafafa; }

    .small{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }

    .empty{
      padding:14px;
      color:var(--muted);
      text-align:center;
    }

    @media(max-width:600px){
      body{padding:10px}
      h2{font-size:20px}
      #teorico{font-size:22px}
      th,td{padding:6px;font-size:12px}
    }
  </style>
</head>

<body>

  <div class="card">
    <h2>LECHE NUTRI LECHE 1 LTO (23703)</h2>

    <div class="row">
      <div class="kpi"><strong>Base</strong><span id="base">—</span></div>
      <div class="kpi"><strong>Mínimo</strong><span id="minimo">—</span></div>
      <div class="kpi"><strong>Fijación</strong><span id="fijacionFecha">—</span></div>
    </div>

    <h3>
      Teórico: <span id="teorico">—</span>
      <span id="icono" class="alerta">⚠</span>
    </h3>

    <div class="small" id="debug">—</div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Salidas detectadas</h3>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Folio</th>
          <th>Almacén</th>
          <th>Cantidad</th>
          <th>Restante</th>
        </tr>
      </thead>
      <tbody id="tablaEventos"></tbody>
    </table>
  </div>

  <script type="module">
    import { firebaseConfig, supabaseUrl, supabaseAnonKey } from './config.js'
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"
    import {
      getFirestore, collection, query, where, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"

    /* =========================
       CONFIG
       ========================= */
    const CODIGO = "7501020540666"
    const PIEZAS_POR_CAJA = 12
    const CAJAS_POR_TARIMA = 90

    /* =========================
       INIT CLIENTS
       ========================= */
    const supabase = createClient(supabaseUrl, supabaseAnonKey, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    })

    const fbApp = initializeApp(firebaseConfig)
    const db = getFirestore(fbApp)

    /* =========================
       STATE
       ========================= */
    let inventarioBase = 0
    let inventarioTeorico = 0
    let nivelAlerta = 0
    let fechaFijacion = new Date(0)

    const $ = (id) => document.getElementById(id)
    const setDebug = (msg) => $("debug").innerText = msg

    function toDateSafe(v){
      if (!v) return null
      if (typeof v?.toDate === "function") return v.toDate()
      const d = new Date(v)
      return isNaN(d.getTime()) ? null : d
    }

    function normalizeProductos(p){
      if (!p) return []
      if (Array.isArray(p)) return p
      if (typeof p === "object") return Object.values(p)
      if (typeof p === "string"){
        try{
          const parsed = JSON.parse(p)
          return Array.isArray(parsed) ? parsed : (parsed && typeof parsed === "object" ? Object.values(parsed) : [])
        }catch{ return [] }
      }
      return []
    }

    function verificarAlerta(){
      const icono = $("icono")
      if (inventarioTeorico <= nivelAlerta){
        icono.classList.add("blink")
        icono.style.color = "red"
      }else{
        icono.classList.remove("blink")
        icono.style.color = "green"
      }
    }

    function pintarTeorico(){
      const piezas = inventarioTeorico

      const cajasEnteras = Math.floor(piezas / PIEZAS_POR_CAJA)
      const piezasSueltas = ((piezas % PIEZAS_POR_CAJA) + PIEZAS_POR_CAJA) % PIEZAS_POR_CAJA

      const tarimasEnteras = Math.floor(cajasEnteras / CAJAS_POR_TARIMA)
      const cajasSueltas = ((cajasEnteras % CAJAS_POR_TARIMA) + CAJAS_POR_TARIMA) % CAJAS_POR_TARIMA

      $("teorico").innerHTML = `
        ${piezas.toLocaleString()} PZAS<br>
        ${cajasEnteras} CAJAS (${piezasSueltas} SUELTAS)<br>
        ${tarimasEnteras} TARIMAS (${cajasSueltas} CAJAS)
      `
    }

    /* =========================
       1) FIJACIÓN (SUPABASE)
       ========================= */
    async function cargarFijacionActiva(){
      const { data, error } = await supabase
        .from("movimientos_inventario")
        .select("timestamp,nivel_alerta,productos")
        .eq("tipo","FIJACION")
        .eq("activa", true)
        .order("timestamp", { ascending:false })
        .limit(50)

      if (error) throw error
      if (!data || data.length === 0) throw new Error("No hay fijación activa")

      let fijacion = null
      let producto = null

      for (const f of data){
        const lista = normalizeProductos(f.productos)
        const encontrado = lista.find(p => String(p?.codigo ?? p?.id ?? "").trim() === String(CODIGO).trim())
        if (encontrado){
          fijacion = f
          producto = encontrado
          break
        }
      }

      if (!producto) throw new Error("La fijación activa no contiene este artículo")

      inventarioBase = Number(producto.cantidad || 0)
      inventarioTeorico = inventarioBase
      nivelAlerta = Number(fijacion.nivel_alerta || 0)
      fechaFijacion = toDateSafe(fijacion.timestamp) || new Date(0)

      $("base").innerText = inventarioBase
      $("minimo").innerText = nivelAlerta
      $("fijacionFecha").innerText = fechaFijacion.toLocaleString()

      pintarTeorico()
      verificarAlerta()

      return true
    }

    /* =========================
       2) SALIDAS (FIRESTORE)
       ========================= */
    async function reconstruirSalidasFirestore(){
      const sources = [
        { almacen:"Almacen_Dulces",   col: collection(db, "almacenes", "Almacen_Dulces", "salidas") },
        { almacen:"Almacen_Liquidos", col: collection(db, "almacenes", "Almacen_Liquidos", "salidas") }
      ]

      let eventos = []

      for (const src of sources){
        const q = query(
          src.col,
          where("timestamp", ">=", fechaFijacion),
          orderBy("timestamp")
        )

        const snap = await getDocs(q)

        snap.forEach(docSnap => {
          const data = docSnap.data()
          if (!data?.productos) return

          const lista = normalizeProductos(data.productos)
          const prod = lista.find(p => String(p?.codigo ?? p?.id ?? "").trim() === String(CODIGO).trim())
          if (!prod) return

          const fecha = toDateSafe(data.timestamp)
          if (!fecha) return

          eventos.push({
            fecha,
            folio: data.folio || "",
            cantidad: Number(prod.cantidad || 0),
            almacen: src.almacen
          })
        })
      }

      eventos.sort((a,b) => a.fecha - b.fecha)

      const tbody = $("tablaEventos")
      tbody.innerHTML = ""

      inventarioTeorico = inventarioBase

      if (eventos.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="5">Sin salidas desde la fijación.</td></tr>`
        pintarTeorico()
        verificarAlerta()
        setDebug("OK: 0 salidas")
        return
      }

      for (const ev of eventos){
        inventarioTeorico -= ev.cantidad

        tbody.innerHTML += `
          <tr>
            <td>${ev.fecha.toLocaleString()}</td>
            <td>${ev.folio}</td>
            <td>${ev.almacen}</td>
            <td>${ev.cantidad}</td>
            <td>${inventarioTeorico}</td>
          </tr>
        `
      }

      pintarTeorico()
      verificarAlerta()
      setDebug(`OK: ${eventos.length} salidas`)
    }

    /* =========================
       RUN
       ========================= */
    try{
      setDebug("Cargando fijación…")
      await cargarFijacionActiva()
      setDebug("Leyendo salidas…")
      await reconstruirSalidasFirestore()
    }catch(err){
      console.error(err)
      alert(err?.message || "Error")
      setDebug("Error. Revisa consola.")
    }
  </script>

</body>
</html>
