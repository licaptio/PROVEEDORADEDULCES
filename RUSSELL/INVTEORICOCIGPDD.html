<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>Saldo Actual – Cigarros</title>

<style>
:root{
  --color:#00416A;
  --bg:#f2f4f7;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  -webkit-font-smoothing:antialiased;
}

header{
  background:var(--color);
  color:white;
  text-align:center;
  padding:14px;
  font-weight:700;
  font-size:16px;
}

#lista{
  padding:10px;
}

.card{
  background:white;
  border-radius:14px;
  padding:14px;
  margin-bottom:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.nombre{
  font-size:14px;
  font-weight:600;
  max-width:70%;
}

.saldo{
  font-size:18px;
  font-weight:800;
}

.pos{ color:#0a7a0a; }
.neg{ color:#c01616; }
.cero{ color:#666; }
</style>
</head>

<body>

<header>Saldo Actual – Cigarros</header>
<div id="lista"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain:"inventariopv-643f1.firebaseapp.com",
  projectId:"inventariopv-643f1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const norm=c=>(c||"").toString().trim().padStart(12,"0");

let productos={},entradas={},salidas={},iniciales={};
let ready=false;

const $lista=document.getElementById("lista");

// PRODUCTOS
getDocs(collection(db,"productos")).then(s=>{
  s.forEach(d=>{
    const x=d.data();
    if(x.activo!==true||x.departamento!=="CIGARROS") return;

    productos[norm(x.codigoBarra||x.productoId)] = {
      desc:x.descripcion||"-"
    };
  });
  ready=true;
  dibujar();
});

// ENTRADAS
onSnapshot(collection(db,"almacenes/almacen_cigarro/entradas"),s=>{
  entradas={};
  s.forEach(d=>{
    (d.data().items||[]).forEach(i=>{
      const c=norm(i.productoId||i.codigo);
      entradas[c]=(entradas[c]||0)+Number(i.cantidadTotal||0);
    });
  });
  dibujar();
});

// SALIDAS
onSnapshot(collection(db,"almacenes/almacen_cigarro/salidas1.0"),s=>{
  salidas={};
  s.forEach(d=>{
    (d.data().productos||[]).forEach(i=>{
      const c=norm(i.codigo);
      salidas[c]=(salidas[c]||0)+Number(i.cantidad||0);
    });
  });
  dibujar();
});

// INVENTARIO BASE
onSnapshot(collection(db,"almacenes/almacen_cigarro/inventario_base"),s=>{
  iniciales={};
  s.forEach(d=>{
    iniciales[norm(d.id)] = Number(d.data().existencia||0);
  });
  dibujar();
});

// DIBUJAR
function dibujar(){
  if(!ready) return;

  let html="";

  for(const c in productos){
    const p=productos[c];
    const ini=iniciales[c]||0;
    const ent=entradas[c]||0;
    const sal=salidas[c]||0;
    const act=ini+ent-sal;

    let clase="cero";
    if(act>0) clase="pos";
    if(act<0) clase="neg";

    html+=`
      <div class="card">
        <div class="nombre">${p.desc}</div>
        <div class="saldo ${clase}">${act}</div>
      </div>
    `;
  }

  $lista.innerHTML=html;
}
</script>

</body>
</html>
