<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario Teórico – Aceite Kartamus</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.blink{animation:blink 1s infinite}
@keyframes blink{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:center}
.alerta{font-size:22px;margin-left:10px}
.small{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>

<div class="card">
  <h2>ACEITE KARTAMUS 900 ML</h2>
  <p><strong>Base:</strong> <span id="base">—</span></p>
  <p><strong>Mínimo:</strong> <span id="minimo">—</span></p>
  <h3>
    Teórico: <span id="teorico">—</span>
    <span id="icono" class="alerta">⚠</span>
  </h3>
  <div class="small" id="debug">—</div>
</div>

<div class="card">
  <h3>Salidas detectadas</h3>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Folio</th>
        <th>Cantidad</th>
        <th>Restante</th>
      </tr>
    </thead>
    <tbody id="tablaEventos"></tbody>
  </table>
</div>

<script type="module">
import { firebaseConfig, supabaseUrl, supabaseAnonKey } from './config.js'
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"

const CODIGO = "7501048102501"

const supabase = createClient(supabaseUrl, supabaseAnonKey)
const app = initializeApp(firebaseConfig)
const db = getFirestore(app)

let inventarioBase = 0
let inventarioTeorico = 0
let nivelAlerta = 0
let fechaFijacion = null

function parseProductosField(productosField){
  if (!productosField) return []
  if (Array.isArray(productosField)) return productosField
  if (typeof productosField === "string") {
    try {
      const parsed = JSON.parse(productosField)
      return Array.isArray(parsed) ? parsed : []
    } catch {
      return []
    }
  }
  return []
}

function toDateSafe(v){
  if (!v) return null
  if (v?.toDate) return v.toDate()
  if (v instanceof Date) return v
  const d = new Date(v)
  return isNaN(d.getTime()) ? null : d
}

function setDebug(msg){
  document.getElementById("debug").innerText = msg
}

async function cargarFijacion(){

  const { data, error } = await supabase
    .from("movimientos_inventario")
    .select("id,timestamp,nivel_alerta,productos,activa")
    .eq("tipo","FIJACION")
    .order("timestamp", { ascending: false })

  if(error){
    console.error(error)
    alert("Error leyendo fijaciones")
    return false
  }

  if(!data || data.length === 0){
    alert("No hay fijaciones registradas")
    return false
  }

  let fijacion = null
  let producto = null

  for(const f of data){
    const lista = parseProductosField(f.productos)
    const encontrado = lista.find(p =>
      String(p.codigo).trim() === CODIGO.trim()
    )
    if(encontrado){
      fijacion = f
      producto = encontrado
      break
    }
  }

  if(!producto){
    alert("No existe fijación para este artículo")
    return false
  }

  inventarioBase = Number(producto.cantidad || 0)
  inventarioTeorico = inventarioBase
  nivelAlerta = Number(fijacion.nivel_alerta || 0)
  fechaFijacion = toDateSafe(fijacion.timestamp) || new Date(0)

  document.getElementById("base").innerText = inventarioBase
  document.getElementById("minimo").innerText = nivelAlerta
  document.getElementById("teorico").innerText = inventarioTeorico

  setDebug(`Fijación usada: ${fechaFijacion.toLocaleString()} | Activa: ${fijacion.activa}`)
  verificarAlerta()

  return true
}

async function reconstruirSalidas(){

  const colecciones = [
    { nombre: "Almacen_Dulces", ref: collection(db, "almacenes", "Almacen_Dulces", "salidas") },
    { nombre: "Almacen_Liquidos", ref: collection(db, "almacenes", "Almacen_Liquidos", "salidas") }
  ]

  let eventos = []

  for(const c of colecciones){
    const snapshot = await getDocs(c.ref)

    snapshot.forEach(docSnap => {
      const data = docSnap.data()
      if(!data || !data.productos) return

      const lista = Array.isArray(data.productos) ? data.productos : []
      const prod = lista.find(p =>
        String(p.codigo).trim() === CODIGO.trim()
      )
      if(!prod) return

      const fechaSalida = toDateSafe(data.timestamp)
      if(!fechaSalida) return
      if(fechaSalida < fechaFijacion) return

      eventos.push({
        fecha: fechaSalida,
        folio: data.folio || "",
        cantidad: Number(prod.cantidad || 0)
      })
    })
  }

  eventos.sort((a,b) => a.fecha - b.fecha)

  const tabla = document.getElementById("tablaEventos")
  tabla.innerHTML = ""

  inventarioTeorico = inventarioBase

  for(const ev of eventos){
    inventarioTeorico -= ev.cantidad

    tabla.innerHTML += `
      <tr>
        <td>${ev.fecha.toLocaleString()}</td>
        <td>${ev.folio}</td>
        <td>${ev.cantidad}</td>
        <td>${inventarioTeorico}</td>
      </tr>
    `
  }

  document.getElementById("teorico").innerText = inventarioTeorico
  verificarAlerta()
}

function verificarAlerta(){
  const icono = document.getElementById("icono")
  if(inventarioTeorico <= nivelAlerta){
    icono.classList.add("blink")
    icono.style.color = "red"
  }else{
    icono.classList.remove("blink")
    icono.style.color = "green"
  }
}

const ok = await cargarFijacion()
if(ok){
  await reconstruirSalidas()
}
</script>

</body>
</html>
