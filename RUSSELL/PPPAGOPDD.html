<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Prontos Pagos - Proveedores Fijos</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:Arial;
  background:#f4f4f4;
  padding:20px;
  margin:0;
}
h2{margin-top:0}

.cardProveedor{
  background:#fff;
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}

.headerProveedor{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.kpi{
  text-align:right;
  line-height:1.25;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  padding:8px;
  border:1px solid #ccc;
  font-size:0.85em;
}
th{
  background:#007bff;
  color:#fff;
}
td.numero{text-align:right}

.sinFacturas{
  padding:10px;
  color:#777;
}

.vencido{
  border:2px solid #c82333;
  animation:parpadeo 1s infinite;
}

.diasAlto{ color:#c82333; font-weight:bold; }

.btn-pagar{
  width:22px;
  height:22px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  background-color:#28a745;
}
.btn-pagar:disabled{ background-color:#6c757d; }

@keyframes parpadeo{
  0%{ box-shadow:0 0 5px rgba(200,35,51,.7); }
  50%{ box-shadow:0 0 18px rgba(200,35,51,.95); }
  100%{ box-shadow:0 0 5px rgba(200,35,51,.7); }
}

@media (max-width: 768px){
  body{ padding:10px; }
  th,td{ font-size:0.9em; }
  .btn-pagar{ width:28px; height:28px; }
}
</style>
</head>
<body>

<h2>⚡ Prontos Pagos - Proveedores Fijos</h2>

<div id="tabla"></div>

<script type="module">
import { supabaseUrl, supabaseAnonKey } from './config.js';

const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

/* =========================
   PRONTOS PAGOS (FIJOS)
   nombre_proveedor : días_límite
   ========================= */
const proveedoresProntoPago = {
  "CANEL'S": 18,
  "DISTRIBUIDORA DE DULCES DEL NORTE": 27,
  "DUPAQ DE MEXICO": 17,
  "DISTRIBUIDORA DE LA ROSA": 13
};

function fechaYMD(v){
  return v ? String(v).split("T")[0] : "";
}

function calcularDias(fechaStr){
  if(!fechaStr) return 0;
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  const [y,m,d] = fechaYMD(fechaStr).split("-").map(Number);
  if(!y || !m || !d) return 0;
  const f = new Date(y, m-1, d); f.setHours(0,0,0,0);
  return Math.floor((hoy - f) / 86400000);
}

function proveedorReal(f){
  return (f.proveedor && f.proveedor.trim() !== "")
    ? f.proveedor.trim()
    : (f.razon_social_emisor || "").trim();
}

/* Normaliza para que no te rompan espacios raros (NBSP) / dobles espacios */
function normName(s){
  return String(s || "")
    .replace(/\u00A0/g, " ")     // NBSP -> espacio normal
    .replace(/\s+/g, " ")       // colapsa espacios
    .trim()
    .toUpperCase();
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeJs(s){
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

async function cargar(){

  const { data, error } = await supabase
    .from("v_deuda_proveedores")
    .select("*")
    .neq("factura_pagada","SI");

  if(error){
    console.error(error);
    alert("Error cargando datos");
    return;
  }

  // index por nombre normalizado
  const idx = new Map(Object.keys(proveedoresProntoPago).map(n => [normName(n), n]));

  const contenedor = document.getElementById("tabla");
  contenedor.innerHTML = "";

  for(const proveedorOriginal of Object.keys(proveedoresProntoPago)){

    const limite = proveedoresProntoPago[proveedorOriginal];
    const key = normName(proveedorOriginal);

    const facturas = (data || []).filter(f=>{
      const pr = proveedorReal(f);
      return idx.has(normName(pr)) && normName(pr) === key;
    });

    let totalProveedor = 0;
    let diasMayor = 0;

    for(const f of facturas){
      const dias = calcularDias(f.fecha);
      if(dias > diasMayor) diasMayor = dias;
      totalProveedor += (parseFloat(f.total)||0);
    }

    const vencidoPor = diasMayor - limite;
    const estaVencido = vencidoPor > 0;

    let html = `
      <div class="cardProveedor ${estaVencido ? 'vencido' : ''}">
        <div class="headerProveedor">
          <div>
            <strong>${escapeHtml(proveedorOriginal)}</strong><br>
            Límite pronto pago: <strong>${limite}</strong> días
          </div>
          <div class="kpi">
            Facturas: <strong>${facturas.length}</strong><br>
            Total: <strong>$${totalProveedor.toLocaleString("es-MX",{minimumFractionDigits:2})}</strong><br>
            Mayor antigüedad:
            <span class="${diasMayor > limite ? 'diasAlto' : ''}">
              <strong>${diasMayor}</strong> días
            </span><br>
            ${
              estaVencido
                ? `<span class="diasAlto">Vencido por ${vencidoPor} días</span>`
                : `<span style="color:#0a6c21;font-weight:bold;">En tiempo</span>`
            }
          </div>
        </div>
    `;

    if(facturas.length === 0){
      html += `<div class="sinFacturas">Sin facturas pendientes</div>`;
    } else {

      html += `
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Días</th>
              <th>UUID</th>
              <th>Total</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
      `;

      // Orden: más viejas arriba (más días primero)
      facturas.sort((a,b)=> calcularDias(b.fecha) - calcularDias(a.fecha));

      for(const f of facturas){
        const dias = calcularDias(f.fecha);

        html += `
          <tr>
            <td>${fechaYMD(f.fecha)}</td>
            <td class="${dias > limite ? 'diasAlto' : ''}">${dias}</td>
            <td style="font-size:0.75em">${escapeHtml(f.uuid_cfdi || "")}</td>
            <td class="numero">${Number(f.total||0).toLocaleString("es-MX",{minimumFractionDigits:2})}</td>
            <td style="text-align:center">
              <button class="btn-pagar" title="Marcar como pagada"
                onclick="marcarPagada('${escapeJs(f.uuid_cfdi || "")}', this)">
              </button>
            </td>
          </tr>
        `;
      }

      html += `</tbody></table>`;
    }

    html += `</div>`;
    contenedor.insertAdjacentHTML("beforeend", html);
  }
}

// Botón TANOS (misma tabla destino)
window.marcarPagada = async function(uuid, boton){
  if(!uuid){ alert("UUID vacío"); return; }

  const fila = boton.closest("tr");
  const card = boton.closest(".cardProveedor");

  boton.disabled = true;
  boton.style.backgroundColor = "#6c757d";

  const { error } = await supabase
    .from("deuda_limpia_pdd")
    .update({ factura_pagada:"SI" })
    .eq("uuid_cfdi", uuid);

  if(error){
    console.error(error);
    alert("❌ Error al marcar como pagada");
    boton.disabled = false;
    boton.style.backgroundColor = "#28a745";
    return;
  }

  fila.style.background="#e8f5e9";
  fila.style.transition="all .8s ease";

  setTimeout(()=>{
    fila.style.opacity="0";
    fila.style.transform="scale(.92)";
    setTimeout(()=>{
      fila.remove();
      // Más simple: recargar todo para recalcular KPIs y vencimientos
      cargar();
    }, 800);
  }, 700);
};

cargar();
</script>

</body>
</html>
