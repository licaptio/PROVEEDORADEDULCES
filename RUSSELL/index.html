<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>Saldo Actual – Cigarros</title>

<style>
:root{
  --color:#00416A;
  --bg:#f2f4f7;
}

html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
}

header{
  background:var(--color);
  color:white;
  padding:14px;
  font-weight:700;
  font-size:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header button{
  background:white;
  color:var(--color);
  border:none;
  padding:6px 12px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

#lista{
  padding:10px;
}

.card{
  background:white;
  border-radius:14px;
  padding:14px;
  margin-bottom:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.nombre{
  font-size:14px;
  font-weight:600;
  max-width:70%;
}

.saldo{
  font-size:18px;
  font-weight:800;
}

.pos{ color:#0a7a0a; }
.neg{ color:#c01616; }
.cero{ color:#666; }
</style>
</head>

<body>

<header>
  <span>Saldo Actual – Cigarros</span>
  <button onclick="location.reload()">Refrescar</button>
</header>

<div id="lista">Cargando...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain:"inventariopv-643f1.firebaseapp.com",
  projectId:"inventariopv-643f1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const norm=c=>(c||"").toString().trim().padStart(12,"0");

async function cargar(){

  const productosSnap = await getDocs(collection(db,"productos"));
  const entradasSnap = await getDocs(collection(db,"almacenes/almacen_cigarro/entradas"));
  const salidasSnap = await getDocs(collection(db,"almacenes/almacen_cigarro/salidas1.0"));
  const baseSnap = await getDocs(collection(db,"almacenes/almacen_cigarro/inventario_base"));

  let productos={},entradas={},salidas={},iniciales={};

  productosSnap.forEach(d=>{
    const x=d.data();
    if(x.activo!==true||x.departamento!=="CIGARROS") return;
    productos[norm(x.codigoBarra||x.productoId)] = x.descripcion||"-";
  });

  entradasSnap.forEach(d=>{
    (d.data().items||[]).forEach(i=>{
      const c=norm(i.productoId||i.codigo);
      entradas[c]=(entradas[c]||0)+Number(i.cantidadTotal||0);
    });
  });

  salidasSnap.forEach(d=>{
    (d.data().productos||[]).forEach(i=>{
      const c=norm(i.codigo);
      salidas[c]=(salidas[c]||0)+Number(i.cantidad||0);
    });
  });

  baseSnap.forEach(d=>{
    iniciales[norm(d.id)] = Number(d.data().existencia||0);
  });

  dibujar(productos,entradas,salidas,iniciales);
}

function dibujar(productos,entradas,salidas,iniciales){

  let html="";

  for(const c in productos){

    const ini=iniciales[c]||0;
    const ent=entradas[c]||0;
    const sal=salidas[c]||0;
    const act=ini+ent-sal;

    let clase="cero";
    if(act>0) clase="pos";
    if(act<0) clase="neg";

    html+=`
      <div class="card">
        <div class="nombre">${productos[c]}</div>
        <div class="saldo ${clase}">${act}</div>
      </div>
    `;
  }

  document.getElementById("lista").innerHTML=html||"Sin datos";
}

cargar();
</script>

</body>
</html>
