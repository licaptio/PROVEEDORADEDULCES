<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Monitor Ventas Ruta</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; margin:20px; }
h1 { margin-bottom: 12px; }

.topbar{
  margin-bottom:15px;
}

input[type="date"]{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}

.card{
  background:#fff;
  padding:12px;
  margin-bottom:10px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.total{
  font-size:18px;
  font-weight:bold;
  color:#0c6cbd;
}

.badge{
  display:inline-block;
  padding:3px 8px;
  font-size:12px;
  border-radius:12px;
  background:#e8edf7;
  margin-left:6px;
}
</style>
</head>
<body>

<h1>Ventas Ruta</h1>

<div class="topbar">
  <input type="date" id="selector" />
</div>

<div id="lista"></div>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, query, where, orderBy, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const lista = document.getElementById("lista");
const selector = document.getElementById("selector");

let unsub = null;

// Fecha hoy por defecto
const hoy = new Date();
selector.value = hoy.toISOString().split("T")[0];

function inicioFinDelDia(fechaISO){
  const inicio = new Date(`${fechaISO}T00:00:00`);
  const fin = new Date(`${fechaISO}T23:59:59.999`);
  return { inicio, fin };
}

function escucharDia(fechaISO){

  if (typeof unsub === "function") unsub();

  const { inicio, fin } = inicioFinDelDia(fechaISO);

  const q = query(
    collection(db, "ventas_rutav2"),
    where("fecha", ">=", inicio),
    where("fecha", "<=", fin),
    orderBy("fecha", "desc")
  );

  unsub = onSnapshot(q, (snapshot) => {

    lista.innerHTML = "";

    snapshot.forEach(doc => {

      const data = doc.data();
      const lineas = (data.detalle || []).length;

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div><strong>Folio:</strong> ${data.folio || "-"}</div>
        <div><strong>Cliente:</strong> ${data.cliente || "-"}</div>
        <div><strong>Usuario:</strong> ${data.usuarioNombre || "-"}</div>
        <div class="total">$ ${Number(data.resumen_financiero?.total || 0).toLocaleString()}</div>
        <div>
          Utilidad: $ ${Number(data.resumen_financiero?.utilidad_total || 0).toLocaleString()}
          <span class="badge">${data.resumen_financiero?.margen_porcentaje || 0}%</span>
        </div>
        <div>LÃ­neas: ${lineas}</div>
        <div>${data.fecha_txt || ""}</div>
        <div>
          ${data.cortado ? "<span class='badge' style='background:#c8f7c5;'>CORTADO</span>" : ""}
        </div>
      `;

      lista.appendChild(card);
    });

  });

}

selector.addEventListener("change", () => {
  escucharDia(selector.value);
});

escucharDia(selector.value);

</script>

</body>
</html>
