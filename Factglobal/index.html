<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PROVSOFT Â· Factura Global Diaria</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f2f2f2; }
button { padding: 10px 16px; font-size: 14px; cursor: pointer; }
</style>
</head>

<body>

<h2>ðŸ§¾ PROVSOFT Â· Factura Global Diaria</h2>

<label>ðŸ“… Fecha:</label><br>
<input type="date" id="fecha"><br><br>

<button onclick="cargarVentas()">Cargar ventas</button>

<p>
  Tickets: <b id="cnt">0</b> |
  Total: <b>$<span id="total">0.00</span></b>
</p>

<table>
<thead>
<tr>
  <th>Hora</th>
  <th>Cliente</th>
  <th>Total</th>
  <th>âœ”</th>
</tr>
</thead>
<tbody id="ventas"></tbody>
</table>

<br>

<input type="checkbox" id="confirmo">
<label>Confirmo cierre fiscal</label>

<br><br>

<button onclick="generarTXT()">GENERAR TXT GLOBAL</button>

<script>
/* ======================================================
   CONFIGURACIÃ“N FIREBASE (AJUSTA AQUÃ)
   ====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

// ðŸ”¥ ESTA LÃNEA ES OBLIGATORIA
firebase.initializeApp(firebaseConfig);

// ðŸ”¥ AHORA SÃ EXISTE EL APP [DEFAULT]
const db = firebase.firestore();

/* ======================================================
   CONFIG PROVSOFT
   ====================================================== */
const CONFIG = {
  rutaId: "Almacen_Ruta_1",
  serie: "RM1"
};

const FISCAL_EMISOR = {
  rfc: "PDD031204KL5",
  razon: "PROVEEDORA DE DULCES Y DESECHABLES",
  regimen: "601",
  cpExpedicion: "67700",
  certificado: "00001000000716399644",
  direccion: "MADERO 690 CENTRO LINARES NUEVO LEON MEXICO"
};


let ventasCache = [];
let ventaSeleccionadaId = null;

/* ======================================================
   UTILIDADES
   ====================================================== */
const r2 = n => Math.round((n + Number.EPSILON) * 100) / 100;

/* ======================================================
   FECHA
   ====================================================== */
function rangoDia() {
  const f = document.getElementById("fecha").value;
  if (!f) return null;
  return {
    inicio: new Date(f + "T00:00:00"),
    fin: new Date(f + "T23:59:59")
  };
}

/* ======================================================
   CARGAR VENTAS
   ====================================================== */
async function cargarVentas() {

  const rango = rangoDia();
  if (!rango) return alert("Selecciona fecha");

const Timestamp = firebase.firestore.Timestamp;
const snap = await db.collection("ventas_rutav2")
  .where("rutaId", "==", CONFIG.rutaId)
  .where("fecha", ">=", Timestamp.fromDate(rango.inicio))
  .where("fecha", "<=", Timestamp.fromDate(rango.fin))
  .get();


  ventasCache = [];
  snap.forEach(d => ventasCache.push({ id: d.id, ...d.data() }));
  console.log("Ventas:", ventasCache);

  pintarVentas(ventasCache);

  document.getElementById("cnt").innerText = ventasCache.length;
  document.getElementById("total").innerText =
    ventasCache.reduce((s,v)=>s+Number(v.resumen_financiero?.total||0),0).toFixed(2);
}

/* ======================================================
   PINTAR TABLA
   ====================================================== */
function pintarVentas(ventas) {

  const tbody = document.getElementById("ventas");
  tbody.innerHTML = "";

  ventas.forEach(v => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.fecha.toDate().toLocaleTimeString()}</td>
      <td>${v.cliente || "-"}</td>
      <td>$${Number(v.resumen_financiero.total).toFixed(2)}</td>
      <td><input type="radio" name="venta" value="${v.id}"></td>
    `;
    tr.querySelector("input").onchange = e => {
      ventaSeleccionadaId = e.target.value;
      console.log("âœ” Venta:", ventaSeleccionadaId);
    };
    tbody.appendChild(tr);
  });
}

/* ======================================================
   GENERAR TXT GLOBAL (PRUEBA UNA VENTA)
   ====================================================== */
function generarTXT() {

  if (!document.getElementById("confirmo").checked)
    return alert("Confirma cierre fiscal");

  if (!ventasCache.length)
    return alert("No hay ventas cargadas");

  /* ===============================
     UTILIDADES
     =============================== */
  const r2 = n => Math.round((Number(n) + Number.EPSILON) * 100) / 100;

  /* ===============================
     ACUMULADORES
     =============================== */
  const grupos = {};            // registros 03
  const impuestosGlobales = {}; // registros 04

  let subtotalGlobal = 0;
  let totalGlobal = 0;
  let impuestosGlobal = 0;

  /* ===============================
     RECORRER VENTAS
     =============================== */
  ventasCache.forEach(v => {

    const rf = v.resumen_financiero || {};

    const base16   = r2(rf.base_iva_16   || 0);
    const iva16    = r2(rf.iva_16        || 0);
    const base0    = r2(rf.base_iva_0    || 0);
    const baseIEPS = r2(rf.base_ieps_8   || 0);
    const ieps     = r2(rf.ieps_8        || 0);

    const baseTotalVenta = base16 + base0 + baseIEPS;

    if (baseTotalVenta <= 0) return;

    subtotalGlobal += baseTotalVenta;
    impuestosGlobal += iva16 + ieps;

    /* ===============================
       FIRMA FISCAL
       =============================== */
    let firma = "IVA0";
    if (base16 > 0 && baseIEPS > 0) firma = "IVA16+IEPS8";
    else if (base16 > 0) firma = "IVA16";
    else if (baseIEPS > 0) firma = "IEPS8";

    if (!grupos[firma]) {
      grupos[firma] = {
        baseTotal: 0,
        impuestos: []
      };
    }

    grupos[firma].baseTotal += baseTotalVenta;

    /* ===============================
       IMPUESTOS POR CONCEPTO (03-IMP)
       =============================== */
    if (base16 > 0) {
      grupos[firma].impuestos.push({
        impuesto: "002",
        tasa: 0.16,
        base: base16,
        importe: iva16
      });
      acumularImpuestoGlobal("002", 0.16, base16, iva16);
    }

    if (base0 > 0) {
      grupos[firma].impuestos.push({
        impuesto: "002",
        tasa: 0.00,
        base: base0,
        importe: 0
      });
      acumularImpuestoGlobal("002", 0.00, base0, 0);
    }

    if (baseIEPS > 0) {
      grupos[firma].impuestos.push({
        impuesto: "003",
        tasa: 0.08,
        base: baseIEPS,
        importe: ieps
      });
      acumularImpuestoGlobal("003", 0.08, baseIEPS, ieps);
    }

  });

  totalGlobal = r2(subtotalGlobal + impuestosGlobal);

  /* ===============================
     FUNCIÃ“N REGISTRO 04
     =============================== */
  function acumularImpuestoGlobal(impuesto, tasa, base, importe) {
    const key = impuesto + "_" + tasa;
    if (!impuestosGlobales[key]) {
      impuestosGlobales[key] = {
        impuesto,
        tasa,
        base: 0,
        importe: 0
      };
    }
    impuestosGlobales[key].base += base;
    impuestosGlobales[key].importe += importe;
  }

  /* ===============================
     FOLIO
     =============================== */
  const folio = String(Date.now()).slice(-6);

  const lineas = [];

  /* ===============================
     REGISTRO 01
     =============================== */
  lineas.push([
    "01","FA","4.0",CONFIG.serie,folio,"01",
    FISCAL_EMISOR.certificado,"CONTADO",
    r2(subtotalGlobal).toFixed(2),"0.00","MXN","1",
    r2(totalGlobal).toFixed(2),"Ingreso","PUE","67700","",
    "EMISOR",FISCAL_EMISOR.rfc,FISCAL_EMISOR.razon,FISCAL_EMISOR.regimen,
    "RECEPTOR","XAXX010101000","PUBLICO EN GENERAL","","","S01","","",
    r2(impuestosGlobal).toFixed(2),
    "INFO_ADIC","","","","","N"
  ].join("|"));

  /* ===============================
     REGISTROS 03 y 03-IMP
     =============================== */
  let n = 1;
  for (const firma in grupos) {
    const g = grupos[firma];
    lineas.push([
      "03",n,"1.000","ACT","","01010101",
      folio + n,"Venta",
      r2(g.baseTotal).toFixed(6),
      "0.00",
      r2(g.baseTotal).toFixed(6),
      "","02"
    ].join("|"));

    g.impuestos.forEach(imp => {
      lineas.push([
        "03-IMP","TRASLADO",
        r2(imp.base).toFixed(6),
        imp.impuesto,
        "Tasa",
        imp.tasa.toFixed(6),
        r2(imp.importe).toFixed(6)
      ].join("|"));
    });
    n++;
  }

  /* ===============================
     REGISTROS 04
     =============================== */
  for (const k in impuestosGlobales) {
    const ig = impuestosGlobales[k];
    lineas.push([
      "04","TRASLADO",
      ig.impuesto,
      "Tasa",
      ig.tasa.toFixed(6),
      r2(ig.importe).toFixed(2),
      r2(ig.base).toFixed(2)
    ].join("|"));
  }

  /* ===============================
     DESCARGA
     =============================== */
  descargar(lineas.join("\n"), `CFDI_GLOBAL_${CONFIG.serie}_${folio}.txt`);
  alert("âœ… TXT GLOBAL SIFEI generado correctamente");
}


/* ======================================================
   DESCARGA
   ====================================================== */
function descargar(txt, nombre) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([txt], {type:"text/plain"}));
  a.download = nombre;
  a.click();
}
</script>
</body>
</html>



