<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PROVSOFT Â· Factura Global Diaria</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f2f2f2; }
button { padding: 10px 16px; font-size: 14px; cursor: pointer; }
</style>
</head>

<body>

<h2>ðŸ§¾ PROVSOFT Â· Factura Global Diaria</h2>

<label>ðŸ“… Fecha:</label><br>
<input type="date" id="fecha"><br><br>

<button onclick="cargarVentas()">Cargar ventas</button>

<p>
  Tickets: <b id="cnt">0</b> |
  Total: <b>$<span id="total">0.00</span></b>
</p>

<table>
<thead>
<tr>
  <th>Hora</th>
  <th>Cliente</th>
  <th>Total</th>
  <th>âœ”</th>
</tr>
</thead>
<tbody id="ventas"></tbody>
</table>

<br>

<input type="checkbox" id="confirmo">
<label>Confirmo cierre fiscal</label>

<br><br>

<button onclick="generarTXT()">GENERAR TXT GLOBAL</button>

<script>
/* ======================================================
   CONFIGURACIÃ“N FIREBASE (AJUSTA AQUÃ)
   ====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

// ðŸ”¥ ESTA LÃNEA ES OBLIGATORIA
firebase.initializeApp(firebaseConfig);

// ðŸ”¥ AHORA SÃ EXISTE EL APP [DEFAULT]
const db = firebase.firestore();

/* ======================================================
   CONFIG PROVSOFT
   ====================================================== */
const CONFIG = {
  rutaId: "Almacen_Ruta_1",
  serie: "RM1"
};

const FISCAL_EMISOR = {
rfc: "PDD031204KL5",
  razonSocial: "PROVEEDORA DE DULCES Y DESECHABLES",
  regimenFiscal: "601",
  cpExpedicion: "67700",
  numeroCertificado: "00001000000716399644",
  direccion: "MADERO 690 CENTRO LINARES NUEVO LEON MEXICO"
};

let ventasCache = [];
let ventaSeleccionadaId = null;

/* ======================================================
   UTILIDADES
   ====================================================== */
const r2 = n => Math.round((n + Number.EPSILON) * 100) / 100;

/* ======================================================
   FECHA
   ====================================================== */
function rangoDia() {
  const f = document.getElementById("fecha").value;
  if (!f) return null;
  return {
    inicio: new Date(f + "T00:00:00"),
    fin: new Date(f + "T23:59:59")
  };
}

/* ======================================================
   CARGAR VENTAS
   ====================================================== */
async function cargarVentas() {

  const rango = rangoDia();
  if (!rango) return alert("Selecciona fecha");

const snap = await db.collection("ventas")
  .where("rutaId", "==", CONFIG.rutaId)
  .where("fecha", ">=", Timestamp.fromDate(rango.inicio))
  .where("fecha", "<=", Timestamp.fromDate(rango.fin))
  .get();


  ventasCache = [];
  snap.forEach(d => ventasCache.push({ id: d.id, ...d.data() }));

  pintarVentas(ventasCache);

  document.getElementById("cnt").innerText = ventasCache.length;
  document.getElementById("total").innerText =
    ventasCache.reduce((s,v)=>s+Number(v.resumen_financiero?.total||0),0).toFixed(2);
}

/* ======================================================
   PINTAR TABLA
   ====================================================== */
function pintarVentas(ventas) {

  const tbody = document.getElementById("ventas");
  tbody.innerHTML = "";

  ventas.forEach(v => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.fecha.toDate().toLocaleTimeString()}</td>
      <td>${v.cliente || "-"}</td>
      <td>$${Number(v.resumen_financiero.total).toFixed(2)}</td>
      <td><input type="radio" name="venta" value="${v.id}"></td>
    `;
    tr.querySelector("input").onchange = e => {
      ventaSeleccionadaId = e.target.value;
      console.log("âœ” Venta:", ventaSeleccionadaId);
    };
    tbody.appendChild(tr);
  });
}

/* ======================================================
   GENERAR TXT GLOBAL (PRUEBA UNA VENTA)
   ====================================================== */
function generarTXT() {

  if (!ventaSeleccionadaId)
    return alert("Selecciona una venta");

  if (!document.getElementById("confirmo").checked)
    return alert("Confirma cierre fiscal");

  const venta = ventasCache.find(v => v.id === ventaSeleccionadaId);
  if (!venta) return alert("Venta no encontrada");

  const subtotal = r2(venta.resumen_financiero.subtotal);
  const total = r2(venta.resumen_financiero.total);

  const folio = String(Date.now()).slice(-6);

  const txt = [
    [
      "01","FA","4.0",CONFIG.serie,folio,"01",
      FISCAL_EMISOR.certificado,"CONTADO",
      subtotal.toFixed(2),"0.00","MXN","1",
      total.toFixed(2),"Ingreso","PUE","67700","",
      "EMISOR",FISCAL_EMISOR.rfc,FISCAL_EMISOR.razon,FISCAL_EMISOR.regimen,
      "RECEPTOR","XAXX010101000","PUBLICO EN GENERAL","","","S01","","",
      (total-subtotal).toFixed(2),
      "INFO_ADIC","","","","","N"
    ].join("|")
  ].join("\n");

  descargar(txt, `CFDI_GLOBAL_${CONFIG.serie}_${folio}.txt`);
  alert("âœ… TXT generado");
}

/* ======================================================
   DESCARGA
   ====================================================== */
function descargar(txt, nombre) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([txt], {type:"text/plain"}));
  a.download = nombre;
  a.click();
}
</script>
</body>
</html>
