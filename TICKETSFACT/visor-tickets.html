<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PROVSOFT Â· CorrecciÃ³n Factura Global</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#f5f6fa; padding:20px }
table { width:100%; border-collapse:collapse; background:#fff }
th,td { padding:8px; border:1px solid #ddd; text-align:center }
th { background:#eee }
button { padding:6px 10px; cursor:pointer }
.danger { background:#c0392b; color:#fff; border:none }
</style>
</head>

<body>

<h2>ðŸ§¾ CorrecciÃ³n de Factura Global</h2>

<label>ðŸ“… Fecha:</label>
<input type="date" id="fecha">
<button onclick="cargar()">Buscar</button>

<br><br>

<table>
<thead>
<tr>
  <th>Folio</th>
  <th>Total</th>
  <th>Facturada</th>
  <th>AcciÃ³n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<script>
/* ðŸ” Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function cargar() {
  const fecha = document.getElementById('fecha').value;
  if (!fecha) {
    alert('Selecciona fecha');
    return;
  }

  const [y, m, d] = fecha.split('-').map(Number);

const inicio = firebase.firestore.Timestamp.fromDate(
  new Date(y, m - 1, d, 0, 0, 0)
);

const fin = firebase.firestore.Timestamp.fromDate(
  new Date(y, m - 1, d, 23, 59, 59)
);

  const tbody = document.getElementById('tabla');
  tbody.innerHTML = '';

  db.collection('tickets')
    .where('facturada_global', '==', true)
    .where('fecha', '>=', inicio)
    .where('fecha', '<=', fin)
    .orderBy('fecha')   // ðŸ‘ˆ ESTA LÃNEA ES LA CLAVE
    .get()
    .then(snapshot => {
      console.log('docs:', snapshot.size);

      snapshot.forEach(doc => {
        const d = doc.data();
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${d.folio}</td>
          <td>$${d.resumen_financiero.total}</td>
          <td>âœ…</td>
          <td>
            <input type="checkbox" checked
              onchange="toggleFacturada('${doc.id}', this)">
          </td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error('Error query:', err);
    });
}

function toggleFacturada(id, checkbox) {
  if (!confirm('âš ï¸ CONFIRMA que este ticket NO fue timbrado')) {
    checkbox.checked = true;
    return;
  }

  db.collection('tickets').doc(id).update({
    facturada_global: false,
    facturada_at: null,
    serie_fiscal: null,
    folio_fiscal: null,
    correccion_manual: true,
    correccion_at: new Date()
  })
  .then(() => {
    alert('âœ… Ticket corregido');
    cargar();
  })
  .catch(err => {
    console.error('Error update:', err);
    checkbox.checked = true;
  });
}
</script>


</body>
</html>




