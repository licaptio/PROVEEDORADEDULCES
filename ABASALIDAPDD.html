<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salidas Abarrote PDD ‚Äì PROVSOFT</title>

  <!-- ===== SECCI√ìN 1: ESTILOS GLOBALES ===== -->
  <style>
    :root {
      --azul: #00416A;
      --gris: #f5f5f5;
      --blanco: #fff;
      --sombra: rgba(0,0,0,0.15);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--gris);
      margin: 0;
      padding: 0;
    }

    .pantalla {
      display: none;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .activa {
      display: block;
      animation: fade 0.3s ease-in-out;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      color: var(--azul);
      margin-bottom: 20px;
    }

    input, button, textarea, select {
      font-family: inherit;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    button {
      background: var(--azul);
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 10px var(--sombra);
    }

    button:hover {
      background: #033a5a;
    }

    .card {
      background: var(--blanco);
      border-radius: 16px;
      box-shadow: 0 4px 14px var(--sombra);
      padding: 20px;
      max-width: 420px;
      margin: 30px auto;
    }

    .tabla {
      width: 100%;
      border-collapse: collapse;
    }

    .tabla th, .tabla td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .tabla th {
      background: var(--azul);
      color: white;
    }

    canvas {
      border: 2px dashed var(--azul);
      border-radius: 10px;
      display: block;
      margin: 10px auto;
    }
	/* Mejor visualizaci√≥n del carrito en m√≥viles */
.tabla td, .tabla th {
  padding: 6px;
  word-wrap: break-word;
  font-size: 13px;
}

.tabla tr {
  border-bottom: 1px solid #eee;
}

@media (max-width: 480px) {
  .tabla td {
    font-size: 12px;
  }
}
  
  </style>
</head>
<body>

<!-- ==========================================================
     üß± SECCI√ìN 2: LOGIN
=========================================================== -->
<div id="login" class="pantalla activa">
  <div class="card">
    <h2>PROVSOFT ‚Äì Abarrote PDD</h2>
    <input type="text" id="usuario" placeholder="Usuario" autocomplete="off" />
    <input type="password" id="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Entrar</button>
    <p id="mensajeLogin" style="text-align:center;color:red;"></p>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 3: DATOS DE SALIDA
=========================================================== -->
<div id="datosSalida" class="pantalla">
  <div class="card">
    <h2>Datos de salida</h2>
    <label>Usuario:</label>
    <input type="text" id="txtUsuario" readonly>

    <label>Persona que recibe:</label>
    <select id="selectRecibe"></select>

    <label>Destino o direcci√≥n:</label>
    <select id="selectDestino"></select>

    <button id="btnContinuarDatos">Continuar ‚Üí</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 4: CAPTURA DE ART√çCULOS
=========================================================== -->
<div id="captura" class="pantalla">
  <div class="card">
    <h2>Captura de art√≠culos</h2>
	<button id="btnLogout" style="
  background:#b30000;
  color:white;
  font-weight:600;
  border:none;
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
  cursor:pointer;
  width:100%;
">üîí Cerrar sesi√≥n</button>

    <input type="text" id="buscarProd" placeholder="Buscar producto...">

<!-- üîç Esc√°ner con c√°mara -->
<button id="btnActivarCamara" style="
  background:#0a84ff;
  color:white;
  font-weight:600;
  border:none;
  border-radius:10px;
  padding:10px;
  margin-top:6px;
  cursor:pointer;
  width:100%;
">üì∑ Activar c√°mara / Escanear c√≥digo</button>

<video id="previewCamara" width="100%" height="200" autoplay style="
  display:none;
  border-radius:10px;
  margin-top:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
"></video>

<div id="resultadosBusqueda"></div>
    
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 5: REVISI√ìN DEL CARRITO
=========================================================== -->
<div id="carrito" class="pantalla">
  <div class="card">
    <h2>Revisi√≥n del carrito</h2>
    <table class="tabla" id="tablaCarrito">
<thead>
  <tr>
    <th style="width:15%;">Cant.</th>
    <th style="width:25%;">C√≥digo</th>
    <th style="width:45%;">Concepto</th>
    <th style="width:15%;">‚ùå</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
    <h3 id="totalGeneral" style="text-align:right;"></h3>
    <button id="btnRegresarCaptura">‚¨ÖÔ∏è Regresar</button>
    <button id="btnConfirmarSalida">Confirmar salida ‚Üí</button>
  </div>
</div>
<!-- ==========================================================
     üß± SECCI√ìN 6: FIRMAS ‚Äì MODO M√ìVIL CON PASOS
=========================================================== -->
<div id="firmas" class="pantalla">
  <div class="card" id="firmaPaso1">
    <h2>Firma quien recibe</h2>
    <canvas id="canvasRecibe" width="320" height="200" style="
      width: 100%;
      height: 240px;
      background: #fff;
      border: 2px dashed #00416A;
      border-radius: 10px;
      display:block;
      touch-action: none;
    "></canvas>
    <button id="limpiarRecibe" style="background:#666;">üßπ Limpiar firma</button>
    <button id="btnSiguienteFirma">‚û°Ô∏è Siguiente (Encargado)</button>
  </div>

  <div class="card" id="firmaPaso2" style="display:none;">
    <h2>Firma encargado</h2>
    <canvas id="canvasEncargado" width="320" height="200" style="
      width: 100%;
      height: 240px;
      background: #fff;
      border: 2px dashed #00416A;
      border-radius: 10px;
      display:block;
      touch-action: none;
    "></canvas>
    <button id="limpiarEncargado" style="background:#666;">üßπ Limpiar firma</button>
    <button id="btnGuardarSalida" style="background:#00416A;">üíæ Guardar salida</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 7: SCRIPTS DE LA APLICACI√ìN
=========================================================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getFirestore, doc, getDoc, getDocs, addDoc, updateDoc, setDoc, 
  collection, query, where 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// ===== CONFIGURACI√ìN FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== VARIABLES =====
let usuarioActual = null;
let datosSalida = {};
let carrito = [];

// ===== CAMBIO DE PANTALLAS =====
function mostrarPantalla(id) {
  document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}
// ===== FUNCIONES DE SESI√ìN =====
function cerrarSesion() {
  usuarioActual = null;
  datosSalida = {};
  carrito = [];
  renderCarrito();
  actualizarContador();
  localStorage.removeItem('usuarioActual');
  alert("üîí Sesi√≥n cerrada por seguridad");
  mostrarPantalla('login');
}

// Asignar al bot√≥n de cierre manual
document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "btnLogout") {
    cerrarSesion();
  }
});
// ===== AUTO-CIERRE POR INACTIVIDAD =====
let inactividadTimer;

function reiniciarTemporizador() {
  clearTimeout(inactividadTimer);
  inactividadTimer = setTimeout(() => {
    if (usuarioActual) cerrarSesion();
  }, 10 * 60 * 1000); // 10 minutos = 600000 ms
}

// Eventos que reinician el contador
["click", "keypress", "mousemove", "touchstart"].forEach(evt => {
  document.addEventListener(evt, reiniciarTemporizador);
});

reiniciarTemporizador(); // Iniciar al cargar
// =======================================================
// üß± BLOQUE 1: LOGIN
// =======================================================
async function validarUsuario(usuario, password) {
  const snap = await getDocs(collection(db, "usuarios_ruta"));
  let user = null;
  snap.forEach(docu => {
    const data = docu.data();
    if (data.usuario === usuario && data.password === password && data.activo) user = data;
  });
  return user;
}

const usuarioInput = document.getElementById("usuario");
const passwordInput = document.getElementById("password");
const mensajeLogin = document.getElementById("mensajeLogin");
	
document.getElementById('btnLogin').onclick = async () => {
  const usuario = usuarioInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!usuario || !pass) return mensajeLogin.textContent = "Ingresa usuario y contrase√±a";

  const user = await validarUsuario(usuario, pass);
  if (!user) return mensajeLogin.textContent = "Datos incorrectos";

  usuarioActual = { usuario, nombre: user.nombre };
  localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
  document.getElementById('txtUsuario').value = user.nombre;
  await cargarListas();
  mostrarPantalla('datosSalida');
};

// =======================================================
// üß± BLOQUE 2: DATOS DE SALIDA
// =======================================================
const selectRecibe = document.getElementById("selectRecibe");
const selectDestino = document.getElementById("selectDestino");

async function cargarListas() {
  selectRecibe.innerHTML = "<option value=''>Selecciona quien recibe...</option>";
  const snapTrab = await getDocs(collection(db, "trabajadores_proveedora"));
  snapTrab.forEach(docu => {
    const t = docu.data();
    const opt = document.createElement("option");
    opt.value = docu.id;
    opt.textContent = t.nombreCompleto;
    selectRecibe.appendChild(opt);
  });

  selectDestino.innerHTML = "<option value=''>Selecciona destino...</option>";
  const snapDest = await getDocs(collection(db, "destinos"));
  snapDest.forEach(docu => {
    const d = docu.data();
    const opt = document.createElement("option");
    opt.value = docu.id;
    opt.textContent = d.nombre || d.direccion;
    selectDestino.appendChild(opt);
  });
}

// =======================================================
// üß± BLOQUE 2.2: CONTINUAR A CAPTURA DE ART√çCULOS
// =======================================================
document.getElementById('btnContinuarDatos').onclick = async () => {
  const recibeId = selectRecibe.value;
  const destinoId = selectDestino.value;

  if (!recibeId || !destinoId) {
    alert("Selecciona quien recibe y el destino antes de continuar");
    return;
  }

  // Obtener los documentos seleccionados
  const recibeSnap = await getDoc(doc(db, "trabajadores_proveedora", recibeId));
  const destinoSnap = await getDoc(doc(db, "destinos", destinoId));

  const recibeData = recibeSnap.exists() ? recibeSnap.data() : {};
  const destinoData = destinoSnap.exists() ? destinoSnap.data() : {};

  // Guardar los datos de salida
  datosSalida = {
    usuario: usuarioActual.nombre,
    recibeId,
    recibeNombre: recibeData.nombreCompleto || "Sin nombre",
    destinoId,
    destinoNombre: destinoData.nombre || "Sin nombre",
    destinoDireccion: destinoData.direccion || "",
    destinoUbicacion: destinoData.ubicacion || null
  };

  console.log("üì¶ Datos de salida:", datosSalida);
  mostrarPantalla('captura');
};

// ==========================================================
// üß± BLOQUE 3: CAPTURA DE ART√çCULOS (con debounce 400ms)
// ==========================================================
const buscarProd = document.getElementById('buscarProd');
const resultadosDiv = document.getElementById('resultadosBusqueda');
let debounceTimer = null;

buscarProd.addEventListener('input', e => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => buscarProductos(e.target.value.trim().toUpperCase()), 400);
});

async function buscarProductos(texto) {
  resultadosDiv.innerHTML = "";
  if (texto.length < 2) return;

  try {
    const ref = collection(db, "productos");
    const snapshot = await getDocs(
      query(
        ref,
        where("activo", "==", true),
        where("concepto", ">=", texto),
        where("concepto", "<=", texto + "\uf8ff")
      )
    );

    if (snapshot.empty) {
      resultadosDiv.innerHTML = "<p style='color:gray;text-align:center'>Sin coincidencias</p>";
      return;
    }

    snapshot.forEach(docu => {
      const p = docu.data();
      const item = document.createElement('div');
      item.innerHTML = `
        <strong>${p.concepto}</strong><br>
        <small>C√≥digo: ${p.codigoBarra}</small><br>
        <small>Precio: $${p.costoSinImpuesto.toFixed(2)}</small>
      `;
      item.style.padding = "8px";
      item.style.borderBottom = "1px solid #ddd";
      item.style.cursor = "pointer";
      item.onclick = () => agregarAlCarrito(docu.id, p);
      resultadosDiv.appendChild(item);
    });
  } catch (err) {
    console.error("Error al buscar productos:", err);

	  resultadosDiv.innerHTML = "<p style='color:red;text-align:center'>Error al buscar productos</p>";
  }
}

// ==========================================================
// üß± BLOQUE 3.1: ESC√ÅNER CON C√ÅMARA
// ==========================================================
const btnCamara = document.getElementById("btnActivarCamara");
const videoCamara = document.getElementById("previewCamara");
let escaneando = false;
let stream = null;

btnCamara.addEventListener("click", async () => {
  if (escaneando) {
    detenerCamara();
    return;
  }

  try {
    if (!("BarcodeDetector" in window)) {
      alert("‚ö†Ô∏è Tu navegador no soporta detecci√≥n directa de c√≥digos. Usa Chrome o Edge actualizado.");
      return;
    }

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    videoCamara.srcObject = stream;
    videoCamara.style.display = "block";
    escaneando = true;
    btnCamara.textContent = "‚èπÔ∏è Detener c√°mara";

    const detector = new BarcodeDetector({ formats: ["code_128", "ean_13", "ean_8", "upc_a", "upc_e"] });

    const escanear = async () => {
      if (!escaneando) return;
      try {
        const barcodes = await detector.detect(videoCamara);
        if (barcodes.length > 0) {
          const codigoDetectado = barcodes[0].rawValue.trim();
        // üîä Sonido al detectar c√≥digo
function beep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(880, ctx.currentTime); // tono
    g.gain.setValueAtTime(0.1, ctx.currentTime); // volumen
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.15); // duraci√≥n 150 ms
  } catch (e) {
    console.warn("No se pudo reproducir el beep:", e);
  }
}
beep(); // ‚úÖ suena al detectar
  
		detenerCamara();

          buscarProd.value = codigoDetectado;
          await buscarProductos(codigoDetectado);

          // Buscar coincidencia exacta por c√≥digo
          const ref = collection(db, "productos");
          const snap = await getDocs(query(ref, where("codigoBarra", "==", codigoDetectado)));
          if (!snap.empty) {
            const docu = snap.docs[0];
            const p = docu.data();
            agregarAlCarrito(docu.id, p);
          } else {
            alert(`‚ö†Ô∏è No se encontr√≥ el c√≥digo: ${codigoDetectado}`);
          }
        } else {
          requestAnimationFrame(escanear);
        }
      } catch (err) {
        console.error("Error escaneando:", err);
        requestAnimationFrame(escanear);
      }
    };

    escanear();
  } catch (err) {
    console.error("‚ùå Error al acceder a la c√°mara:", err);
    alert("No se pudo acceder a la c√°mara.");
  }
});

function detenerCamara() {
  escaneando = false;
  btnCamara.textContent = "üì∑ Activar c√°mara / Escanear c√≥digo";
  videoCamara.style.display = "none";
  if (stream) {
    const tracks = stream.getTracks();
    tracks.forEach(t => t.stop());
    stream = null;
  }
}

	
// ==========================================================
// üß± BLOQUE 3.2: AGREGAR PRODUCTO AL CARRITO
// ==========================================================
function agregarAlCarrito(id, producto) {
  // Crear modal r√°pido
  const modal = document.createElement('div');
  Object.assign(modal.style, {
    position: 'fixed',
    top: 0, left: 0, right: 0, bottom: 0,
    background: 'rgba(0,0,0,0.4)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 9999
  });

  const caja = document.createElement('div');
  Object.assign(caja.style, {
    background: '#fff',
    borderRadius: '14px',
    padding: '20px',
    width: '90%',
    maxWidth: '320px',
    textAlign: 'center',
    fontFamily: 'Poppins, sans-serif',
    boxShadow: '0 6px 20px rgba(0,0,0,0.25)'
  });

  caja.innerHTML = `
    <h3 style="color:#00416A;margin-bottom:10px;font-size:16px;">${producto.concepto}</h3>
    <label style="font-weight:600;color:#333;">Cantidad:</label><br>
    <input type="number" id="inputCantidad" value="1" min="1" style="
      width:100%;
      padding:10px;
      font-size:18px;
      border-radius:10px;
      border:1px solid #ccc;
      text-align:center;
      margin-top:8px;
      margin-bottom:16px;
    " inputmode="numeric" pattern="[0-9]*" />
    <button id="btnAceptarCant" style="
      background:#00416A;
      color:white;
      border:none;
      border-radius:10px;
      padding:10px 0;
      width:100%;
      font-weight:600;
      cursor:pointer;
    ">Agregar ‚úÖ</button>
    <button id="btnCancelarCant" style="
      background:#bbb;
      color:#111;
      border:none;
      border-radius:10px;
      padding:8px 0;
      width:100%;
      margin-top:8px;
      font-weight:600;
      cursor:pointer;
    ">Cancelar</button>
  `;

  modal.appendChild(caja);
  document.body.appendChild(modal);

  const inputCantidad = caja.querySelector("#inputCantidad");
  inputCantidad.focus();
  inputCantidad.select(); // ‚úÖ selecciona el "1" por defecto

  // Acci√≥n al confirmar
  caja.querySelector("#btnAceptarCant").onclick = () => {
    const cantidad = parseInt(inputCantidad.value);
    if (!cantidad || cantidad <= 0) {
      alert("‚ö†Ô∏è Ingresa una cantidad v√°lida");
      return;
    }

    const existente = carrito.find(p => p.id === id);
    if (existente) {
      existente.cantidad += cantidad;
    } else {
      carrito.push({
        id,
        concepto: producto.concepto,
        costo: producto.costoSinImpuesto || 0,
        cantidad,
        codigoBarra: producto.codigoBarra || ""
      });
    }

    mostrarAvisoFlotante(`‚úÖ ${producto.concepto} (${cantidad}) agregado`);
    buscarProd.value = "";
    resultadosDiv.innerHTML = "";
    actualizarContador();
    modal.remove();
  };

  // Acci√≥n al cancelar
  caja.querySelector("#btnCancelarCant").onclick = () => modal.remove();
}

// ==========================================================
// üß± BLOQUE 3.3: BOT√ìN FLOTANTE DE CARRITO üõí
// ==========================================================
const btnFlotante = document.createElement('button');
btnFlotante.id = "btnFlotanteCarrito";
btnFlotante.innerHTML = "üõí <span id='contadorCarrito'>0</span>";
btnFlotante.style.position = "fixed";
btnFlotante.style.bottom = "24px";
btnFlotante.style.right = "24px";
btnFlotante.style.background = "#00416A";
btnFlotante.style.color = "white";
btnFlotante.style.fontWeight = "600";
btnFlotante.style.border = "none";
btnFlotante.style.borderRadius = "50px";
btnFlotante.style.boxShadow = "0 4px 14px rgba(0,0,0,0.3)";
btnFlotante.style.padding = "12px 18px";
btnFlotante.style.cursor = "pointer";
btnFlotante.style.zIndex = "999";
btnFlotante.style.display = "none";
document.body.appendChild(btnFlotante);

function actualizarContador() {
  const c = document.getElementById('contadorCarrito');
  c.textContent = carrito.reduce((acc, p) => acc + p.cantidad, 0);
  btnFlotante.style.display = carrito.length > 0 ? "block" : "none";
}

// Evento para abrir el carrito
btnFlotante.addEventListener("click", () => {
  renderCarrito();
  mostrarPantalla('carrito');
});

	
// ==========================================================
// üß± BLOQUE 4: REVISI√ìN DE CARRITO
// ==========================================================
const tbody = document.querySelector('#tablaCarrito tbody');
const totalGeneral = document.getElementById('totalGeneral');

function renderCarrito() {
  tbody.innerHTML = "";

  carrito.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:600;">${p.cantidad}</td>
      <td title="${p.codigoBarra}" style="
        max-width:80px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        font-size:13px;
      ">${p.codigoBarra}</td>
      <td title="${p.concepto}" style="
        max-width:160px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        font-size:13px;
        text-align:left;
      ">${p.concepto}</td>
      <td>
        <button onclick="eliminar(${i})"
          style="background:#b30000;
                 border:none;
                 color:white;
                 border-radius:8px;
                 padding:4px 10px;
                 cursor:pointer;
                 font-size:14px;">‚ùå</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  totalGeneral.textContent = ""; // sin total
}

window.editar = (i) => {
  const nueva = prompt("Nueva cantidad:", carrito[i].cantidad);
  if (nueva && !isNaN(nueva) && nueva > 0) {
    carrito[i].cantidad = parseInt(nueva);
    renderCarrito();
  }
};

window.eliminar = (i) => {
  if (confirm("¬øEliminar producto?")) {
    carrito.splice(i, 1);
    renderCarrito();
  }
};

document.getElementById('btnRegresarCaptura').onclick = () => {
  mostrarPantalla('captura');
};

document.getElementById('btnConfirmarSalida').onclick = () => {
  if (carrito.length === 0) return alert("Carrito vac√≠o");
  
  // Primero mostrar la pantalla de firmas
  mostrarPantalla('firmas');
  
  // Asegurar que el paso 1 est√© visible y el 2 oculto
  document.getElementById("firmaPaso1").style.display = "block";
  document.getElementById("firmaPaso2").style.display = "none";
};


function activarDibujo(canvas, ctx) {
  let dibujando = false;

  // Ajuste responsivo
  function ajustarTama√±o() {
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
    canvas.width = w;
    canvas.height = h;
    ctx.putImageData(temp, 0, 0);
  }
  window.addEventListener("resize", ajustarTama√±o);
  ajustarTama√±o();

  // Mouse
  canvas.addEventListener("mousedown", e => {
    dibujando = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });
  canvas.addEventListener("mouseup", () => dibujando = false);
  canvas.addEventListener("mousemove", e => {
    if (!dibujando) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#00416A";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });

  // Touch
  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    ctx.beginPath();
    ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
    dibujando = true;
  });
  canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    if (!dibujando) return;
    const rect = canvas.getBoundingClientRect();
    const t = e.touches[0];
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#00416A";
    ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top);
    ctx.stroke();
  });
  canvas.addEventListener("touchend", () => dibujando = false);
}

// ==========================================================
// üß± SECCI√ìN 5.1: FOLIADOR INTERNO (autonum√©rico)
// ==========================================================

// Generar folio √∫nico secuencial
async function generarFolioInterno() {
  const ref = doc(db, "almacenes", "almacenabarrotepdd", "contador", "folio_unico");
  const snap = await getDoc(ref);

  let folioActual = 0;
  if (snap.exists()) {
    folioActual = snap.data().ultimoFolio || 0;
  }

  const nuevoFolio = folioActual + 1;
  await setDoc(ref, { ultimoFolio: nuevoFolio, fecha: new Date().toISOString() });

  const folioFormateado = `SAL-${nuevoFolio.toString().padStart(6, "0")}`;
  return folioFormateado;
}
// ==========================================================
// üß± SECCI√ìN 10.1: GUARDAR SALIDA CON FIRMAS EN STORAGE
// ==========================================================
import {
  getStorage, ref, uploadString, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

const storage = getStorage(app);

document.getElementById('btnGuardarSalida').onclick = async () => {
  if (!datosSalida.recibeId || !datosSalida.destinoId || carrito.length === 0)
    return alert("‚ö†Ô∏è Faltan datos o carrito vac√≠o");

  // üßæ Generar folio interno
  const folio = await generarFolioInterno();
  document.querySelector("#firmas h2").textContent = `FOLIO: ${folio}`;

  // üß© Subir las firmas a Storage
  try {
    // Reducir tama√±o del canvas antes de subir
    const firmaRecibeURL = await subirFirmaStorage(canvasRecibe, `firmas/${folio}_recibe.jpg`);
    const firmaEncargadoURL = await subirFirmaStorage(canvasEncargado, `firmas/${folio}_encargado.jpg`);

    // üß© Preparar objeto de salida
    const salida = {
      folio,
      fecha: new Date().toISOString(),
      usuario: datosSalida.usuario,
      recibe: {
        id: datosSalida.recibeId,
        nombre: datosSalida.recibeNombre
      },
      destino: {
        id: datosSalida.destinoId,
        nombre: datosSalida.destinoNombre,
        direccion: datosSalida.destinoDireccion,
        ubicacion: datosSalida.destinoUbicacion
      },
      productos: carrito,
      firmaRecibeURL,
      firmaEncargadoURL
    };

    const refSalidas = collection(db, "almacenes", "almacenabarrotepdd", "salidas");
    const docRef = await addDoc(refSalidas, salida);
    console.log("‚úÖ Documento guardado:", docRef.id);

    alert(`‚úÖ Salida registrada correctamente\nFolio: ${folio}`);
    imprimirTicketAndroid(salida);

    // Enviar bots fuera del bloque principal (no romper flujo)
    try {
      await enviarBotsTelegram(salida, carrito);
    } catch (botErr) {
      console.warn("‚ö†Ô∏è Error enviando a bots:", botErr);
      mostrarAvisoFlotante("‚ö†Ô∏è Error al notificar a Telegram");
    }

    // Limpieza general
    carrito = [];
    renderCarrito();
    actualizarContador();
    ctxRecibe.clearRect(0, 0, canvasRecibe.width, canvasRecibe.height);
    ctxEncargado.clearRect(0, 0, canvasEncargado.width, canvasEncargado.height);
    datosSalida = {};
    selectRecibe.value = "";
    selectDestino.value = "";
    mostrarPantalla('datosSalida');

  } catch (err) {
    console.error("‚ùå Error REAL al guardar en Firestore:", err);
    alert("‚ùå Error al guardar. Revisa conexi√≥n o permisos en Storage.");
  }
};

// ==========================================================
// üîß FUNCI√ìN AUXILIAR PARA SUBIR UNA FIRMA
// ==========================================================
async function subirFirmaStorage(canvas, ruta) {
  const reducido = reducirCanvas(canvas, 300);
  const dataURL = reducido.toDataURL("image/jpeg", 0.6); // comprimido
  const firmaRef = ref(storage, ruta);
  await uploadString(firmaRef, dataURL, 'data_url');
  const url = await getDownloadURL(firmaRef);
  console.log("üì§ Firma subida:", url);
  return url;
}

// ==========================================================
// üîß FUNCI√ìN REDUCTORA DE CANVAS
// ==========================================================
function reducirCanvas(canvas, maxAncho = 300) {
  const temp = document.createElement('canvas');
  const ratio = maxAncho / canvas.width;
  temp.width = maxAncho;
  temp.height = canvas.height * ratio;
  const ctx = temp.getContext('2d');
  ctx.drawImage(canvas, 0, 0, temp.width, temp.height);
  return temp;
}


// ==========================================================
// üß± FUNCI√ìN MODULAR PARA ENVIAR BOTS
// ==========================================================
async function enviarBotsTelegram(salida, carrito) {
  // BOT 1: ALIKA
  const BOT_TOKEN = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
  const CHAT_ID = "6617988297";

  let detalleArticulos = carrito.map(p => {
    let nombre = p.concepto;
    if (nombre.length > 45) nombre = nombre.substring(0, 45) + "...";
    return `‚Ä¢ ${nombre} (x${p.cantidad})`;
  }).join("\n");

  if (carrito.length > 5)
    detalleArticulos = detalleArticulos.split("\n").slice(0, 5).join("\n") + `\n‚Ä¶y ${carrito.length - 5} m√°s`;

  const mensaje = `
üì¶ *Nueva salida registrada en Abarrote PDD*
üî¢ Folio: ${salida.folio}
üë®‚Äçüíº Usuario: ${salida.usuario}
üôã‚Äç‚ôÇÔ∏è Recibe: ${salida.recibe.nombre}
üìç Destino: ${salida.destino.nombre}
üßæ *Detalle:*
${detalleArticulos}
üïí ${new Date().toLocaleString("es-MX")}
‚úÖ Registro guardado y enviado a central
`;

  await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: CHAT_ID,
      text: mensaje,
      parse_mode: "Markdown"
    })
  });

  // BOT 2 (LOBA / STAR)
  await ejecutarBotInventario(salida, carrito);
  mostrarAvisoFlotante("üì§ Salida enviada a central (ALIKA)");
}

// ==========================================================
// üß± SECCI√ìN 11: BOT SUPERVISOR DE INVENTARIOS (LOBA / STAR)
// ==========================================================

// üîß Configuraci√≥n del bot de supervisi√≥n
const BOT2_TOKEN = "8241239653:AAH3-eS7XrRlO4G6LO5MydlYlOm2Um18SGE";
const BOT2_CHAT_ID = "6617988297";

/**
 * BOT 2: Verifica inventarios fijados, actualiza historial
 * y env√≠a notificaciones a Telegram.
 */
async function ejecutarBotInventario(salida, carrito) {
  try {
for (const p of carrito) {
  const productoRef = doc(db, "productos", p.id);
  const snap = await getDoc(productoRef);
  if (!snap.exists()) continue;

  const prod = snap.data();
  const inventarioAntes = Number(prod.inventario_fijado || 0);
  const inventarioMinimo = Number(prod.inventario_minimo || 0);
  const salidaCant = Number(p.cantidad || 0);

  // ‚úÖ Calcular correctamente inventario nuevo
  const inventarioNuevo = inventarioAntes - salidaCant;

  // Registrar en historial
  await addDoc(collection(productoRef, "historial_salidas"), {
    fecha: new Date().toISOString(),
    usuario: salida.usuario,
    cantidad: salidaCant,
    inventario_antes: inventarioAntes,
    inventario_despues: inventarioNuevo,
    destino: salida.destino.nombre,
    folio_salida: salida.folio
  });

  // Actualizar en Firestore
  await updateDoc(productoRef, {
    inventario_fijado: inventarioNuevo,
    ultima_salida: new Date().toISOString(),
    actualizadoEn: new Date().toISOString()
  });

  // üî• Evaluar despu√©s de actualizar
  const alertaCritica = inventarioNuevo <= inventarioMinimo;

  // Formatear nombre corto si es muy largo
  let nombreCorto = p.concepto;
  if (nombreCorto.length > 45) nombreCorto = nombreCorto.substring(0, 45) + "...";

  // Mensaje a Telegram seg√∫n caso
  const msg = alertaCritica
 ? `üî•üî•üî• *¬°ALERTA ALERTA!* üî•üî•üî•  
üö® *ALERTA CR√çTICA DE INVENTARIO*  
üì¶ ${nombreCorto}  
üìâ Stock actual: ${inventarioNuevo} (m√≠nimo ${inventarioMinimo})  
üì§ √öltima salida: ${salidaCant} unidades  
‚ö†Ô∏è URGENTE: revisar existencia y surtir antes de ruptura.  
üë®‚Äçüíº Usuario: ${salida.usuario}  
üïí ${new Date().toLocaleString("es-MX")}
`
    : `üì¶ *Movimiento detectado en inventario*\nüßæ Folio: ${salida.folio}\nüìÑ ${nombreCorto}\nüìâ Salida: ${salidaCant} unidades\nüìä Antes: ${inventarioAntes} ‚Üí Ahora: ${inventarioNuevo}\nüìç Destino: ${salida.destino.nombre}\nüë®‚Äçüíº Usuario: ${salida.usuario}\nüïí ${new Date().toLocaleString("es-MX")}`;

  await fetch(`https://api.telegram.org/bot${BOT2_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: BOT2_CHAT_ID,
      text: msg,
      parse_mode: "Markdown"
    })
  });
}


    console.log("‚úÖ BOT 2 ejecutado: inventarios y notificaciones actualizados.");
  } catch (err) {
    console.error("‚ö†Ô∏è Error en BOT 2:", err);
  }
}

// ==========================================================
// üß± SECCI√ìN 12: IMPRESI√ìN PDF MANUAL (compatibilidad universal)
// ==========================================================
async function imprimirTicketAndroid(salida) {
  try {
    const contenido = generarHTMLTicket(salida);

    // üßæ Abrir nueva ventana con el contenido del ticket
    const printWin = window.open("", "_blank");
    printWin.document.write(contenido);
    printWin.document.close();

    // Esperar un poco para que renderice y abrir di√°logo de impresi√≥n
    setTimeout(() => {
      printWin.print();
    }, 500);
  } catch (err) {
    console.error("‚ùå Error al imprimir PDF:", err);
    alert("‚ùå No se pudo generar vista previa de impresi√≥n.");
  }
}

// ==========================================================
// üßæ FUNCI√ìN: Generar HTML del ticket (formato t√©rmico simple)
// ==========================================================
function generarHTMLTicket(salida) {
  const sep = "--------------------------------";
  let t = "";
  t += `<html><head><meta charset="UTF-8"><style>
    body { font-family: monospace; font-size: 13px; padding: 10px; }
    h2 { text-align:center; margin:0; }
    .sep { border-top:1px dashed #000; margin:6px 0; }
    .centrado { text-align:center; }
  </style></head><body>`;
  
  t += `<h2>REGISTRO DE SALIDA</h2>`;
  t += `<div class="centrado">ALMAC√âN ABARROTES PDD<br>PROVEEDORA DE DULCES</div>`;
  t += `<div class="sep"></div>`;
  t += `<p><b>FOLIO:</b> ${salida.folio}<br>`;
  t += `<b>FECHA:</b> ${new Date().toLocaleString("es-MX")}</p>`;
  t += `<div class="sep"></div>`;
  t += `<p><b>USUARIO:</b> ${salida.usuario}<br>`;
  t += `<b>RECIBE:</b> ${salida.recibe.nombre}<br>`;
  t += `<b>DESTINO:</b> ${salida.destino.nombre}</p>`;
  t += `<div class="sep"></div>`;
  t += `<p><b>ART√çCULOS:</b><br>`;

  salida.productos.forEach(p => {
    const nombre = p.concepto.length > 28 ? p.concepto.substring(0, 25) + "..." : p.concepto;
    t += `${nombre} (x${p.cantidad})<br>`;
  });

  t += `</p><div class="sep"></div>`;
  t += `<p><b>AVISO DE CONFIRMACI√ìN:</b><br>Firmas electr√≥nicas almacenadas en PROVSOFT.</p>`;
  t += `<div class="sep"></div>`;
  t += `<p class="centrado">¬© PROVSOFT ‚Äì Sistema PDD<br>Seguridad y Control</p>`;
  t += `</body></html>`;
  return t;
}

/* ==========================================================
   üîß Funciones auxiliares para formateo de ticket
========================================================== */
function cortarTexto(texto, max) {
  if (!texto) return "";
  texto = texto.trim();
  if (texto.length <= max) return texto;
  return texto.substring(0, max - 3) + "...";
}

function centrarTexto(texto, ancho = 32) {
  const lineas = texto.split("\n");
  return lineas.map(linea => {
    const espacios = Math.max(0, Math.floor((ancho - linea.length) / 2));
    return " ".repeat(espacios) + linea;
  }).join("\n");
}
// ==========================================================
// üß† CONTROL DE FIRMAS EN DOS PASOS (recibe / encargado)
// ==========================================================
const canvasRecibe = document.getElementById('canvasRecibe');
const ctxRecibe = canvasRecibe.getContext('2d');
const canvasEncargado = document.getElementById('canvasEncargado');
const ctxEncargado = canvasEncargado.getContext('2d');

function activarFirma(canvas, ctx) {
  let dibujando = false;
  const getPos = e => {
    const rect = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
  };
  const start = e => { e.preventDefault(); dibujando = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
  const move = e => { if (!dibujando) return; e.preventDefault(); const p = getPos(e); ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#00416A"; ctx.lineTo(p.x, p.y); ctx.stroke(); };
  const stop = e => { e.preventDefault(); dibujando = false; };
  ["mousedown","touchstart"].forEach(ev=>canvas.addEventListener(ev,start));
  ["mousemove","touchmove"].forEach(ev=>canvas.addEventListener(ev,move));
  ["mouseup","mouseleave","touchend"].forEach(ev=>canvas.addEventListener(ev,stop));
}

// Activar firma t√°ctil en ambos lienzos
activarFirma(canvasRecibe, ctxRecibe);
activarFirma(canvasEncargado, ctxEncargado);

// Botones
document.getElementById("limpiarRecibe").onclick = ()=>ctxRecibe.clearRect(0,0,canvasRecibe.width,canvasRecibe.height);
document.getElementById("limpiarEncargado").onclick = ()=>ctxEncargado.clearRect(0,0,canvasEncargado.width,canvasEncargado.height);

// Flujo entre pantallas
document.getElementById("btnSiguienteFirma").onclick = ()=>{
  document.getElementById("firmaPaso1").style.display="none";
  document.getElementById("firmaPaso2").style.display="block";
};

// ==========================================================
// üß† FUNCI√ìN GLOBAL PARA MOSTRAR AVISOS FLOTANTES (redefinida)
// ==========================================================
function mostrarAvisoFlotante(texto, color = "#00416A") {
  try {
    const aviso = document.createElement("div");
    aviso.textContent = texto;
    Object.assign(aviso.style, {
      position: "fixed",
      bottom: "30px",
      left: "50%",
      transform: "translateX(-50%)",
      background: color,
      color: "#fff",
      padding: "10px 20px",
      borderRadius: "10px",
      fontSize: "14px",
      fontWeight: "600",
      boxShadow: "0 3px 10px rgba(0,0,0,0.3)",
      zIndex: "9999",
      opacity: "0",
      transition: "opacity 0.3s"
    });
    document.body.appendChild(aviso);
    setTimeout(() => aviso.style.opacity = "1", 50);
    setTimeout(() => {
      aviso.style.opacity = "0";
      setTimeout(() => aviso.remove(), 500);
    }, 3000);
  } catch (err) {
    console.warn("‚ö†Ô∏è No se pudo mostrar aviso:", err);
  }
}
	
</script>
</body>
</html>
