<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salidas Abarrote PDD ‚Äì PROVSOFT</title>

  <!-- ===== SECCI√ìN 1: ESTILOS GLOBALES ===== -->
  <style>
    :root {
      --azul: #00416A;
      --gris: #f5f5f5;
      --blanco: #fff;
      --sombra: rgba(0,0,0,0.15);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--gris);
      margin: 0;
      padding: 0;
    }

    .pantalla {
      display: none;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .activa {
      display: block;
      animation: fade 0.3s ease-in-out;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      color: var(--azul);
      margin-bottom: 20px;
    }

    input, button, textarea, select {
      font-family: inherit;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    button {
      background: var(--azul);
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 10px var(--sombra);
    }

    button:hover {
      background: #033a5a;
    }

    .card {
      background: var(--blanco);
      border-radius: 16px;
      box-shadow: 0 4px 14px var(--sombra);
      padding: 20px;
      max-width: 420px;
      margin: 30px auto;
    }

    .tabla {
      width: 100%;
      border-collapse: collapse;
    }

    .tabla th, .tabla td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .tabla th {
      background: var(--azul);
      color: white;
    }

    canvas {
      border: 2px dashed var(--azul);
      border-radius: 10px;
      display: block;
      margin: 10px auto;
    }
  </style>
</head>
<body>

<!-- ==========================================================
     üß± SECCI√ìN 2: LOGIN
=========================================================== -->
<div id="login" class="pantalla activa">
  <div class="card">
    <h2>PROVSOFT ‚Äì Abarrote PDD</h2>
    <input type="text" id="usuario" placeholder="Usuario" autocomplete="off" />
    <input type="password" id="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Entrar</button>
    <p id="mensajeLogin" style="text-align:center;color:red;"></p>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 3: DATOS DE SALIDA
=========================================================== -->
<div id="datosSalida" class="pantalla">
  <div class="card">
    <h2>Datos de salida</h2>
    <label>Usuario:</label>
    <input type="text" id="txtUsuario" readonly>

    <label>Persona que recibe:</label>
    <select id="selectRecibe"></select>

    <label>Destino o direcci√≥n:</label>
    <select id="selectDestino"></select>

    <button id="btnContinuarDatos">Continuar ‚Üí</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 4: CAPTURA DE ART√çCULOS
=========================================================== -->
<div id="captura" class="pantalla">
  <div class="card">
    <h2>Captura de art√≠culos</h2>
    <input type="text" id="buscarProd" placeholder="Buscar producto...">
    <div id="resultadosBusqueda"></div>
    
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 5: REVISI√ìN DEL CARRITO
=========================================================== -->
<div id="carrito" class="pantalla">
  <div class="card">
    <h2>Revisi√≥n del carrito</h2>
    <table class="tabla" id="tablaCarrito">
      <thead>
        <tr>
          <th>Art√≠culo</th>
          <th>Cant.</th>
          <th>Precio</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h3 id="totalGeneral" style="text-align:right;"></h3>
    <button id="btnRegresarCaptura">‚¨ÖÔ∏è Regresar</button>
    <button id="btnConfirmarSalida">Confirmar salida ‚Üí</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 6: FIRMAS
=========================================================== -->
<div id="firmas" class="pantalla">
  <div class="card">
    <h2>Firmas de confirmaci√≥n</h2>
    <p>Firma quien recibe:</p>
    <canvas id="firmaRecibe" width="300" height="150"></canvas>
    <p>Firma encargado:</p>
    <canvas id="firmaEncargado" width="300" height="150"></canvas>
    <button id="btnGuardarSalida">Guardar salida en Firestore</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 7: SCRIPTS DE LA APLICACI√ìN
=========================================================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, addDoc, collection, query, where } 
  from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// ===== CONFIGURACI√ìN FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== VARIABLES =====
let usuarioActual = null;
let datosSalida = {};
let carrito = [];

// ===== CAMBIO DE PANTALLAS =====
function mostrarPantalla(id) {
  document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}

// =======================================================
// üß± BLOQUE 1: LOGIN
// =======================================================
async function validarUsuario(usuario, password) {
  const snap = await getDocs(collection(db, "usuarios_ruta"));
  let user = null;
  snap.forEach(docu => {
    const data = docu.data();
    if (data.usuario === usuario && data.password === password && data.activo) user = data;
  });
  return user;
}

const usuarioInput = document.getElementById("usuario");
const passwordInput = document.getElementById("password");
const mensajeLogin = document.getElementById("mensajeLogin");
	
document.getElementById('btnLogin').onclick = async () => {
  const usuario = usuarioInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!usuario || !pass) return mensajeLogin.textContent = "Ingresa usuario y contrase√±a";

  const user = await validarUsuario(usuario, pass);
  if (!user) return mensajeLogin.textContent = "Datos incorrectos";

  usuarioActual = { usuario, nombre: user.nombre };
  localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
  document.getElementById('txtUsuario').value = user.nombre;
  await cargarListas();
  mostrarPantalla('datosSalida');
};

// =======================================================
// üß± BLOQUE 2: DATOS DE SALIDA
// =======================================================
const selectRecibe = document.getElementById("selectRecibe");
const selectDestino = document.getElementById("selectDestino");

async function cargarListas() {
  selectRecibe.innerHTML = "<option value=''>Selecciona quien recibe...</option>";
  const snapTrab = await getDocs(collection(db, "trabajadores_proveedora"));
  snapTrab.forEach(docu => {
    const t = docu.data();
    const opt = document.createElement("option");
    opt.value = docu.id;
    opt.textContent = t.nombreCompleto;
    selectRecibe.appendChild(opt);
  });

  selectDestino.innerHTML = "<option value=''>Selecciona destino...</option>";
  const snapDest = await getDocs(collection(db, "destinos"));
  snapDest.forEach(docu => {
    const d = docu.data();
    const opt = document.createElement("option");
    opt.value = docu.id;
    opt.textContent = d.nombre || d.direccion;
    selectDestino.appendChild(opt);
  });
}

// =======================================================
// üß± BLOQUE 2.2: CONTINUAR A CAPTURA DE ART√çCULOS
// =======================================================
document.getElementById('btnContinuarDatos').onclick = async () => {
  const recibeId = selectRecibe.value;
  const destinoId = selectDestino.value;

  if (!recibeId || !destinoId) {
    alert("Selecciona quien recibe y el destino antes de continuar");
    return;
  }

  // Obtener los documentos seleccionados
  const recibeSnap = await getDoc(doc(db, "trabajadores_proveedora", recibeId));
  const destinoSnap = await getDoc(doc(db, "destinos", destinoId));

  const recibeData = recibeSnap.exists() ? recibeSnap.data() : {};
  const destinoData = destinoSnap.exists() ? destinoSnap.data() : {};

  // Guardar los datos de salida
  datosSalida = {
    usuario: usuarioActual.nombre,
    recibeId,
    recibeNombre: recibeData.nombreCompleto || "Sin nombre",
    destinoId,
    destinoNombre: destinoData.nombre || "Sin nombre",
    destinoDireccion: destinoData.direccion || "",
    destinoUbicacion: destinoData.ubicacion || null
  };

  console.log("üì¶ Datos de salida:", datosSalida);
  mostrarPantalla('captura');
};

// ==========================================================
// üß± BLOQUE 3: CAPTURA DE ART√çCULOS (con debounce 400ms)
// ==========================================================
const buscarProd = document.getElementById('buscarProd');
const resultadosDiv = document.getElementById('resultadosBusqueda');
let debounceTimer = null;

buscarProd.addEventListener('input', e => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => buscarProductos(e.target.value.trim().toUpperCase()), 400);
});

async function buscarProductos(texto) {
  resultadosDiv.innerHTML = "";
  if (texto.length < 2) return;

  try {
    const ref = collection(db, "productos");
    const snapshot = await getDocs(
      query(
        ref,
        where("activo", "==", true),
        where("concepto", ">=", texto),
        where("concepto", "<=", texto + "\uf8ff")
      )
    );

    if (snapshot.empty) {
      resultadosDiv.innerHTML = "<p style='color:gray;text-align:center'>Sin coincidencias</p>";
      return;
    }

    snapshot.forEach(docu => {
      const p = docu.data();
      const item = document.createElement('div');
      item.innerHTML = `
        <strong>${p.concepto}</strong><br>
        <small>C√≥digo: ${p.codigoBarra}</small><br>
        <small>Precio: $${p.costoSinImpuesto.toFixed(2)}</small>
      `;
      item.style.padding = "8px";
      item.style.borderBottom = "1px solid #ddd";
      item.style.cursor = "pointer";
      item.onclick = () => agregarAlCarrito(docu.id, p);
      resultadosDiv.appendChild(item);
    });
  } catch (err) {
    console.error("Error al buscar productos:", err);
    resultadosDiv.innerHTML = "<p style='color:red;text-align:center'>Error al buscar productos</p>";
  }
}
// ==========================================================
// üß± BLOQUE 3.2: AGREGAR PRODUCTO AL CARRITO
// ==========================================================
function agregarAlCarrito(id, producto) {
  const cantidad = prompt(`Cantidad para "${producto.concepto}"`, "1");
  if (!cantidad || isNaN(cantidad) || cantidad <= 0) return;

  // Verificar si ya est√° en el carrito
  const existente = carrito.find(p => p.id === id);
  if (existente) {
    existente.cantidad += parseInt(cantidad);
  } else {
    carrito.push({
      id,
      concepto: producto.concepto,
      costo: producto.costoSinImpuesto || 0,
      cantidad: parseInt(cantidad),
      codigoBarra: producto.codigoBarra || ""
    });
  }

  // Mostrar confirmaci√≥n visual
  alert(`‚úÖ ${producto.concepto} agregado (${cantidad})`);
  buscarProd.value = "";
  resultadosDiv.innerHTML = "";
  actualizarContador();
}
// ==========================================================
// üß± BLOQUE 3.3: BOT√ìN FLOTANTE DE CARRITO üõí
// ==========================================================
const btnFlotante = document.createElement('button');
btnFlotante.id = "btnFlotanteCarrito";
btnFlotante.innerHTML = "üõí <span id='contadorCarrito'>0</span>";
btnFlotante.style.position = "fixed";
btnFlotante.style.bottom = "24px";
btnFlotante.style.right = "24px";
btnFlotante.style.background = "#00416A";
btnFlotante.style.color = "white";
btnFlotante.style.fontWeight = "600";
btnFlotante.style.border = "none";
btnFlotante.style.borderRadius = "50px";
btnFlotante.style.boxShadow = "0 4px 14px rgba(0,0,0,0.3)";
btnFlotante.style.padding = "12px 18px";
btnFlotante.style.cursor = "pointer";
btnFlotante.style.zIndex = "999";
btnFlotante.style.display = "none";
document.body.appendChild(btnFlotante);

function actualizarContador() {
  const c = document.getElementById('contadorCarrito');
  c.textContent = carrito.reduce((acc, p) => acc + p.cantidad, 0);
  btnFlotante.style.display = carrito.length > 0 ? "block" : "none";
}

// Evento para abrir el carrito
btnFlotante.addEventListener("click", () => {
  renderCarrito();
  mostrarPantalla('carrito');
});

	
// ==========================================================
// üß± BLOQUE 4: REVISI√ìN DE CARRITO
// ==========================================================
const tbody = document.querySelector('#tablaCarrito tbody');
const totalGeneral = document.getElementById('totalGeneral');

function renderCarrito() {
  tbody.innerHTML = "";
  let total = 0;

  carrito.forEach((p, i) => {
    const subt = p.cantidad * p.costo;
    total += subt;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.concepto}</td>
      <td>${p.cantidad}</td>
      <td>$${p.costo.toFixed(2)}</td>
      <td>$${subt.toFixed(2)}</td>
      <td>
        <button onclick="editar(${i})">‚úèÔ∏è</button>
        <button onclick="eliminar(${i})">‚ùå</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  totalGeneral.textContent = `Total: $${total.toFixed(2)}`;
}

window.editar = (i) => {
  const nueva = prompt("Nueva cantidad:", carrito[i].cantidad);
  if (nueva && !isNaN(nueva) && nueva > 0) {
    carrito[i].cantidad = parseInt(nueva);
    renderCarrito();
  }
};

window.eliminar = (i) => {
  if (confirm("¬øEliminar producto?")) {
    carrito.splice(i, 1);
    renderCarrito();
  }
};

document.getElementById('btnRegresarCaptura').onclick = () => {
  mostrarPantalla('captura');
};

document.getElementById('btnConfirmarSalida').onclick = () => {
  if (carrito.length === 0) return alert("Carrito vac√≠o");
  mostrarPantalla('firmas');
};

// ==========================================================
// üß± BLOQUE 5: FIRMAS Y GUARDADO EN FIRESTORE
// ==========================================================
const canvas1 = document.getElementById('firmaRecibe');
const ctx1 = canvas1.getContext('2d');
const canvas2 = document.getElementById('firmaEncargado');
const ctx2 = canvas2.getContext('2d');

function activarDibujo(canvas, ctx) {
  let dibujando = false;

  canvas.addEventListener('mousedown', () => dibujando = true);
  canvas.addEventListener('mouseup', () => {
    dibujando = false;
    ctx.beginPath();
  });

  canvas.addEventListener('mousemove', e => {
    if (!dibujando) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#00416A";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });
}

activarDibujo(canvas1, ctx1);
activarDibujo(canvas2, ctx2);

document.getElementById('btnGuardarSalida').onclick = async () => {
  if (!datosSalida.recibeId || !datosSalida.destinoId || carrito.length === 0)
    return alert("‚ö†Ô∏è Faltan datos o carrito vac√≠o");

  const salida = {
    fecha: new Date().toISOString(),
    usuario: datosSalida.usuario,
    recibe: {
      id: datosSalida.recibeId,
      nombre: datosSalida.recibeNombre
    },
    destino: {
      id: datosSalida.destinoId,
      nombre: datosSalida.destinoNombre,
      direccion: datosSalida.destinoDireccion,
      ubicacion: datosSalida.destinoUbicacion
    },
    productos: carrito,
    firmaRecibe: canvas1.toDataURL(),
    firmaEncargado: canvas2.toDataURL()
  };

  try {
    const ref = collection(db, "almacenes", "almacenabarrotepdd", "salidas");
    await addDoc(ref, salida);
    alert("‚úÖ Salida registrada correctamente en Firestore");

    // Resetear
    carrito = [];
    datosSalida = {};
    ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
    ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
    mostrarPantalla('login');
    localStorage.removeItem('usuarioActual');
  } catch (err) {
    console.error(err);
    alert("‚ùå Error al guardar en Firestore");
  }
};
</script>
</body>
</html>
