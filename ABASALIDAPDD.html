<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salidas Abarrote PDD ‚Äì PROVSOFT</title>

  <!-- ===== SECCI√ìN 1: ESTILOS GLOBALES ===== -->
  <style>
    :root {
      --azul: #00416A;
      --gris: #f5f5f5;
      --blanco: #fff;
      --sombra: rgba(0,0,0,0.15);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--gris);
      margin: 0;
      padding: 0;
    }

    .pantalla {
      display: none;
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .activa {
      display: block;
      animation: fade 0.3s ease-in-out;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      color: var(--azul);
      margin-bottom: 20px;
    }

    input, button, textarea, select {
      font-family: inherit;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    button {
      background: var(--azul);
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 10px var(--sombra);
    }

    button:hover {
      background: #033a5a;
    }

    .card {
      background: var(--blanco);
      border-radius: 16px;
      box-shadow: 0 4px 14px var(--sombra);
      padding: 20px;
      max-width: 420px;
      margin: 30px auto;
    }

    .tabla {
      width: 100%;
      border-collapse: collapse;
    }

    .tabla th, .tabla td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .tabla th {
      background: var(--azul);
      color: white;
    }

    canvas {
      border: 2px dashed var(--azul);
      border-radius: 10px;
      display: block;
      margin: 10px auto;
    }
	/* Mejor visualizaci√≥n del carrito en m√≥viles */
.tabla td, .tabla th {
  padding: 6px;
  word-wrap: break-word;
  font-size: 13px;
}

.tabla tr {
  border-bottom: 1px solid #eee;
}

@media (max-width: 480px) {
  .tabla td {
    font-size: 12px;
  }
}
  
  </style>
</head>
<body>

<!-- ==========================================================
     üß± SECCI√ìN 2: LOGIN
=========================================================== -->
<div id="login" class="pantalla activa">
  <div class="card">
    <h2>PROVSOFT ‚Äì Abarrote PDD</h2>
    <input type="text" id="usuario" placeholder="Usuario" autocomplete="off" />
    <input type="password" id="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Entrar</button>
    <p id="mensajeLogin" style="text-align:center;color:red;"></p>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 3: DATOS DE SALIDA
=========================================================== -->
<div id="datosSalida" class="pantalla">
  <div class="card">
    <h2>Datos de salida</h2>
    <label>Usuario:</label>
    <input type="text" id="txtUsuario" readonly>

    <label>Persona que recibe:</label>
    <select id="selectRecibe"></select>

    <label>Destino o direcci√≥n:</label>
    <select id="selectDestino"></select>

    <button id="btnContinuarDatos">Continuar ‚Üí</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 4: CAPTURA DE ART√çCULOS
=========================================================== -->
<div id="captura" class="pantalla">
  <div class="card">
    <h2>Captura de art√≠culos</h2>
	<button id="btnLogout" style="
  background:#b30000;
  color:white;
  font-weight:600;
  border:none;
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
  cursor:pointer;
  width:100%;
">üîí Cerrar sesi√≥n</button>

    <input type="text" id="buscarProd" placeholder="Buscar producto...">

<!-- üîç Esc√°ner con c√°mara -->
<button id="btnActivarCamara" style="
  background:#0a84ff;
  color:white;
  font-weight:600;
  border:none;
  border-radius:10px;
  padding:10px;
  margin-top:6px;
  cursor:pointer;
  width:100%;
">üì∑ Activar c√°mara / Escanear c√≥digo</button>

<video id="previewCamara" width="100%" height="200" autoplay style="
  display:none;
  border-radius:10px;
  margin-top:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
"></video>

<div id="resultadosBusqueda"></div>
    
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 5: REVISI√ìN DEL CARRITO
=========================================================== -->
<div id="carrito" class="pantalla">
  <div class="card">
    <h2>Revisi√≥n del carrito</h2>
    <table class="tabla" id="tablaCarrito">
<thead>
  <tr>
    <th style="width:15%;">Cant.</th>
    <th style="width:25%;">C√≥digo</th>
    <th style="width:45%;">Concepto</th>
    <th style="width:15%;">‚ùå</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
    <h3 id="totalGeneral" style="text-align:right;"></h3>
    <button id="btnRegresarCaptura">‚¨ÖÔ∏è Regresar</button>
    <button id="btnConfirmarSalida">Confirmar salida ‚Üí</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 6: FIRMAS
=========================================================== -->
<div id="firmas" class="pantalla">
  <div class="card">
    <h2>Firmas de confirmaci√≥n</h2>
    <p>Firma quien recibe:</p>
    <canvas id="firmaRecibe" width="300" height="150"></canvas>
    <p>Firma encargado:</p>
    <canvas id="firmaEncargado" width="300" height="150"></canvas>
    <button id="btnGuardarSalida">Guardar salida en Firestore</button>
  </div>
</div>

<!-- ==========================================================
     üß± SECCI√ìN 7: SCRIPTS DE LA APLICACI√ìN
=========================================================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getFirestore, doc, getDoc, getDocs, addDoc, updateDoc, setDoc, 
  collection, query, where 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// ===== CONFIGURACI√ìN FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== VARIABLES =====
let usuarioActual = null;
let datosSalida = {};
let carrito = [];

// ===== CAMBIO DE PANTALLAS =====
function mostrarPantalla(id) {
  document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
  document.getElementById(id).classList.add('activa');
}
// ===== FUNCIONES DE SESI√ìN =====
function cerrarSesion() {
  usuarioActual = null;
  datosSalida = {};
  carrito = [];
  renderCarrito();
  actualizarContador();
  localStorage.removeItem('usuarioActual');
  alert("üîí Sesi√≥n cerrada por seguridad");
  mostrarPantalla('login');
}

// Asignar al bot√≥n de cierre manual
document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "btnLogout") {
    cerrarSesion();
  }
});
// ===== AUTO-CIERRE POR INACTIVIDAD =====
let inactividadTimer;

function reiniciarTemporizador() {
  clearTimeout(inactividadTimer);
  inactividadTimer = setTimeout(() => {
    if (usuarioActual) cerrarSesion();
  }, 10 * 60 * 1000); // 10 minutos = 600000 ms
}

// Eventos que reinician el contador
["click", "keypress", "mousemove", "touchstart"].forEach(evt => {
  document.addEventListener(evt, reiniciarTemporizador);
});

reiniciarTemporizador(); // Iniciar al cargar
// =======================================================
// üß± BLOQUE 1: LOGIN
// =======================================================
async function validarUsuario(usuario, password) {
  const snap = await getDocs(collection(db, "usuarios_ruta"));
  let user = null;
  snap.forEach(docu => {
    const data = docu.data();
    if (data.usuario === usuario && data.password === password && data.activo) user = data;
  });
  return user;
}

const usuarioInput = document.getElementById("usuario");
const passwordInput = document.getElementById("password");
const mensajeLogin = document.getElementById("mensajeLogin");
	
document.getElementById('btnLogin').onclick = async () => {
  const usuario = usuarioInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!usuario || !pass) return mensajeLogin.textContent = "Ingresa usuario y contrase√±a";

  const user = await validarUsuario(usuario, pass);
  if (!user) return mensajeLogin.textContent = "Datos incorrectos";

  usuarioActual = { usuario, nombre: user.nombre };
  localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
  document.getElementById('txtUsuario').value = user.nombre;
  await cargarListas();
  mostrarPantalla('datosSalida');
};

// =======================================================
// üß± BLOQUE 2: DATOS DE SALIDA
// =======================================================
const selectRecibe = document.getElementById("selectRecibe");
const selectDestino = document.getElementById("selectDestino");

async function cargarListas() {
  selectRecibe.innerHTML = "<option value=''>Selecciona quien recibe...</option>";
  const snapTrab = await getDocs(collection(db, "trabajadores_proveedora"));
  snapTrab.forEach(docu => {
    const t = docu.data();
    const opt = document.createElement("option");
    opt.value = docu.id;
    opt.textContent = t.nombreCompleto;
    selectRecibe.appendChild(opt);
  });

  selectDestino.innerHTML = "<option value=''>Selecciona destino...</option>";
  const snapDest = await getDocs(collection(db, "destinos"));
  snapDest.forEach(docu => {
    const d = docu.data();
    const opt = document.createElement("option");
    opt.value = docu.id;
    opt.textContent = d.nombre || d.direccion;
    selectDestino.appendChild(opt);
  });
}

// =======================================================
// üß± BLOQUE 2.2: CONTINUAR A CAPTURA DE ART√çCULOS
// =======================================================
document.getElementById('btnContinuarDatos').onclick = async () => {
  const recibeId = selectRecibe.value;
  const destinoId = selectDestino.value;

  if (!recibeId || !destinoId) {
    alert("Selecciona quien recibe y el destino antes de continuar");
    return;
  }

  // Obtener los documentos seleccionados
  const recibeSnap = await getDoc(doc(db, "trabajadores_proveedora", recibeId));
  const destinoSnap = await getDoc(doc(db, "destinos", destinoId));

  const recibeData = recibeSnap.exists() ? recibeSnap.data() : {};
  const destinoData = destinoSnap.exists() ? destinoSnap.data() : {};

  // Guardar los datos de salida
  datosSalida = {
    usuario: usuarioActual.nombre,
    recibeId,
    recibeNombre: recibeData.nombreCompleto || "Sin nombre",
    destinoId,
    destinoNombre: destinoData.nombre || "Sin nombre",
    destinoDireccion: destinoData.direccion || "",
    destinoUbicacion: destinoData.ubicacion || null
  };

  console.log("üì¶ Datos de salida:", datosSalida);
  mostrarPantalla('captura');
};

// ==========================================================
// üß± BLOQUE 3: CAPTURA DE ART√çCULOS (con debounce 400ms)
// ==========================================================
const buscarProd = document.getElementById('buscarProd');
const resultadosDiv = document.getElementById('resultadosBusqueda');
let debounceTimer = null;

buscarProd.addEventListener('input', e => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => buscarProductos(e.target.value.trim().toUpperCase()), 400);
});

async function buscarProductos(texto) {
  resultadosDiv.innerHTML = "";
  if (texto.length < 2) return;

  try {
    const ref = collection(db, "productos");
    const snapshot = await getDocs(
      query(
        ref,
        where("activo", "==", true),
        where("concepto", ">=", texto),
        where("concepto", "<=", texto + "\uf8ff")
      )
    );

    if (snapshot.empty) {
      resultadosDiv.innerHTML = "<p style='color:gray;text-align:center'>Sin coincidencias</p>";
      return;
    }

    snapshot.forEach(docu => {
      const p = docu.data();
      const item = document.createElement('div');
      item.innerHTML = `
        <strong>${p.concepto}</strong><br>
        <small>C√≥digo: ${p.codigoBarra}</small><br>
        <small>Precio: $${p.costoSinImpuesto.toFixed(2)}</small>
      `;
      item.style.padding = "8px";
      item.style.borderBottom = "1px solid #ddd";
      item.style.cursor = "pointer";
      item.onclick = () => agregarAlCarrito(docu.id, p);
      resultadosDiv.appendChild(item);
    });
  } catch (err) {
    console.error("Error al buscar productos:", err);

	  resultadosDiv.innerHTML = "<p style='color:red;text-align:center'>Error al buscar productos</p>";
  }
}

// ==========================================================
// üß± BLOQUE 3.1: ESC√ÅNER CON C√ÅMARA
// ==========================================================
const btnCamara = document.getElementById("btnActivarCamara");
const videoCamara = document.getElementById("previewCamara");
let escaneando = false;
let stream = null;

btnCamara.addEventListener("click", async () => {
  if (escaneando) {
    detenerCamara();
    return;
  }

  try {
    if (!("BarcodeDetector" in window)) {
      alert("‚ö†Ô∏è Tu navegador no soporta detecci√≥n directa de c√≥digos. Usa Chrome o Edge actualizado.");
      return;
    }

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    videoCamara.srcObject = stream;
    videoCamara.style.display = "block";
    escaneando = true;
    btnCamara.textContent = "‚èπÔ∏è Detener c√°mara";

    const detector = new BarcodeDetector({ formats: ["code_128", "ean_13", "ean_8", "upc_a", "upc_e"] });

    const escanear = async () => {
      if (!escaneando) return;
      try {
        const barcodes = await detector.detect(videoCamara);
        if (barcodes.length > 0) {
          const codigoDetectado = barcodes[0].rawValue.trim();
        // üîä Sonido al detectar c√≥digo
function beep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(880, ctx.currentTime); // tono
    g.gain.setValueAtTime(0.1, ctx.currentTime); // volumen
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.15); // duraci√≥n 150 ms
  } catch (e) {
    console.warn("No se pudo reproducir el beep:", e);
  }
}
beep(); // ‚úÖ suena al detectar
  
		detenerCamara();

          buscarProd.value = codigoDetectado;
          await buscarProductos(codigoDetectado);

          // Buscar coincidencia exacta por c√≥digo
          const ref = collection(db, "productos");
          const snap = await getDocs(query(ref, where("codigoBarra", "==", codigoDetectado)));
          if (!snap.empty) {
            const docu = snap.docs[0];
            const p = docu.data();
            agregarAlCarrito(docu.id, p);
          } else {
            alert(`‚ö†Ô∏è No se encontr√≥ el c√≥digo: ${codigoDetectado}`);
          }
        } else {
          requestAnimationFrame(escanear);
        }
      } catch (err) {
        console.error("Error escaneando:", err);
        requestAnimationFrame(escanear);
      }
    };

    escanear();
  } catch (err) {
    console.error("‚ùå Error al acceder a la c√°mara:", err);
    alert("No se pudo acceder a la c√°mara.");
  }
});

function detenerCamara() {
  escaneando = false;
  btnCamara.textContent = "üì∑ Activar c√°mara / Escanear c√≥digo";
  videoCamara.style.display = "none";
  if (stream) {
    const tracks = stream.getTracks();
    tracks.forEach(t => t.stop());
    stream = null;
  }
}

	
// ==========================================================
// üß± BLOQUE 3.2: AGREGAR PRODUCTO AL CARRITO
// ==========================================================
function agregarAlCarrito(id, producto) {
  const cantidad = prompt(`Cantidad para "${producto.concepto}"`, "1");
  if (!cantidad || isNaN(cantidad) || cantidad <= 0) return;

  // Verificar si ya est√° en el carrito
  const existente = carrito.find(p => p.id === id);
  if (existente) {
    existente.cantidad += parseInt(cantidad);
  } else {
    carrito.push({
      id,
      concepto: producto.concepto,
      costo: producto.costoSinImpuesto || 0,
      cantidad: parseInt(cantidad),
      codigoBarra: producto.codigoBarra || ""
    });
  }

  // Mostrar confirmaci√≥n visual
  alert(`‚úÖ ${producto.concepto} agregado (${cantidad})`);
  buscarProd.value = "";
  resultadosDiv.innerHTML = "";
  actualizarContador();
}
// ==========================================================
// üß± BLOQUE 3.3: BOT√ìN FLOTANTE DE CARRITO üõí
// ==========================================================
const btnFlotante = document.createElement('button');
btnFlotante.id = "btnFlotanteCarrito";
btnFlotante.innerHTML = "üõí <span id='contadorCarrito'>0</span>";
btnFlotante.style.position = "fixed";
btnFlotante.style.bottom = "24px";
btnFlotante.style.right = "24px";
btnFlotante.style.background = "#00416A";
btnFlotante.style.color = "white";
btnFlotante.style.fontWeight = "600";
btnFlotante.style.border = "none";
btnFlotante.style.borderRadius = "50px";
btnFlotante.style.boxShadow = "0 4px 14px rgba(0,0,0,0.3)";
btnFlotante.style.padding = "12px 18px";
btnFlotante.style.cursor = "pointer";
btnFlotante.style.zIndex = "999";
btnFlotante.style.display = "none";
document.body.appendChild(btnFlotante);

function actualizarContador() {
  const c = document.getElementById('contadorCarrito');
  c.textContent = carrito.reduce((acc, p) => acc + p.cantidad, 0);
  btnFlotante.style.display = carrito.length > 0 ? "block" : "none";
}

// Evento para abrir el carrito
btnFlotante.addEventListener("click", () => {
  renderCarrito();
  mostrarPantalla('carrito');
});

	
// ==========================================================
// üß± BLOQUE 4: REVISI√ìN DE CARRITO
// ==========================================================
const tbody = document.querySelector('#tablaCarrito tbody');
const totalGeneral = document.getElementById('totalGeneral');

function renderCarrito() {
  tbody.innerHTML = "";

  carrito.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:600;">${p.cantidad}</td>
      <td title="${p.codigoBarra}" style="
        max-width:80px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        font-size:13px;
      ">${p.codigoBarra}</td>
      <td title="${p.concepto}" style="
        max-width:160px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
        font-size:13px;
        text-align:left;
      ">${p.concepto}</td>
      <td>
        <button onclick="eliminar(${i})"
          style="background:#b30000;
                 border:none;
                 color:white;
                 border-radius:8px;
                 padding:4px 10px;
                 cursor:pointer;
                 font-size:14px;">‚ùå</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  totalGeneral.textContent = ""; // sin total
}

window.editar = (i) => {
  const nueva = prompt("Nueva cantidad:", carrito[i].cantidad);
  if (nueva && !isNaN(nueva) && nueva > 0) {
    carrito[i].cantidad = parseInt(nueva);
    renderCarrito();
  }
};

window.eliminar = (i) => {
  if (confirm("¬øEliminar producto?")) {
    carrito.splice(i, 1);
    renderCarrito();
  }
};

document.getElementById('btnRegresarCaptura').onclick = () => {
  mostrarPantalla('captura');
};

document.getElementById('btnConfirmarSalida').onclick = () => {
  if (carrito.length === 0) return alert("Carrito vac√≠o");
  mostrarPantalla('firmas');
};

// ==========================================================
// üß± BLOQUE 5: FIRMAS Y GUARDADO EN FIRESTORE
// ==========================================================
const canvas1 = document.getElementById('firmaRecibe');
const ctx1 = canvas1.getContext('2d');
const canvas2 = document.getElementById('firmaEncargado');
const ctx2 = canvas2.getContext('2d');

function activarDibujo(canvas, ctx) {
  let dibujando = false;

  canvas.addEventListener('mousedown', () => dibujando = true);
  canvas.addEventListener('mouseup', () => {
    dibujando = false;
    ctx.beginPath();
  });

  canvas.addEventListener('mousemove', e => {
    if (!dibujando) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#00416A";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });
}

activarDibujo(canvas1, ctx1);
activarDibujo(canvas2, ctx2);
// ==========================================================
// üß± SECCI√ìN 5.1: FOLIADOR INTERNO (autonum√©rico)
// ==========================================================

// Generar folio √∫nico secuencial
async function generarFolioInterno() {
  const ref = collection(db, "almacenes", "almacenabarrotepdd", "contador");
  const snap = await getDocs(ref);

  let folioActual = 0;
  if (!snap.empty) {
    const docu = snap.docs[0];
    folioActual = docu.data().ultimoFolio || 0;

    // Actualizar contador
    await addDoc(ref, { ultimoFolio: folioActual + 1, fecha: new Date().toISOString() });
  } else {
    // Si no existe contador, crear el primero
    await addDoc(ref, { ultimoFolio: 1, fecha: new Date().toISOString() });
    folioActual = 0;
  }

  const nuevoFolio = folioActual + 1;
  const folioFormateado = `SAL-${nuevoFolio.toString().padStart(6, "0")}`;
  return folioFormateado;
}

document.getElementById('btnGuardarSalida').onclick = async () => {
  if (!datosSalida.recibeId || !datosSalida.destinoId || carrito.length === 0)
    return alert("‚ö†Ô∏è Faltan datos o carrito vac√≠o");

  // ==========================================================
  // üßæ Generar folio interno antes de guardar
  // ==========================================================
  const folio = await generarFolioInterno();
  document.querySelector("#firmas h2").textContent = `FOLIO: ${folio}`;

  const salida = {
    folio, // üîπ Se guarda tambi√©n en Firestore
    fecha: new Date().toISOString(),
    usuario: datosSalida.usuario,
    recibe: {
      id: datosSalida.recibeId,
      nombre: datosSalida.recibeNombre
    },
    destino: {
      id: datosSalida.destinoId,
      nombre: datosSalida.destinoNombre,
      direccion: datosSalida.destinoDireccion,
      ubicacion: datosSalida.destinoUbicacion
    },
    productos: carrito,
    firmaRecibe: canvas1.toDataURL(),
    firmaEncargado: canvas2.toDataURL()
  };
alert(`‚úÖ Salida registrada correctamente\nFolio: ${folio}`);
imprimirTicketAndroid(salida);
	
  try {
    const ref = collection(db, "almacenes", "almacenabarrotepdd", "salidas");
    await addDoc(ref, salida);

    // ==========================================================
    // üß± SECCI√ìN 8: INTEGRACI√ìN CON BOTS DE TELEGRAM
    // ==========================================================
const BOT_TOKEN = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
const CHAT_ID = "6617988297";

// üßæ Preparar desglose de art√≠culos (solo nombre y cantidad, sin c√≥digo)
let detalleArticulos = carrito.map(p => {
  let nombre = p.concepto;
  if (nombre.length > 45) nombre = nombre.substring(0, 45) + "...";
  return `‚Ä¢ ${nombre} (x${p.cantidad})`;
}).join("\n");

// Limitar a los primeros 5 si hay muchos
if (carrito.length > 5) {
  detalleArticulos = detalleArticulos.split("\n").slice(0, 5).join("\n") + `\n‚Ä¶y ${carrito.length - 5} m√°s`;
}

const mensaje = `
üì¶ *Nueva salida registrada en Abarrote PDD*
üî¢ Folio: ${folio}
üë®‚Äçüíº Usuario: ${datosSalida.usuario}
üôã‚Äç‚ôÇÔ∏è Recibe: ${datosSalida.recibeNombre}
üìç Destino: ${datosSalida.destinoNombre}
üßæ *Detalle:*
${detalleArticulos}

üïí ${new Date().toLocaleString("es-MX")}
‚úÖ Registro guardado y enviado a central
`;

    try {
      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: CHAT_ID,
          text: mensaje,
          parse_mode: "Markdown"
        })
      });
      // üß† Llamar al BOT 2 (LOBA/STAR) para revisar inventarios fijados
await ejecutarBotInventario(salida, carrito);
		mostrarAvisoFlotante("üì§ Salida enviada a central (ALIKA)");
    } catch (error) {
      console.error("‚ö†Ô∏è Error al enviar mensaje al bot:", error);
      mostrarAvisoFlotante("‚ö†Ô∏è No se pudo notificar a Telegram");
    }

    // ==========================================================
    // üß± SECCI√ìN 9: AVISO FLOTANTE VISUAL
    // ==========================================================
    function mostrarAvisoFlotante(msg) {
      const aviso = document.createElement('div');
      aviso.textContent = msg;
      aviso.style.position = 'fixed';
      aviso.style.bottom = '30px';
      aviso.style.left = '50%';
      aviso.style.transform = 'translateX(-50%)';
      aviso.style.background = '#333';
      aviso.style.color = '#fff';
      aviso.style.padding = '10px 20px';
      aviso.style.borderRadius = '10px';
      aviso.style.fontSize = '14px';
      aviso.style.boxShadow = '0 3px 10px rgba(0,0,0,0.3)';
      aviso.style.opacity = '0';
      aviso.style.transition = 'opacity 0.3s';
      aviso.style.zIndex = '10000';
      document.body.appendChild(aviso);
      setTimeout(() => aviso.style.opacity = '1', 100);
      setTimeout(() => {
        aviso.style.opacity = '0';
        setTimeout(() => aviso.remove(), 500);
      }, 3000);
    }

    // ==========================================================
    // üß± SECCI√ìN 10: LIMPIEZA Y REGRESO
    // ==========================================================
    alert(`‚úÖ Salida registrada correctamente\nFolio: ${folio}`);

    carrito = [];
    renderCarrito();
    actualizarContador();
    ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
    ctx2.clearRect(0, 0, canvas2.width, canvas2.height);

    datosSalida = {};
    selectRecibe.value = "";
    selectDestino.value = "";
    mostrarPantalla('datosSalida');

  } catch (err) {
    console.error(err);
    alert("‚ùå Error al guardar en Firestore");
  }
};
// ==========================================================
// üß± SECCI√ìN 11: BOT SUPERVISOR DE INVENTARIOS (LOBA / STAR)
// ==========================================================

// üîß Configuraci√≥n del bot de supervisi√≥n
const BOT2_TOKEN = "8241239653:AAH3-eS7XrRlO4G6LO5MydlYlOm2Um18SGE";
const BOT2_CHAT_ID = "6617988297";

/**
 * BOT 2: Verifica inventarios fijados, actualiza historial
 * y env√≠a notificaciones a Telegram.
 */
async function ejecutarBotInventario(salida, carrito) {
  try {
for (const p of carrito) {
  const productoRef = doc(db, "productos", p.id);
  const snap = await getDoc(productoRef);
  if (!snap.exists()) continue;

  const prod = snap.data();
  const inventarioAntes = Number(prod.inventario_fijado || 0);
  const inventarioMinimo = Number(prod.inventario_minimo || 0);
  const salidaCant = Number(p.cantidad || 0);

  // ‚úÖ Calcular correctamente inventario nuevo
  const inventarioNuevo = inventarioAntes - salidaCant;

  // Registrar en historial
  await addDoc(collection(productoRef, "historial_salidas"), {
    fecha: new Date().toISOString(),
    usuario: salida.usuario,
    cantidad: salidaCant,
    inventario_antes: inventarioAntes,
    inventario_despues: inventarioNuevo,
    destino: salida.destino.nombre,
    folio_salida: salida.folio
  });

  // Actualizar en Firestore
  await updateDoc(productoRef, {
    inventario_fijado: inventarioNuevo,
    ultima_salida: new Date().toISOString(),
    actualizadoEn: new Date().toISOString()
  });

  // üî• Evaluar despu√©s de actualizar
  const alertaCritica = inventarioNuevo <= inventarioMinimo;

  // Formatear nombre corto si es muy largo
  let nombreCorto = p.concepto;
  if (nombreCorto.length > 45) nombreCorto = nombreCorto.substring(0, 45) + "...";

  // Mensaje a Telegram seg√∫n caso
  const msg = alertaCritica
 ? `üî•üî•üî• *¬°ALERTA ALERTA!* üî•üî•üî•  
üö® *ALERTA CR√çTICA DE INVENTARIO*  
üì¶ ${nombreCorto}  
üìâ Stock actual: ${inventarioNuevo} (m√≠nimo ${inventarioMinimo})  
üì§ √öltima salida: ${salidaCant} unidades  
‚ö†Ô∏è URGENTE: revisar existencia y surtir antes de ruptura.  
üë®‚Äçüíº Usuario: ${salida.usuario}  
üïí ${new Date().toLocaleString("es-MX")}
`
    : `üì¶ *Movimiento detectado en inventario*\nüßæ Folio: ${salida.folio}\nüìÑ ${nombreCorto}\nüìâ Salida: ${salidaCant} unidades\nüìä Antes: ${inventarioAntes} ‚Üí Ahora: ${inventarioNuevo}\nüìç Destino: ${salida.destino.nombre}\nüë®‚Äçüíº Usuario: ${salida.usuario}\nüïí ${new Date().toLocaleString("es-MX")}`;

  await fetch(`https://api.telegram.org/bot${BOT2_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: BOT2_CHAT_ID,
      text: msg,
      parse_mode: "Markdown"
    })
  });
}


    console.log("‚úÖ BOT 2 ejecutado: inventarios y notificaciones actualizados.");
  } catch (err) {
    console.error("‚ö†Ô∏è Error en BOT 2:", err);
  }
}

// ==========================================================
// üß± SECCI√ìN 12: IMPRESI√ìN DIRECTA ANDROID (58mm profesional)
// ==========================================================
async function imprimirTicketAndroid(salida) {
  try {
    // üß† Mostrar aviso flotante ‚ÄúImprimiendo‚Ä¶‚Äù
    const aviso = document.createElement('div');
    aviso.textContent = "üñ®Ô∏è Imprimiendo ticket...";
    Object.assign(aviso.style, {
      position: 'fixed',
      bottom: '30px',
      left: '50%',
      transform: 'translateX(-50%)',
      background: '#00416A',
      color: '#fff',
      padding: '10px 20px',
      borderRadius: '10px',
      fontSize: '14px',
      fontWeight: '600',
      boxShadow: '0 3px 10px rgba(0,0,0,0.3)',
      zIndex: '9999',
      opacity: '0',
      transition: 'opacity 0.3s'
    });
    document.body.appendChild(aviso);
    setTimeout(() => aviso.style.opacity = '1', 100);

    // üéüÔ∏è Cabecera centrada y formal
    const titulo = "REGISTRO DE SALIDA\nALMAC√âN ABARROTES\nPROVEEDORA DE DULCES";
    const separador = "--------------------------------";

    // üßæ Armado del cuerpo
    let ticket = "";
    ticket += centrarTexto(titulo.toUpperCase()) + "\n";
    ticket += separador + "\n";
    ticket += `FOLIO: ${salida.folio}\n`;
    ticket += `FECHA: ${new Date().toLocaleString("es-MX")}\n`;
    ticket += separador + "\n";
    ticket += `USUARIO: ${salida.usuario}\n`;
    ticket += `RECIBE: ${salida.recibe.nombre}\n`;
    ticket += `DESTINO: ${salida.destino.nombre}\n`;
    ticket += separador + "\n";
    ticket += "ART√çCULOS:\n";

    // üîπ Productos, ajustando nombres largos
    salida.productos.forEach(p => {
      let nombre = cortarTexto(p.concepto, 28);
      ticket += `${nombre}\n   x${p.cantidad}\n`;
    });

    ticket += separador + "\n";
    ticket += "\n";
    ticket += "_________________________\n";
    ticket += "  FIRMA USUARIO (Entrega)\n";
    ticket += "\n";
    ticket += "_________________________\n";
    ticket += "  FIRMA QUIEN RECIBE\n";
    ticket += "\n\n\n\n";

    // üñ®Ô∏è Enviar a impresi√≥n
    if (window.AndroidPrint) {
      window.AndroidPrint.printText(ticket);
    } else {
      const win = window.open('', '', 'width=400,height=600');
      win.document.write(`<pre style="font-family:monospace;font-size:11px;">${ticket}</pre>`);
      win.document.close();
      win.print();
      win.close();
    }

    // üîä Beep corto al finalizar
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.setValueAtTime(1000, ctx.currentTime);
      g.gain.setValueAtTime(0.08, ctx.currentTime);
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.15);
    } catch {}

    // üïí Ocultar aviso despu√©s de 3 segundos
    setTimeout(() => {
      aviso.style.opacity = '0';
      setTimeout(() => aviso.remove(), 500);
    }, 3000);

  } catch (e) {
    console.error("‚ö†Ô∏è Error al imprimir ticket:", e);
    alert("‚ö†Ô∏è No se pudo imprimir el ticket autom√°ticamente.");
  }
}

/* ==========================================================
   üîß Funciones auxiliares para formateo de ticket
========================================================== */
function cortarTexto(texto, max) {
  if (!texto) return "";
  texto = texto.trim();
  if (texto.length <= max) return texto;
  return texto.substring(0, max - 3) + "...";
}

function centrarTexto(texto, ancho = 32) {
  const lineas = texto.split("\n");
  return lineas.map(linea => {
    const espacios = Math.max(0, Math.floor((ancho - linea.length) / 2));
    return " ".repeat(espacios) + linea;
  }).join("\n");
}
	
</script>
</body>
</html>
