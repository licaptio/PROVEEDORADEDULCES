<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ingresos por Serie â€“ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    padding:20px;
  }
  h2{ margin-bottom:10px; }

  #estado{
    margin-bottom:10px;
    font-weight:bold;
  }

  table{
    border-collapse: collapse;
    width:100%;
    background:#fff;
    font-size:14px;
  }
  th, td{
    border:1px solid #ccc;
    padding:6px 8px;
    text-align:right;
    white-space: nowrap;
  }
  th{
    background:#0c6cbd;
    color:#fff;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  th:first-child,
  td:first-child{
    text-align:left;
    font-weight:bold;
    position: sticky;
    left: 0;
    background:#e9eef5;
    z-index: 3;
  }
</style>
</head>

<body>

<h2>Ingresos por Serie (HistÃ³rico)</h2>

<div id="estado">Cargando datosâ€¦</div>

<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
// ===============================
// ðŸ”¹ CLIENTE SUPABASE
// ===============================
const sb = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);

// ===============================
// ðŸ”¹ HARDCODE SERIES (PROVSOFT)
// ===============================
const SERIES = {
  AM:  'ALLENDE I',
  SAN: 'ALLENDE II',
  GM:  'BODEGA 41',
  LMN: 'MATRIZ',
  LO:  'OSITO',
  LP:  'CENTRAL',
  LV:  'PROVILEON',
  MM:  'MONTEMORELOS',
  RVN: 'RIO VERDE',
  PP:  'NO DEFINIDO',
  RM1: 'RUTA MOVIL 1',
  RM2: 'RUTA MOVIL 2'
};
// ===============================
// ðŸ”¹ CARGA PAGINADA
// ===============================
async function cargarDatos(){
  const estado = document.getElementById('estado');
  let todos = [];
  let desde = 0;
  const paso = 1000;

  while (true) {
    estado.innerText = `Cargando filas ${desde + 1} a ${desde + paso}â€¦`;

    const { data, error } = await sb
.from('ingresos_pdd')
.select('id, serie, fecha, total')
.eq('cancelado', false)
.order('id', { ascending: true })
.range(desde, desde + paso - 1);

    if (error) {
      console.error(error);
      estado.innerText = 'âŒ Error cargando datos';
      return;
    }

    if (!data || data.length === 0) break;

    todos = todos.concat(data);
    desde += paso;
  }

  estado.innerText = `Procesando ${todos.length.toLocaleString()} registrosâ€¦`;
  construirTabla(todos);
  estado.innerText = `Listo (${todos.length.toLocaleString()} registros)`;
}

// ===============================
// ðŸ”¹ CONSTRUCCIÃ“N TABLA + TOTAL
// ===============================
function construirTabla(rows){
  const mapa = {};
  const periodos = new Set();

  rows.forEach(r=>{
    if(!r.fecha) return;
    if(r.total == null) return;

    const codigoSerie = r.serie || 'PP';
const serie = SERIES[codigoSerie] 
  ? `${codigoSerie} - ${SERIES[codigoSerie]}`
  : `${codigoSerie} - (NO DEFINIDA)`;

    const periodo = String(r.fecha).slice(0,7);

    periodos.add(periodo);

    if(!mapa[serie]) mapa[serie] = {};
    if(!mapa[serie][periodo]) mapa[serie][periodo] = 0;

    mapa[serie][periodo] += Number(r.total);
  });

  const periodosOrdenados = Array.from(periodos).sort();
  const series = Object.keys(mapa).sort();

  const thead = document.querySelector('#tabla thead');
  const tbody = document.querySelector('#tabla tbody');

  thead.innerHTML =
    `<tr><th>serie</th>` +
    periodosOrdenados.map(p=>`<th>${p}</th>`).join('') +
    `</tr>`;

  tbody.innerHTML = '';

  const totalesPorPeriodo = {};

  // ðŸ”¹ Filas por serie
  series.forEach(serie=>{
    let fila = `<tr><td>${serie}</td>`;
    periodosOrdenados.forEach(p=>{
      const val = mapa[serie][p] || 0;

      if(!totalesPorPeriodo[p]) totalesPorPeriodo[p] = 0;
      totalesPorPeriodo[p] += val;

      fila += `<td>${val ? formato(val) : ''}</td>`;
    });
    fila += `</tr>`;
    tbody.insertAdjacentHTML('beforeend', fila);
  });

  // ðŸ”¹ FILA TOTAL INGRESOS
  let filaTotal = `<tr style="font-weight:bold;background:#dfe9f7;">
    <td>TOTAL INGRESOS</td>`;

  periodosOrdenados.forEach(p=>{
    filaTotal += `<td>${formato(totalesPorPeriodo[p] || 0)}</td>`;
  });

  filaTotal += `</tr>`;
  tbody.insertAdjacentHTML('beforeend', filaTotal);
}

// ===============================
// ðŸ”¹ FORMATO MONEDA
// ===============================
function formato(n){
  return n.toLocaleString('es-MX',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}

// ===============================
cargarDatos();
// ===============================
</script>

</body>
</html>
