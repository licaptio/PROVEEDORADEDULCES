<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ingresos por Serie â€“ PROVSOFT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    padding:20px;
  }
  h2{ margin-bottom:10px; }

  table{
    border-collapse: collapse;
    width:100%;
    background:#fff;
    font-size:14px;
  }
  th, td{
    border:1px solid #ccc;
    padding:6px 8px;
    text-align:right;
    white-space: nowrap;
  }
  th{
    background:#0c6cbd;
    color:#fff;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  th:first-child,
  td:first-child{
    text-align:left;
    font-weight:bold;
    position: sticky;
    left: 0;
    background:#e9eef5;
    z-index: 3;
  }
</style>
</head>

<body>

<h2>Ingresos por Serie (HistÃ³rico)</h2>

<table id="tabla">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const supabase = supabase.createClient(
    const db = createClient(
      'https://cvpbtjlupswbyxenugpz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);
// ðŸ”¹ 1. Cargar datos base
async function cargarDatos(){
  const { data, error } = await supabase
    .from('ingresos_pdd')
    .select('serie, fecha, total');

  if(error){
    console.error(error);
    alert('Error cargando datos');
    return;
  }

  construirTabla(data);
}

// ðŸ”¹ 2. Construir tabla tipo Excel
function construirTabla(rows){
  const mapa = {};        // { serie: { periodo: total } }
  const periodos = new Set();

  rows.forEach(r=>{
    if(!r.fecha || !r.total) return;

    const periodo = r.fecha.slice(0,7); // YYYY-MM
    periodos.add(periodo);

    if(!mapa[r.serie]) mapa[r.serie] = {};
    if(!mapa[r.serie][periodo]) mapa[r.serie][periodo] = 0;

    mapa[r.serie][periodo] += Number(r.total);
  });

  const periodosOrdenados = Array.from(periodos).sort();
  const series = Object.keys(mapa).sort();

  // ðŸ”¹ Header
  const thead = document.querySelector('#tabla thead');
  thead.innerHTML = '';
  const trh = document.createElement('tr');
  trh.innerHTML = `<th>serie</th>` +
    periodosOrdenados.map(p=>`<th>${p}</th>`).join('');
  thead.appendChild(trh);

  // ðŸ”¹ Body
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = '';

  series.forEach(serie=>{
    const tr = document.createElement('tr');
    let html = `<td>${serie}</td>`;

    periodosOrdenados.forEach(p=>{
      const val = mapa[serie][p];
      html += `<td>${val ? formato(val) : ''}</td>`;
    });

    tr.innerHTML = html;
    tbody.appendChild(tr);
  });
}

// ðŸ”¹ Formato moneda
function formato(n){
  return n.toLocaleString('es-MX',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}

cargarDatos();
</script>

</body>
</html>
