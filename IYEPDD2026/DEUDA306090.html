<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resumen Deudas No Pagadas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 0.9em;
    }
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
    }
    .vencida-30 { background: #fff8e1; }
    .vencida-60 { background: #ffe082; }
    .vencida-90 { background: #ffca28; }
    .vencida-mas { background: #ff7043; color: white; }
    .proveedor-destacado { font-weight: bold; color: #2c3e50; }
    button {
      margin: 1rem 0;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #218838; }
    td.numero { text-align: right; }
.proveedor-especial {
  background-color: #d0ecff !important; /* azul claro */
  animation: parpadeo 1.6s infinite;
}
@keyframes parpadeo {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.proveedor-especial-vencido {
  background-color: #ede7f6 !important; /* Morado claro */
  animation: parpadeo-morado 1.6s infinite;
}

@keyframes parpadeo-morado {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.proveedor-contado {
  background-color: #d0f0ff !important; /* celeste claro */
  animation: parpadeo-celeste 1.5s infinite;
  color: #003344;
  font-weight: bold;
}

@keyframes parpadeo-celeste {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
.dias-30-morado {
  background-color: #ede7f6 !important; /* Morado claro */
  animation: parpadeo-morado 1.6s infinite;
  font-weight: bold;
  color: #4a148c;
}
.desintegrando {
  opacity: 0;
  transition: opacity 1.2s ease;
}
.btn-pagar {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  background-color: #28a745; /* verde */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s;
}

.btn-pagar:hover {
  transform: scale(1.15);
  box-shadow: 0 0 0 4px rgba(40,167,69,0.25);
}

.btn-pagar:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
</style>
</head>
<body>
  <h2>ðŸ“Œ Facturas Pendientes</h2>
  <div id="tabla"></div>

  <script>
const _supabase = window.supabase.createClient(
  'https://cvpbtjlupswbyxenugpz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
);
const proveedoresEspeciales = {
  "ROBERTO CANTU OZUNA": 12,
  "DECASA DEL CENTRO": 20,
  "DULCES LAS DELICIAS": 28,
  "GUSTAVO MARTINEZ PLATAS": 10,
  "EDDY HERNANDEZ VILLARREAL": 7,
  "DISTRIBUIDORA DE DULCES DEL NORTE": 27,
  "INOCENCIO DELGADO MARQUEZ": 15,
  "DUL-TAM PAVITO": 7,
  "LOCALIZACION ESPECIALIZADA GPS": 2,
  "LUIS FERNANDO KARR GARCIA": 2, 
  "DISTRIBUIDORA DE PRODUCTOS DESHIDRATADOS": 28,
  "DETALLE Y DISTRIBUCIONES": 20,
  "PRODUCTOS VIGAR": 15,
  "DISTRIBUIDORA DE LA ROSA": 15,
  "COMERCIALIZADORA INDUSTRIAL IDALI": 15,
  "MAXILUM": 15,
  "DESFICO": 7,
  "GRUPO CHI-SO": 15,
  "ABARROTES": 25
};
const proveedoresContado = [
  "BBVA MEXICO, S.A., INSTITUCION DE BANCA MULTIPLE, GRUPO FINANCIERO BBVA MEXICO",
  "BANCO SANTANDER MEXICO S.A., INSTITUCION DE BANCA MULTIPLE, GRUPO FINANCIERO SANTANDER MEXICO",
  "MARIA IMELDA CHAPA PARAS",
  "JOSE ANTONIO PEÃ‘A MARTINEZ",
  "COMERCIALIZADORA PEPSICO MEXICO",
  "DISTRIBUIDORA ARCA CONTINENTAL",
  "WINETPC",
  "GASNGO MEXICO",
  "RADIOMOVIL DIPSA",	
  "SERVICIOS GASOLINEROS DE MEXICO",	
  "PEÃ‘AFIEL BEBIDAS",
  "DELIA EUSTOLIA TORRES GARCIA",
  "BONAFONT",
  "BOTANAS Y DERIVADOS",
  "ANDRES EULALIO RAMIREZ CRUZ",
  "TELEFONOS DE MEXICO",
  "LA CACHOTA",
  "DOLORES BRISEÃ‘O MANCHA",
  "COMISION FEDERAL DE ELECTRICIDAD"
];

    async function cargar() {
const { data, error } = await _supabase
  .from("v_deuda_proveedores")
  .select("*")
  .neq("factura_pagada", "SI");
      if (error) return alert("Error cargando datos");

      //-------------------------------------------------------
// 1) PÃ‰GAS AQUÃ TU ARREGLO VIEJO (DE PRECIOS, FACTURAS, ETC.)
//-------------------------------------------------------
const datosViejos = [
  // Ejemplo:
  // {fecha:"2024-06-10", total:"1200", razon_social_emisor:"ALGO", uuid_cfdi:"---", ...}
  // PÃ‰GAME AQUÃ TODO TU ARREGLO VIEJO
];


//-------------------------------------------------------
// 2) NORMALIZADOR UNIVERSAL PARA UNIR VIEJO + NUEVO
//-------------------------------------------------------
function normalizarFactura(f) {
  return {
    uuid_cfdi: (f.uuid_cfdi || f.uuid || "").trim(),
    fecha: f.fecha ? new Date(f.fecha) : null,
    rfc_emisor: f.rfc_emisor || "",
    razon_social_emisor: f.razon_social_emisor || "",
    factura: f.factura || "",
    serie: f.serie || "",
    total: parseFloat(f.total || 0),
    factura_pagada: (f.factura_pagada || "").toUpperCase().trim(),
    factura_fisicamente: (f.factura_fisicamente || "").toUpperCase().trim(),
    fotos: Array.isArray(f.fotos) ? f.fotos : [],
    // mantener el resto sin afectar
    ...f
  };
}


//-------------------------------------------------------
// 3) FILTRO DE NO PAGADAS DEL SUPABASE (NUEVO)
//-------------------------------------------------------
const noPagadasSupabase = data.filter(f =>
  (f.factura_pagada || "NO").toUpperCase().trim() !== "SI"
);


//-------------------------------------------------------
// 4) UNIR AMBAS FUENTES (VIEJO + NUEVO) NORMALIZADAS
//-------------------------------------------------------
const unidas = [
  ...datosViejos.map(normalizarFactura),
  ...noPagadasSupabase.map(normalizarFactura)
];


//-------------------------------------------------------
// 5) QUITAR DUPLICADOS POR uuid_cfdi
//-------------------------------------------------------
const unicas = Object.values(
  unidas.reduce((acc, f) => {
    const key = f.uuid_cfdi || crypto.randomUUID();
    if (!acc[key]) acc[key] = f;
    return acc;
  }, {})
);


//-------------------------------------------------------
// 6) ORDENAR POR RFC â†’ FECHA
//-------------------------------------------------------
const ordenadosFinal = unicas.sort((a, b) => {
  const rfcA = (a.rfc_emisor || "").toLowerCase();
  const rfcB = (b.rfc_emisor || "").toLowerCase();
  if (rfcA !== rfcB) return rfcA.localeCompare(rfcB);
  return new Date(a.fecha) - new Date(b.fecha);
});


//-------------------------------------------------------
// 7) YA PUEDES USAR ESTE: ordenadosFinal
//-------------------------------------------------------
mostrarTabla(ordenadosFinal);

// SUMA GLOBAL FINAL
const sumaGlobal = ordenadosFinal.reduce((acc, f) => acc + (parseFloat(f.total) || 0), 0);

// Insertar el total arriba
document.getElementById("tabla").insertAdjacentHTML("beforebegin", `
  <div style="
    background:#fff;
    padding:15px;
    margin-bottom:12px;
    border-radius:8px;
    box-shadow:0 2px 4px rgba(0,0,0,0.15);
  ">
    <strong style="font-size:1.1em;">ðŸ’° TOTAL GLOBAL PENDIENTE:</strong><br>
    <span style="font-size:1.6em; font-weight:bold; color:#0a6c21;">
      $${sumaGlobal.toLocaleString("es-MX",{ minimumFractionDigits:2 })}
    </span>
  </div>
`);

mostrarTabla(ordenadosFinal);

}

function mostrarTabla(data) {

let html = `<table><thead><tr>
  <th>Fecha</th>
  <th>DÃ­as</th>
  <th>UUID</th>
  <th>RFC</th>
  <th>Proveedor</th>
  <th>Serie/Folio</th>
  <th>Total</th>
  <th>FÃ­sica</th>
  <th>Fotos</th>
  <th>AcciÃ³n</th>
</tr></thead><tbody>`;

  for (const f of data) {

    const dias = calcularDias(f.fecha);

 // === PROVEEDOR REAL (v2) ===
let proveedor =
  (f.proveedor && f.proveedor.trim() !== "")
    ? f.proveedor
    : (f.razon_social_emisor && f.razon_social_emisor.trim() !== "")
      ? f.razon_social_emisor
      : f.rfc_emisor;


    // === FOLIO REAL ===
    const folioFinal = f.serie_folio || "â€”";

const clase30 = dias >= 30 ? "dias-30-morado" : "";

html += `
  <tr class="${clase30}">
    <td>${f.fecha}</td>
    <td>${dias}</td>
    <td><a href="detalle.html?uuid=${f.uuid_cfdi}" target="_blank">${f.uuid_cfdi}</a></td>
    <td>${f.rfc_emisor}</td>
    <td class="proveedor-destacado">${proveedor}</td>
    <td>${folioFinal}</td>
    <td class="numero">${Number(f.total || 0).toLocaleString("es-MX", { minimumFractionDigits: 2 })}</td>
    <td style="text-align:center">${(f.factura_fisicamente || "") === "SI" ? "âœ…" : ""}</td>
    <td style="text-align:center">
      ${
        (f.fotos && f.fotos.length > 0)
        ? f.fotos.map(url => `<a href="${url}" target="_blank">ðŸ“·</a>`).join("")
        : ""
      }
    </td>
  </tr>
  <td style="text-align:center">
  <button
    class="btn-pagar"
    title="Marcar como pagada"
    onclick="marcarPagada('${f.uuid_cfdi}', this)">
  </button>
</td>
`;

  }

  html += "</tbody></table>";
  document.getElementById("tabla").innerHTML = html;
}

function calcularDias(fechaStr) {
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0); // normalizar a medianoche local

  if (!fechaStr) return 0;

  // Si Supabase manda "2024-12-08" o "2024-12-08T00:00:00+00:00"
  const fechaLimpia = fechaStr.split("T")[0]; // nos quedamos solo con YYYY-MM-DD
  const [y, m, d] = fechaLimpia.split("-").map(Number);

  // Crear fecha EN HORA LOCAL (Linares, UTC-6)
  const f = new Date(y, m - 1, d);
  f.setHours(0, 0, 0, 0);

  const diff = hoy - f;
  return Math.floor(diff / 86400000);
}

    function obtenerClaseVencimiento(d) {
      if (d > 90) return "vencida-mas";
      if (d > 60) return "vencida-90";
      if (d > 30) return "vencida-60";
      return "vencida-30";
    }

async function marcarPagada(uuid_cfdi, boton) {
  const fila = boton.closest("tr");

  boton.disabled = true;
  boton.style.backgroundColor = "#6c757d"; // gris mientras procesa

  const { error } = await _supabase
    .from("deuda_limpia_pdd")
    .update({ factura_pagada: "SI" })
    .eq("uuid_cfdi", uuid_cfdi);

  if (error) {
    alert("âŒ Error al marcar como pagada");
    console.error(error);
    boton.disabled = false;
    boton.style.backgroundColor = "#28a745";
    return;
  }

  // feedback suave
  fila.style.background = "#e8f5e9";

  // efecto Thanos (5s)
  setTimeout(() => {
    fila.classList.add("desintegrando");
    setTimeout(() => fila.remove(), 1200);
  }, 5000);
}
async function marcarPagada(uuid_cfdi, boton) {
  const fila = boton.closest("tr");

  // Desactivar botÃ³n para que no lo piquen dos veces
  boton.disabled = true;
  boton.textContent = "âŒ› Procesando";

  // 1ï¸âƒ£ Guardar INMEDIATO en BD
  const { error } = await _supabase
    .from("deuda_limpia_pdd")
    .update({ factura_pagada: "SI" })
    .eq("uuid_cfdi", uuid_cfdi);

  if (error) {
    alert("âŒ Error al marcar como pagada");
    console.error(error);
    boton.disabled = false;
    boton.textContent = "ðŸ’° Pagada";
    return;
  }

  // 2ï¸âƒ£ Feedback visual inmediato
  fila.style.background = "#e8f5e9"; // verde suave
  boton.textContent = "âœ” Pagada";

  // 3ï¸âƒ£ Delay tipo Thanos (5 segundos)
  setTimeout(() => {
    fila.classList.add("desintegrando");
    setTimeout(() => fila.remove(), 1200);
  }, 5000);
}

document.addEventListener("DOMContentLoaded", cargar);
      
</script>
</body>
</html>
