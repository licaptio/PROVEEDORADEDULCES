<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EscÃ¡ner QR â€“ PROVSOFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:#f7f9fc;
      color:#222;
    }

    h2{ margin-bottom:10px }

    input{
      width:320px;
      padding:14px;
      font-size:18px;
      border-radius:10px;
      border:2px solid #0c6cbd;
      outline:none;
      text-align:center;
    }

    #btnSalir{
      margin-top:20px;
      background:#b00020;
      color:#fff;
      padding:12px 20px;
      border-radius:10px;
      border:none;
      font-size:1rem;
      cursor:pointer;
    }

    #toastOk{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#28a745;
      color:#fff;
      padding:14px 26px;
      border-radius:12px;
      font-size:1.1rem;
      opacity:0;
      transition:.35s;
      z-index:9999;
    }
    #toastOk.show{ opacity:1 }
  </style>
</head>

<body>

<h2>ðŸ“¦ Escaneo con lector QR</h2>
<p>Escanea la factura con el lector EYOYO</p>

<input id="scanInput" placeholder="Escaneando..." autofocus />

<button id="btnSalir" onclick="location.href='index.html'">â›” Finalizar</button>

<div id="toastOk"></div>

<script>
  const input = document.getElementById("scanInput");
  const toast = document.getElementById("toastOk");
  let bloqueado = false;
  let scanTimer = null;
  const SCAN_DELAY = 300;

  // ðŸ”Š Beep
  function beep(){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    osc.frequency.value = 850;
    osc.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.12);
  }

  // ðŸ” Extraer UUID SAT
  function extraeUUID(raw){
    try{
      const url = new URL(raw);
      const uuid = url.searchParams.get("ID") || url.searchParams.get("id");
      if(uuid && /^[A-F0-9\-]{36}$/i.test(uuid)) return uuid.toUpperCase();
    }catch{
      const m = raw.match(/[A-F0-9\-]{36}/i);
      if(m) return m[0].toUpperCase();
    }
    return null;
  }

  function showToast(txt){
    toast.textContent = txt;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"),2000);
  }

  function liberar(){
    setTimeout(()=>{
      bloqueado = false;
      input.value = "";
      input.focus();
    },1200);
  }

  // ðŸ“¥ Detectar fin de escaneo (sin ENTER)
  input.addEventListener("input", ()=>{
    if(bloqueado) return;

    clearTimeout(scanTimer);

    scanTimer = setTimeout(async ()=>{
      const raw = input.value.trim();
      input.value = "";

      if(!raw) return;

      const uuid = extraeUUID(raw);
      bloqueado = true;
      beep();

      if(!uuid){
        showToast("Factura no encontrada");
        liberar();
        return;
      }

      const { data, error } = await supabase
        .from("deuda_limpia_pdd")
        .select("uuid_cfdi")
        .eq("uuid_cfdi", uuid)
        .maybeSingle();

      if(error || !data){
        showToast("Factura no encontrada");
        liberar();
        return;
      }

      const { error:updErr } = await supabase
        .from("deuda_limpia_pdd")
        .update({ factura_fisicamente: "SI" })
        .eq("uuid_cfdi", uuid);

      if(!updErr){
        showToast("Factura Encontrada Marcada FÃ­sicamente");
      }else{
        showToast("Error al marcar factura");
      }

      liberar();
    }, SCAN_DELAY);
  });

  // ðŸ”’ Mantener foco siempre
  setInterval(()=>input.focus(),500);
</script>

</body>
</html>
