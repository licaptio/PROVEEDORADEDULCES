<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EscÃ¡ner QR â€“ PROVSOFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      background:#f7f9fc;
      color:#222;
    }
    h2{ margin-bottom:10px }
    input{
      width:320px;
      padding:14px;
      font-size:18px;
      border-radius:10px;
      border:2px solid #0c6cbd;
      outline:none;
      text-align:center;
    }
    #btnSalir{
      margin-top:20px;
      background:#b00020;
      color:#fff;
      padding:12px 20px;
      border-radius:10px;
      border:none;
      font-size:1rem;
      cursor:pointer;
    }
    #toastOk{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#333;
      color:#fff;
      padding:14px 26px;
      border-radius:12px;
      font-size:1.05rem;
      opacity:0;
      transition:.35s;
      z-index:9999;
      max-width: 92vw;
      text-align:center;
      word-break:break-word;
    }
    #toastOk.show{ opacity:1 }
  </style>
</head>

<body>

<h2>ðŸ“¦ Escaneo con lector QR</h2>
<p>Escanea la factura con el lector EYOYO</p>

<input id="scanInput" placeholder="Escaneando..." autofocus />

<button id="btnSalir" onclick="location.href='index.html'">â›” Finalizar</button>

<div id="toastOk"></div>

<script>
  const input = document.getElementById("scanInput");
  const toast = document.getElementById("toastOk");

  let bloqueado = false;
  let scanTimer = null;
  const SCAN_DELAY = 300;

  // âœ… Capturar errores y mostrarlos (para que no â€œparezcaâ€ que no hace nada)
  window.addEventListener("error", (e) => {
    showToast("JS ERROR: " + (e.message || "desconocido"), "err");
  });
  window.addEventListener("unhandledrejection", (e) => {
    const msg = e.reason?.message || String(e.reason || "desconocido");
    showToast("PROM ERROR: " + msg, "err");
  });

  // âœ… Cliente supabase real (desde supabase.js)
  const db = window.db;
  if (!db || typeof db.from !== "function") {
    // si esto sale, tu supabase.js no estÃ¡ bien o no cargÃ³
    showToast("Falta inicializar Supabase (window.db). Revisa supabase.js", "err");
  }

  // ðŸ”Š Audio context (en mÃ³vil necesita interacciÃ³n)
  let audioCtx = null;
  function initAudio(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();
    }catch{}
  }
  document.addEventListener("click", initAudio, { once:true });

  function beep(){
    initAudio();
    try{
      const osc = audioCtx.createOscillator();
      osc.frequency.value = 850;
      osc.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.12);
    }catch{}
    // ðŸ“³ vibraciÃ³n en mÃ³vil (si existe)
    try{ navigator.vibrate?.(60); }catch{}
  }

  function showToast(txt, tipo="ok"){
    toast.textContent = txt;
    toast.style.background = (tipo === "ok") ? "#28a745" : "#b00020";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 2200);
  }

  // ðŸ” Extraer UUID SAT (ID=...)
  function extraeUUID(raw){
    try{
      const url = new URL(raw);
      const uuid = url.searchParams.get("ID") || url.searchParams.get("id");
      if(uuid && /^[A-F0-9\-]{36}$/i.test(uuid)) return uuid.toUpperCase();
    }catch{
      const m = raw.match(/[A-F0-9\-]{36}/i);
      if(m) return m[0].toUpperCase();
    }
    return null;
  }

  function liberar(){
    setTimeout(()=>{
      bloqueado = false;
      input.value = "";
      input.focus();
    }, 900);
  }

  // ðŸ“¥ Detectar fin de escaneo (sin ENTER)
  input.addEventListener("input", ()=>{
    if(bloqueado) return;

    clearTimeout(scanTimer);
    scanTimer = setTimeout(async ()=>{
      try{
        const raw = input.value.trim();
        input.value = "";
        if(!raw) return;

        const uuid = extraeUUID(raw);
        bloqueado = true;
        beep();

        if(!uuid){
          showToast("Factura no encontrada", "err");
          liberar();
          return;
        }

        // ðŸ”¥ Si no hay db, aquÃ­ se notifica
        if(!db){
          showToast("Supabase no inicializado (window.db)", "err");
          liberar();
          return;
        }

        // ðŸ” Buscar
        const { data, error } = await db
          .from("deuda_limpia_pdd")
          .select("uuid_cfdi")
          .eq("uuid_cfdi", uuid)
          .maybeSingle();

        if(error || !data){
          showToast("Factura no encontrada", "err");
          liberar();
          return;
        }

        // âœ… Marcar
        const { error: updErr } = await db
          .from("deuda_limpia_pdd")
          .update({ factura_fisicamente: "SI" })
          .eq("uuid_cfdi", uuid);

        if(!updErr){
          showToast("Factura Encontrada Marcada FÃ­sicamente", "ok");
        }else{
          showToast("Error al marcar factura", "err");
        }

        liberar();
      }catch(ex){
        showToast("ERROR: " + (ex?.message || ex), "err");
        liberar();
      }
    }, SCAN_DELAY);
  });

  // ðŸ”’ Mantener foco siempre
  setInterval(()=>input.focus(), 500);
</script>

</body>
</html>
